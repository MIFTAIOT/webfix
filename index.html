<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>e-Learning English by Mam Yanti</title>
    
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <style>
        /* (CSS LENGKAP - Ada tambahan untuk UI Chat) */
        :root {
            --primary-color: #4A90E2; --secondary-color: #50E3C2; --text-color: #4A4A4A;
            --danger-color: #E24A4A; --bg-color: #F7F9FC; --card-bg: #FFFFFF; --border-color: #EAEAEA;
            --warning-bg: #FFFBEB; --warning-border: #FDE68A; --chat-bg: #E5EFFB; --chat-other: #f1f0f0;
        }
        * { box-sizing: border-box; margin: 0; padding: 0; }
        body {
            font-family: 'Poppins', sans-serif; background-color: var(--bg-color); color: var(--text-color);
            display: flex; justify-content: center; align-items: center; min-height: 100vh;
            -webkit-tap-highlight-color: transparent;
        }
        #app-container {
            width: 100%; max-width: 480px; height: 100vh; background-color: var(--card-bg);
            display: flex; flex-direction: column; overflow: hidden;
            @media (min-width: 481px) {
                max-height: 90vh; min-height: 700px; border-radius: 20px; box-shadow: 0 10px 40px rgba(0, 0, 0, 0.1);
            }
        }
        /* Page & SubPage display */
        .page, .sub-page { display: none; flex-grow: 1; flex-direction: column; overflow: hidden; }
        .page.active, .sub-page.active { display: flex; }
        /* Konten scrollable di dalam page/subpage */
        .page-content, .sub-page-content { flex-grow: 1; overflow-y: auto; padding: 25px; }

        #login-page { /* Login page perlu style khusus */
             display: none; flex-direction: column; justify-content: center; align-items: center; text-align: center;
             background: linear-gradient(180deg, var(--primary-color) 0%, var(--secondary-color) 100%); padding: 25px;
        }
        #login-page.active { display: flex; }

        .login-card { background: var(--card-bg); padding: 40px 30px; border-radius: 20px; width: 90%; box-shadow: 0 10px 30px rgba(0,0,0,0.1); }
        .login-card h1 { color: var(--primary-color); font-weight: 700; font-size: 1.8em; }
        .login-card h2 { font-weight: 400; font-size: 1.2em; margin-bottom: 25px; }
        .login-card p { font-size: 0.9em; margin-bottom: 25px; }
        button {
            display: inline-flex; align-items: center; justify-content: center; gap: 10px; width: 100%;
            padding: 12px 20px; border-radius: 12px; font-size: 1em; font-family: 'Poppins', sans-serif;
            cursor: pointer; transition: all 0.2s ease; border: none; font-weight: 500;
        }
        button.primary { background-color: var(--primary-color); color: white; }
        button.primary:hover { background-color: #3a7bc8; }
        button.primary:disabled { background-color: #aaa; cursor: not-allowed; }
        button#login-btn { background-color: #fff; color: var(--text-color); border: 1px solid var(--border-color); }
        button#login-btn:hover { background-color: #f5f5f5; }
        button img { width: 22px; }
        input, textarea, select {
            width: 100%; padding: 12px; border-radius: 10px; border: 1px solid var(--border-color);
            margin-bottom: 15px; font-family: 'Poppins', sans-serif; font-size: 1em; background-color: #fdfdfd;
        }
        textarea { resize: vertical; min-height: 80px; }
        .header { display: flex; justify-content: space-between; align-items: center; padding: 15px 25px; border-bottom: 1px solid var(--border-color); flex-shrink: 0;}
        .header h1 { font-size: 1.2em; font-weight: 600; margin: 0 auto; /* Center title */ }
        .logout-btn, .back-btn { background: none; border: none; color: var(--primary-color); font-size: 1.5em; cursor: pointer; width: auto; padding: 5px; }
        .back-btn { position: absolute; left: 15px; } /* Posisi tombol back */
        .logout-btn { position: absolute; right: 15px; } /* Posisi tombol logout */
        
        .feature-card {
            background: var(--card-bg); border: 1px solid var(--border-color); border-radius: 15px;
            padding: 20px; margin-bottom: 20px; box-shadow: 0 2px 8px rgba(0,0,0,0.03);
        }
        .feature-card h3 {
            margin-bottom: 15px; font-size: 1.1em; font-weight: 600; border-bottom: 1px solid var(--border-color);
            padding-bottom: 10px; display: flex; align-items: center; gap: 10px;
        }
        .content-list { max-height: 250px; overflow-y: auto; }
        .content-item { padding: 15px 5px; border-bottom: 1px solid var(--border-color); }
        .content-item:last-child { border-bottom: none; }
        .content-item strong { display: block; margin-bottom: 5px; color: var(--primary-color); }
        .content-item p { font-size: 0.95em; line-height: 1.5; white-space: pre-wrap; }
        .content-item small { font-size: 0.8em; color: #9B9B9B; }
        
        .list-item-teacher { display: flex; justify-content: space-between; align-items: center; padding: 12px 5px; border-bottom: 1px solid var(--border-color); }
        .list-item-teacher:last-child { border-bottom: none; }
        .list-item-teacher span { flex-grow: 1; font-size: 0.9em; word-break: break-all; margin-right: 10px;}
        .list-item-teacher .code { font-weight: 700; color: var(--primary-color); font-size: 1.1em; }
        .delete-btn { background: var(--danger-color); color: white; border: none; border-radius: 8px; padding: 5px 10px; font-size: 0.8em; width: auto; cursor: pointer; flex-shrink: 0;}

        /* Panduan Box */
        .guide-box { background: var(--warning-bg); border: 1px solid var(--warning-border); padding: 15px; border-radius: 10px; margin-bottom: 15px; }
        .guide-box h4 { font-weight: 600; margin-bottom: 10px; }
        .guide-box p { font-size: 0.9em; line-height: 1.6; }
        .guide-box ol { padding-left: 20px; font-size: 0.9em; line-height: 1.6; }

        /* --- Chat UI --- */
        .chat-messages { display: flex; flex-direction: column; gap: 10px; padding-bottom: 10px; }
        .chat-bubble { max-width: 80%; padding: 10px 15px; border-radius: 18px; line-height: 1.5; }
        .chat-bubble .sender { font-weight: 600; font-size: 0.8em; margin-bottom: 3px; display: block; color: var(--primary-color); }
        .chat-bubble .text { font-size: 0.95em; word-wrap: break-word; }
        .chat-bubble .timestamp { font-size: 0.7em; color: #888; margin-top: 5px; display: block; text-align: right; }
        .chat-bubble.sent { background-color: var(--chat-bg); align-self: flex-end; border-bottom-right-radius: 5px; }
        .chat-bubble.received { background-color: var(--chat-other); align-self: flex-start; border-bottom-left-radius: 5px; }
        .chat-input-area { display: flex; padding: 15px 25px; border-top: 1px solid var(--border-color); background: #fff; flex-shrink: 0; }
        .chat-input-area input { flex-grow: 1; margin-bottom: 0; border-right: none; border-top-right-radius: 0; border-bottom-right-radius: 0; }
        .chat-input-area button { width: auto; border-top-left-radius: 0; border-bottom-left-radius: 0; }
        
        .error { color: var(--danger-color); text-align: center; font-size: 0.9em; }
        .spinner-container { display: flex; justify-content: center; align-items: center; padding: 20px; }
        .spinner { border: 4px solid rgba(0, 0, 0, 0.1); width: 36px; height: 36px; border-radius: 50%; border-left-color: var(--primary-color); animation: spin 1s ease infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    </style>
</head>
<body>

    <div id="app-container">

        <div id="login-page" class="page active">
             <div class="login-card">
                 <h1>e-Learning English</h1>
                 <h2>by Mam Yanti</h2>
                 <p>Silakan masuk dengan Akun Google Anda untuk memulai pembelajaran.</p>
                 <button id="login-btn">
                     <img src="https://developers.google.com/identity/images/g-logo.png" alt="Google Logo">
                     <span>Masuk dengan Google</span>
                 </button>
                 <div class="spinner-container" style="display: none;" id="login-spinner">
                     <div class="spinner"></div>
                 </div>
             </div>
        </div>

        <div id="teacher-dashboard-page" class="page">
            
            <div id="teacher-main-menu" class="sub-page active">
                 <div class="header" style="position: relative;"> <h1 id="teacher-welcome">Hai, Mam Yanti!</h1>
                     <button class="logout-btn" id="teacher-logout-btn" title="Keluar"><i class="fa-solid fa-right-from-bracket"></i></button>
                 </div>
                 <div class="page-content"> <div class="feature-card"><h3><i class="fa-solid fa-chalkboard-user"></i> Manajemen Kelas</h3> <button class="primary" data-target="teacher-class-page">Buka</button></div>
                     <div class="feature-card"><h3><i class="fa-solid fa-file-pen"></i> Manajemen Tugas</h3> <button class="primary" data-target="teacher-task-page">Buka</button></div>
                     <div class="feature-card"><h3><i class="fa-solid fa-bullhorn"></i> Pengumuman</h3> <button class="primary" data-target="teacher-announcement-page">Buka</button></div>
                     <div class="feature-card"><h3><i class="fa-solid fa-cloud-arrow-up"></i> Materi (Google Drive)</h3> <button class="primary" data-target="teacher-material-page">Buka</button></div>
                     <div class="feature-card"><h3><i class="fa-solid fa-clipboard-user"></i> Rekap Absensi</h3> <button class="primary" data-target="teacher-attendance-page">Buka</button></div>
                     <div class="feature-card"><h3><i class="fa-solid fa-comments"></i> Chat Kelas</h3> <button class="primary" data-target="teacher-chat-page">Buka</button></div>
                 </div>
            </div>

            <div id="teacher-class-page" class="sub-page">
                 <div class="header" style="position: relative;">
                     <button class="back-btn" data-target="teacher-main-menu"><i class="fa-solid fa-arrow-left"></i></button>
                     <h1>Manajemen Kelas</h1>
                 </div>
                 <div class="page-content">
                    <div class="feature-card">
                        <h3><i class="fa-solid fa-plus"></i> Buat Kelas Baru</h3>
                        <input type="text" id="class-name-input" placeholder="Nama Kelas Baru (Cth: XII-1)">
                        <button class="primary" id="create-class-btn">Buat Kelas Baru</button>
                    </div>
                    <div class="feature-card">
                        <h3><i class="fa-solid fa-list-ul"></i> Daftar Kelas & Kode</h3>
                        <div id="class-code-list" class="content-list">
                            <div class="spinner-container"><div class="spinner"></div></div>
                        </div>
                    </div>
                 </div>
            </div>
            
            <div id="teacher-task-page" class="sub-page">
                 <div class="header" style="position: relative;">
                     <button class="back-btn" data-target="teacher-main-menu"><i class="fa-solid fa-arrow-left"></i></button>
                     <h1 id="teacher-task-title">Manajemen Tugas</h1> </div>
                 <div class="page-content">
                    <div class="feature-card">
                        <h3><i class="fa-solid fa-plus"></i> Buat Slot Tugas Baru</h3>
                        <input type="text" id="task-title" placeholder="Judul Tugas">
                        <textarea id="task-desc" placeholder="Deskripsi/Instruksi Tugas..."></textarea>
                        <label style="font-size: 0.9em; margin-bottom: 5px; display: block;">Tenggat Waktu:</label>
                        <input type="date" id="task-deadline">
                        <select id="task-class-target">
                            <option value="">-- Pilih Kelas Tujuan --</option>
                        </select>
                        <button class="primary" id="create-task-btn">Publikasikan Tugas</button>
                    </div>
                    
                    <div class="feature-card">
                         <h3><i class="fa-solid fa-list-ul"></i> Daftar Tugas Aktif</h3>
                         <div id="teacher-assignment-list" class="content-list">
                            <div class="spinner-container"><div class="spinner"></div></div>
                         </div>
                    </div>
                    
                    <div id="teacher-view-submissions-div" class="feature-card" style="display:none;">
                         <h3 id="submission-list-title">...</h3>
                         <div id="submission-list-container" class="content-list"></div>
                    </div>
                 </div>
            </div>

             <div id="teacher-announcement-page" class="sub-page">
                  <div class="header" style="position: relative;">
                      <button class="back-btn" data-target="teacher-main-menu"><i class="fa-solid fa-arrow-left"></i></button>
                      <h1>Pengumuman</h1>
                  </div>
                  <div class="page-content">
                    <div class="feature-card">
                        <h3><i class="fa-solid fa-plus"></i> Buat Pengumuman Baru</h3>
                        <input type="text" id="announcement-title" placeholder="Judul Pengumuman">
                        <textarea id="announcement-content" rows="3" placeholder="Isi pengumuman..."></textarea>
                        <select id="announcement-class-target">
                            <option value="">-- Pilih Kelas Tujuan --</option>
                        </select>
                        <button class="primary" id="publish-announcement-btn">Publikasikan</button>
                    </div>
                    <div class="feature-card">
                        <h3><i class="fa-solid fa-list-ul"></i> Riwayat Pengumuman</h3>
                        <div id="teacher-announcement-list" class="content-list"></div>
                    </div>
                  </div>
             </div>

             <div id="teacher-material-page" class="sub-page">
                   <div class="header" style="position: relative;">
                       <button class="back-btn" data-target="teacher-main-menu"><i class="fa-solid fa-arrow-left"></i></button>
                       <h1>Materi Belajar</h1>
                   </div>
                   <div class="page-content">
                     <div class="feature-card">
                         <h3><i class="fa-solid fa-cloud-arrow-up"></i> Upload Materi (dari Google Drive)</h3>
                         <select id="material-class-target">
                             <option value="">-- Pilih Kelas Tujuan --</option>
                         </select>
                         <button id="upload-material-btn" style="margin-top: 10px;"><i class="fa-brands fa-google-drive"></i> Pilih File dari Google Drive</button>
                         <p id="upload-status" style="text-align: center; margin-top: 10px; font-size: 0.9em;"></p>
                     </div>
                     <div class="feature-card">
                         <h3><i class="fa-solid fa-list-ul"></i> Daftar Materi Terupload</h3>
                         <div id="teacher-material-list" class="content-list"></div>
                     </div>
                   </div>
             </div>
             
             <div id="teacher-attendance-page" class="sub-page">
                   <div class="header" style="position: relative;">
                       <button class="back-btn" data-target="teacher-main-menu"><i class="fa-solid fa-arrow-left"></i></button>
                       <h1>Rekap Absensi</h1>
                   </div>
                   <div class="page-content">
                     <div class="feature-card">
                         <h3><i class="fa-solid fa-filter"></i> Pilih Kelas & Tanggal</h3>
                         <input type="date" id="attendance-recap-date">
                         <select id="attendance-recap-class">
                             <option value="">-- Pilih Kelas --</option>
                         </select>
                         <button class="primary" id="view-attendance-btn">Tampilkan Rekap</button>
                         <div id="attendance-recap-list" class="content-list" style="margin-top: 15px;"></div>
                     </div>
                   </div>
             </div>

             <div id="teacher-chat-page" class="sub-page">
                   <div class="header" style="position: relative;">
                       <button class="back-btn" data-target="teacher-main-menu"><i class="fa-solid fa-arrow-left"></i></button>
                       <h1>Chat Kelas</h1>
                   </div>
                   <div class="page-content" id="teacher-chat-messages-container" style="padding: 15px 15px 0 15px;"> 
                       <select id="teacher-chat-class-select" style="margin-bottom: 15px;">
                           <option value="">-- Pilih Kelas untuk Chat --</option>
                           </select>
                       <div id="teacher-chat-messages" class="chat-messages" style="flex-grow: 1; overflow-y: auto;">
                           <p style="text-align: center; color: #888;">Pilih kelas untuk memulai chat.</p>
                       </div>
                   </div>
                   <div class="chat-input-area">
                       <input type="text" id="teacher-chat-input" placeholder="Ketik pesan..." disabled>
                       <button class="primary" id="teacher-send-chat-btn" disabled><i class="fa-solid fa-paper-plane"></i></button>
                   </div>
             </div>
        </div>

        <div id="student-dashboard-page" class="page">
            
            <div id="student-main-menu" class="sub-page active">
                 <div class="header" style="position: relative;">
                     <h1 id="student-welcome">Selamat Datang!</h1>
                     <button class="logout-btn" id="student-logout-btn" title="Keluar"><i class="fa-solid fa-right-from-bracket"></i></button>
                 </div>
                 <div class="page-content">
                     <div id="student-join-class" style="display:none;" class="feature-card">
                         <h3><i class="fa-solid fa-door-open"></i> Gabung Kelas</h3>
                         <p>Anda belum terdaftar di kelas manapun. Silakan masukkan "Kode Kelas" yang diberikan oleh Mam Yanti.</p>
                         <input type="text" id="class-code-input" placeholder="Masukkan Kode Kelas (Cth: ABCDE1)">
                         <button class="primary" id="join-class-btn">Gabung Kelas</button>
                     </div>
                     <div id="student-main-content" style="display:none;">
                         <div class="feature-card"><h3><i class="fa-solid fa-user-check"></i> Absensi Hari Ini</h3><p id="attendance-status" style="text-align: center; margin-bottom: 15px;">Memeriksa status...</p><input type="number" id="attendance-input" placeholder="Masukkan Nomor Absen Anda" style="margin-bottom: 10px;"><button class="primary" id="submit-attendance-btn" disabled>Kirim Absensi</button></div>
                         <div class="feature-card"><h3><i class="fa-solid fa-bullhorn"></i> Pengumuman</h3><div id="announcement-list" class="content-list"><div class="spinner-container"><div class="spinner"></div></div></div></div>
                         <div class="feature-card"><h3><i class="fa-solid fa-book-open"></i> Materi Belajar</h3><div id="material-list" class="content-list"><div class="spinner-container"><div class="spinner"></div></div></div></div>
                         <div class="feature-card"><h3><i class="fa-solid fa-file-pen"></i> Daftar Tugas</h3><div id="assignment-list-student" class="content-list"><div class="spinner-container"><div class="spinner"></div></div></div></div>
                         <div class="feature-card"><h3><i class="fa-solid fa-comments"></i> Chat Kelas</h3> <button class="primary" data-target="student-chat-page">Buka Chat</button></div>
                     </div>
                 </div>
            </div>

            <div id="student-task-page" class="sub-page">
                  <div class="header" style="position: relative;">
                      <button class="back-btn" data-target="student-main-menu"><i class="fa-solid fa-arrow-left"></i></button>
                      <h1 id="task-detail-title">Kirim Tugas</h1>
                  </div>
                  <div class="page-content">
                     <div class="feature-card">
                         <h3 id="task-detail-desc-title">Deskripsi Tugas:</h3>
                         <p id="task-detail-desc" style="font-size: 0.95em; line-height: 1.6; white-space: pre-wrap; margin-bottom: 15px;"></p>
                         <small id="task-detail-deadline" style="font-weight: 600; color: var(--danger-color);"></small>
                     </div>
                     <div class="feature-card">
                         <h3><i class="fa-solid fa-link"></i> Kirim Link Google Drive</h3>
                         <div class="guide-box"><h4>Cara Mengumpulkan Tugas:</h4><ol><li>Kerjakan tugas di Google Docs/Slides.</li><li>Klik **"Share"** (Bagikan).</li><li>Ganti "Restricted" menjadi **"Anyone with the link"**.</li><li>Pastikan role **"Viewer"** atau **"Commenter"**.</li><li>Klik **"Copy link"**.</li><li>Tempel link di bawah ini.</li></ol></div>
                         <input type="url" id="task-link-input" placeholder="Tempel link Google Drive Anda di sini...">
                         <button class="primary" id="submit-task-btn">Kirim Tugas</button>
                         <p id="task-submission-status" style="text-align: center; margin-top: 10px; font-weight: 600;"></p>
                     </div>
                  </div>
            </div>

            <div id="student-chat-page" class="sub-page">
                  <div class="header" style="position: relative;">
                      <button class="back-btn" data-target="student-main-menu"><i class="fa-solid fa-arrow-left"></i></button>
                      <h1>Chat Kelas</h1>
                  </div>
                  <div class="page-content" id="student-chat-messages-container" style="padding: 15px; overflow-y: auto;"> 
                      <div id="student-chat-messages" class="chat-messages">
                         <div class="spinner-container"><div class="spinner"></div></div>
                      </div>
                  </div>
                  <div class="chat-input-area">
                      <input type="text" id="student-chat-input" placeholder="Ketik pesan...">
                      <button class="primary" id="student-send-chat-btn"><i class="fa-solid fa-paper-plane"></i></button>
                  </div>
            </div>

        </div>

    </div> <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-firestore.js"></script>
    <script src="https://apis.google.com/js/api.js"></script>
    <script src="https://accounts.google.com/gsi/client"></script>

    <script type="module">
        // =================================================================
        // == KONFIGURASI KUNCI API (TETAP SAMA) ==
        // =================================================================
        const firebaseConfig = {
            apiKey: "AIzaSyDpYabA0lb-0uh3Pe-URmeY7WxpIHj7c5Q",
            authDomain: "e-learning-mamyanti.firebaseapp.com",
            projectId: "e-learning-mamyanti",
            storageBucket: "e-learning-mamyanti.appspot.com",
            messagingSenderId: "198925356373",
            appId: "1:198925356373:web:754ae2355b925aa50333dc"
        };
        const GOOGLE_API_KEY = "AIzaSyBJ9yRe5AYOJGiYwAqlm5wK1La3LhhuS5A";
        const GOOGLE_CLIENT_ID = "198925356373-mb0ame0q1sh3elqlq4mofgdakn8df9jh.apps.googleusercontent.com";
        const APP_ID = "198925356373";
        const TEACHER_EMAIL = "elearningmamyanti@gmail.com";
        // =================================================================

        // Initialize Firebase
        firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        const db = firebase.firestore();
        
        // --- Variabel Global & Listener ---
        const pages = document.querySelectorAll('.page');
        const loginBtn = document.getElementById('login-btn');
        const loginSpinner = document.getElementById('login-spinner');
        let currentUser = null;
        let currentUserData = null;
        let listeners = []; // Array untuk menyimpan fungsi unsubscribe

        // --- Navigasi ---
        function showPage(pageId) { 
             pages.forEach(page => page.classList.remove('active'));
             document.getElementById(pageId).classList.add('active');
         }
        function showSubPage(pageElement, subPageId) { 
             pageElement.querySelectorAll('.sub-page').forEach(sp => sp.classList.remove('active'));
             pageElement.querySelector(`#${subPageId}`).classList.add('active');
         }
        
        // Setup tombol kembali & tombol navigasi utama
        document.querySelectorAll('.back-btn').forEach(btn => { 
             btn.addEventListener('click', () => {
                 const targetPageId = btn.dataset.target;
                 const parentPage = btn.closest('.page');
                 showSubPage(parentPage, targetPageId);
             });
         });
        document.querySelectorAll('.page button[data-target]').forEach(btn => {
             btn.addEventListener('click', () => {
                 const targetSubPageId = btn.dataset.target;
                 const parentPage = btn.closest('.page');
                 showSubPage(parentPage, targetSubPageId);
             });
        });

        // --- Authentication ---
        auth.onAuthStateChanged(async (user) => { 
             if (user) {
                 currentUser = user; 
                 loginBtn.style.display = 'none';
                 loginSpinner.style.display = 'flex';
                 await handleUserLogin(user);
             } else {
                  currentUser = null;
                  currentUserData = null;
                  clearListeners(); // Hentikan semua listener saat logout
                  showPage('login-page');
                  loginBtn.style.display = 'inline-flex';
                  loginSpinner.style.display = 'none';
             }
         });
        loginBtn.addEventListener('click', () => { 
            loginBtn.style.display = 'none';
            loginSpinner.style.display = 'flex';
            const provider = new firebase.auth.GoogleAuthProvider();
            auth.signInWithPopup(provider).catch(error => { /* ... error handling ... */ });
        });
        async function handleUserLogin(user) { 
             const userRef = db.collection('users').doc(user.uid);
             const userDoc = await userRef.get();
             if (user.email.toLowerCase() === TEACHER_EMAIL.toLowerCase()) {
                 if (!userDoc.exists) { await userRef.set({ name: user.displayName, email: user.email, role: 'teacher' }, { merge: true }); }
                 currentUserData = (await userRef.get()).data();
                 initializeTeacherDashboard(user);
             } else {
                  if (!userDoc.exists) { await userRef.set({ name: user.displayName, email: user.email, role: 'student', classId: null, className: null }, { merge: true }); }
                  currentUserData = (await userRef.get()).data();
                  initializeStudentDashboard(user, currentUserData);
             }
         }
        function setupLogout(buttonId) { 
             document.getElementById(buttonId).addEventListener('click', () => {
                 if (confirm('Apakah Anda yakin ingin keluar?')) { auth.signOut(); }
             });
         }
        
        // --- Helper ---
        function generateClassCode() { /* ... sama ... */ }
        function formatReadableDate(dateObj) { /* ... sama ... */ }
        function formatChatTimestamp(timestamp) {
            if (!timestamp) return '';
            return timestamp.toDate().toLocaleTimeString('id-ID', { hour: '2-digit', minute: '2-digit' });
        }

        // --- Fungsi Unsubscribe ---
        function clearListeners() {
            listeners.forEach(unsub => unsub());
            listeners = [];
            console.log("Listeners cleared.");
        }

        // =================================================================
        // == TEACHER DASHBOARD LOGIC (v5.0 - Chat Ditambahkan)
        // =================================================================
        
        function initializeTeacherDashboard(user) {
            setupLogout('teacher-logout-btn');
            
            // Setup Tombol Aksi
            document.getElementById('create-class-btn').onclick = createClass;
            document.getElementById('create-task-btn').onclick = createAssignment;
            document.getElementById('publish-announcement-btn').onclick = publishAnnouncement;
            document.getElementById('upload-material-btn').onclick = initPicker;
            document.getElementById('view-attendance-btn').onclick = viewAttendance;
            document.getElementById('teacher-send-chat-btn').onclick = sendChatMessageTeacher;
            document.getElementById('teacher-chat-class-select').onchange = (e) => loadTeacherChat(e.target.value);
            
            // Muat data awal
            loadTeacherData(); 
            setupDeleteListeners(); 
            
            showPage('teacher-dashboard-page');
            showSubPage(document.getElementById('teacher-dashboard-page'), 'teacher-main-menu');
            document.getElementById('attendance-recap-date').valueAsDate = new Date();
        }

        function loadTeacherData() {
            clearListeners(); 
            
            // Muat Daftar Kelas & isi semua dropdown
            const classListEl = document.getElementById('class-code-list');
            const selectEls = document.querySelectorAll('#teacher-dashboard-page select'); 
            
            let classListener = db.collection('classes').where('teacherId', '==', currentUser.uid).orderBy('name', 'asc')
                .onSnapshot(snapshot => {
                    let listHtml = '';
                    let selectHtml = '<option value="">-- Pilih Kelas --</option>';
                    let selectHtmlAll = '<option value="">-- Pilih Kelas --</option>'; 
                    
                    if (!snapshot.empty) {
                        snapshot.forEach(doc => {
                            const data = doc.data();
                            listHtml += `<div class="list-item-teacher">
                                            <span>${data.name} <br> <strong class="code">${data.code}</strong></span>
                                            <button class="delete-btn" data-id="${doc.id}" data-collection="classes">Hapus</button>
                                         </div>`;
                            selectHtml += `<option value="${doc.id}">${data.name}</option>`;
                            selectHtmlAll += `<option value="${doc.id}">${data.name}</option>`;
                        });
                        selectHtmlAll += '<option value="SEMUA KELAS">SEMUA KELAS</option>';
                    } else {
                        listHtml = '<p style="text-align:center;">Belum ada kelas.</p>';
                    }
                    
                    classListEl.innerHTML = listHtml;
                    selectEls.forEach(sel => {
                        const currentValue = sel.value; 
                        if (sel.id === 'announcement-class-target' || sel.id === 'material-class-target') {
                             sel.innerHTML = selectHtmlAll;
                        } else {
                             sel.innerHTML = selectHtml;
                        }
                        if (sel.querySelector(`option[value="${currentValue}"]`)) { sel.value = currentValue; }
                    });
                }, error => { classListEl.innerHTML = '<p class="error">Gagal memuat kelas.</p>'; });
            
            listeners.push(classListener);

            // Muat Daftar Tugas
            const taskListEl = document.getElementById('teacher-assignment-list');
            let taskListener = db.collection('assignments').where('teacherId', '==', currentUser.uid).orderBy('deadline', 'desc')
                .onSnapshot(snapshot => { 
                     if (snapshot.empty) { taskListEl.innerHTML = '<p style="text-align:center;">Belum ada tugas.</p>'; return; }
                     let html = '';
                     snapshot.forEach(doc => { 
                         const data = doc.data();
                         const deadline = formatReadableDate(data.deadline.toDate());
                         html += `<div class="content-item" style="cursor: pointer;" data-id="${doc.id}" data-title="${data.title}">
                                     <strong>${data.title}</strong><small>Tenggat: ${deadline}</small>
                                  </div>`;
                     });
                     taskListEl.innerHTML = html;
                     taskListEl.querySelectorAll('.content-item').forEach(item => { 
                         item.addEventListener('click', () => viewSubmissions(item.dataset.id, item.dataset.title)); 
                     });
                 }, error => { taskListEl.innerHTML = '<p class="error">Gagal memuat tugas.</p>'; });
            listeners.push(taskListener);
            
            loadTeacherAnnouncements();
            loadTeacherMaterials();
        }

        async function createClass() { /* ... kode sama ... */ }
        async function createAssignment() { /* ... kode sama ... */ }
        function viewSubmissions(assignmentId, assignmentTitle) { 
             const div = document.getElementById('teacher-view-submissions-div');
             const listEl = document.getElementById('submission-list-container');
             div.style.display = 'block';
             document.getElementById('submission-list-title').textContent = `Rekap Pengumpulan: ${assignmentTitle}`;
             listEl.innerHTML = '<div class="spinner-container"><div class="spinner"></div></div>';
             showSubPage(document.getElementById('teacher-dashboard-page'), 'teacher-task-page');
             
             // Hapus listener lama jika ada
             const oldListenerIndex = listeners.findIndex(l => l.subId === assignmentId);
             if (oldListenerIndex > -1) {
                 listeners[oldListenerIndex](); // Unsubscribe
                 listeners.splice(oldListenerIndex, 1); // Hapus dari array
             }

             let subListener = db.collection('assignments').doc(assignmentId).collection('submissions').orderBy('timestamp', 'desc')
                 .onSnapshot(snapshot => { /* ... render html ... */ });
             subListener.subId = assignmentId; // Tandai listener
             listeners.push(subListener);
         }
        async function publishAnnouncement() { /* ... kode sama ... */ }
        function loadTeacherAnnouncements() { 
             const listElement = document.getElementById('teacher-announcement-list');
             let listener = db.collection('announcements').orderBy('createdAt', 'desc').limit(10)
                 .onSnapshot(snapshot => { /* ... render html ... */ });
             listeners.push(listener);
         }
        function loadTeacherMaterials() { 
             const listElement = document.getElementById('teacher-material-list');
             let listener = db.collection('materials').orderBy('createdAt', 'desc').limit(10)
                 .onSnapshot(snapshot => { /* ... render html ... */ });
             listeners.push(listener);
         }
        function setupDeleteListeners() { /* ... kode sama ... */ }
        async function viewAttendance() { /* ... kode sama ... */ }
        // --- GOOGLE DRIVE PICKER (Kode sama) ---
        let tokenClient;
        function initPicker() { /* ... kode sama ... */ }
        function gisLoaded(classId) { /* ... kode sama ... */ }
        async function initializePicker(accessToken, classId) { /* ... kode sama ... */ }
        function createPicker(token, classId) { /* ... kode sama ... */ }
        async function pickerCallback(data, classId) { /* ... kode sama ... */ }
        
        // --- FUNGSI BARU: CHAT GURU ---
        let currentTeacherChatListener = null; 

        function loadTeacherChat(classId) {
            const messagesDiv = document.getElementById('teacher-chat-messages');
            const inputEl = document.getElementById('teacher-chat-input');
            const sendBtn = document.getElementById('teacher-send-chat-btn');

            if (currentTeacherChatListener) currentTeacherChatListener();
            
            if (!classId) {
                messagesDiv.innerHTML = '<p style="text-align: center; color: #888;">Pilih kelas untuk memulai chat.</p>';
                inputEl.disabled = true;
                sendBtn.disabled = true;
                return;
            }

            inputEl.disabled = false;
            sendBtn.disabled = false;
            messagesDiv.innerHTML = '<div class="spinner-container"><div class="spinner"></div></div>'; 

            currentTeacherChatListener = db.collection('chats')
                .where('classId', '==', classId).orderBy('timestamp', 'asc').limitToLast(50) 
                .onSnapshot(snapshot => {
                    messagesDiv.innerHTML = ''; 
                    if (snapshot.empty) { messagesDiv.innerHTML = '<p style="text-align: center; color: #888;">Belum ada pesan.</p>'; } 
                    else {
                        snapshot.forEach(doc => renderMessage(doc.data(), messagesDiv, currentUser.uid));
                        messagesDiv.scrollTop = messagesDiv.scrollHeight; 
                    }
                }, error => { messagesDiv.innerHTML = '<p class="error">Gagal memuat chat.</p>'; });
        }

        async function sendChatMessageTeacher() {
            const classId = document.getElementById('teacher-chat-class-select').value;
            const inputEl = document.getElementById('teacher-chat-input');
            const text = inputEl.value.trim();
            if (!classId || !text) return;
            inputEl.disabled = true; // Disable sementara
            try {
                await db.collection('chats').add({
                    classId: classId, senderId: currentUser.uid, senderName: "Mam Yanti", 
                    text: text, timestamp: firebase.firestore.FieldValue.serverTimestamp()
                });
                inputEl.value = ''; 
            } catch (error) { alert("Gagal mengirim pesan."); }
            finally { inputEl.disabled = false; inputEl.focus(); } // Enable lagi
        }

        // =================================================================
        // == STUDENT DASHBOARD LOGIC (v5.0 - Chat Ditambahkan)
        // =================================================================
        
        function initializeStudentDashboard(user, userData) {
            document.getElementById('student-welcome').textContent = `Hai, ${user.displayName.split(' ')[0]}!`;
            setupLogout('student-logout-btn');

            const joinClassDiv = document.getElementById('student-join-class');
            const mainContentDiv = document.getElementById('student-main-content');
            
            if (!userData.classId) {
                joinClassDiv.style.display = 'block';
                mainContentDiv.style.display = 'none';
            } else {
                joinClassDiv.style.display = 'none';
                mainContentDiv.style.display = 'block';
                loadStudentContent(userData.classId); 
                checkStudentAttendance(); 
            }
            
            document.getElementById('join-class-btn').onclick = joinClass;
            document.getElementById('submit-attendance-btn').onclick = submitAttendance;
            document.getElementById('student-send-chat-btn').onclick = sendChatMessageStudent;
            
            showPage('student-dashboard-page');
            showSubPage(document.getElementById('student-dashboard-page'), 'student-main-menu');
        }
        
        async function joinClass() { /* ... kode sama ... */ }
        function getTodayDateString() { /* ... kode sama ... */ }
        async function checkStudentAttendance() { /* ... kode sama ... */ }
        async function submitAttendance() { /* ... kode sama ... */ }
        
        // --- Load Konten (Siswa) - Ditambah Chat ---
        function loadStudentContent(classId) {
            clearListeners(); 
            
            const announcementList = document.getElementById('announcement-list');
            const materialList = document.getElementById('material-list');
            const assignmentList = document.getElementById('assignment-list-student');
            const chatMessagesDiv = document.getElementById('student-chat-messages');

            // Load Announcements, Materials, Assignments... (kodenya sama seperti di Teacher, hanya target elemen berbeda)
            let annListener = db.collection('announcements')...onSnapshot(...); listeners.push(annListener);
            let matListener = db.collection('materials')...onSnapshot(...); listeners.push(matListener);
            let assListener = db.collection('assignments')...onSnapshot(...); listeners.push(assListener);
            
            // BARU: Load Chat Siswa
            chatMessagesDiv.innerHTML = '<div class="spinner-container"><div class="spinner"></div></div>';
            let chatListener = db.collection('chats')
                .where('classId', '==', classId).orderBy('timestamp', 'asc').limitToLast(50)
                .onSnapshot(snapshot => {
                    chatMessagesDiv.innerHTML = ''; 
                    if (snapshot.empty) { chatMessagesDiv.innerHTML = '<p style="text-align: center; color: #888;">Belum ada pesan.</p>'; } 
                    else {
                        snapshot.forEach(doc => renderMessage(doc.data(), chatMessagesDiv, currentUser.uid));
                        // Auto scroll ke kontainer terluar
                        const container = document.getElementById('student-chat-messages-container');
                        container.scrollTop = container.scrollHeight; 
                    }
                }, error => { chatMessagesDiv.innerHTML = '<p class="error">Gagal memuat chat.</p>'; });
            listeners.push(chatListener);
        }

        async function showTaskSubmissionPage(assignmentId) { /* ... kode sama ... */ }
        async function submitTask(assignmentId) { /* ... kode sama ... */ }
        
        // --- FUNGSI BARU: CHAT SISWA ---
        async function sendChatMessageStudent() {
            const inputEl = document.getElementById('student-chat-input');
            const text = inputEl.value.trim();
            const classId = currentUserData.classId; 
            if (!classId || !text) return;
            inputEl.disabled = true; // Disable sementara

            try {
                await db.collection('chats').add({
                    classId: classId, senderId: currentUser.uid, senderName: currentUser.displayName, 
                    text: text, timestamp: firebase.firestore.FieldValue.serverTimestamp()
                });
                inputEl.value = ''; 
            } catch (error) { alert("Gagal mengirim pesan."); }
             finally { inputEl.disabled = false; inputEl.focus(); } // Enable lagi
        }
        
        // --- FUNGSI RENDER PESAN CHAT (Umum) ---
        function renderMessage(data, container, currentUserId) {
            const bubble = document.createElement('div');
            bubble.classList.add('chat-bubble');
            const isSent = data.senderId === currentUserId;
            bubble.classList.add(isSent ? 'sent' : 'received');
            // Hanya tampilkan nama jika bukan user sendiri ATAU jika guru
            const senderName = isSent ? 'Anda' : (data.senderName === 'Mam Yanti' ? 'Mam Yanti' : data.senderName.split(' ')[0]); // Ambil nama depan
            
            bubble.innerHTML = `
                ${!isSent ? `<span class="sender">${senderName}</span>` : ''} 
                <span class="text">${data.text}</span>
                <span class="timestamp">${formatChatTimestamp(data.timestamp)}</span>
            `;
            container.appendChild(bubble);
        }

    </script>

</body>
</html>