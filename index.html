<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>e-Learning English by Mam Yanti</title>
    
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <style>
        /* =========================================
           1. GLOBAL VARIABLES & RESET
           ========================================= */
        :root {
            --primary: #4A90E2; --primary-dark: #357ABD; --secondary: #50E3C2; --accent: #FF6B6B;
            --bg-body: #F0F2F5; --text-main: #333; --border: #E0E0E0; --radius: 16px;
            --wa-header: #008069; --wa-bg: #E5DDD5;
        }
        * { box-sizing: border-box; margin: 0; padding: 0; outline: none; -webkit-tap-highlight-color: transparent; }
        body { font-family: 'Poppins', sans-serif; background-color: var(--bg-body); color: var(--text-main); height: 100vh; overflow: hidden; }
        
        /* Helpers */
        .hidden { display: none !important; }
        .flex-center { display: flex; justify-content: center; align-items: center; }
        .btn { cursor: pointer; border: none; font-family: inherit; transition: 0.2s; }
        .spinner { width: 30px; height: 30px; border: 3px solid #eee; border-top-color: var(--primary); border-radius: 50%; animation: spin 1s linear infinite; margin: 0 auto; }
        @keyframes spin { 100% { transform: rotate(360deg); } }

        /* Modal (Popup) */
        .modal-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.5); z-index: 2000; display: flex; justify-content: center; align-items: center;
        }
        .modal-card {
            background: white; width: 90%; max-width: 500px; padding: 25px; border-radius: var(--radius);
            box-shadow: 0 10px 30px rgba(0,0,0,0.2); max-height: 80vh; overflow-y: auto;
        }
        .modal-header { display: flex; justify-content: space-between; margin-bottom: 15px; align-items: center; }
        .close-modal { background: none; border: none; font-size: 1.5em; cursor: pointer; color: #999; }

        /* Login Page */
        #login-page { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: linear-gradient(135deg, #4A90E2 0%, #50E3C2 100%); z-index: 9999; flex-direction: column; }
        .login-card { background: white; padding: 40px; border-radius: 24px; width: 90%; max-width: 400px; text-align: center; box-shadow: 0 20px 60px rgba(0,0,0,0.2); }
        .login-btn { background: white; border: 1px solid #ddd; padding: 12px; border-radius: 50px; width: 100%; display: flex; align-items: center; justify-content: center; gap: 10px; font-weight: 600; margin-top: 20px; cursor: pointer; }
        .login-btn:hover { background: #f9f9f9; }

        /* Teacher App (Desktop) */
        #teacher-app { width: 100%; height: 100vh; display: grid; grid-template-columns: 260px 1fr; background-color: #F5F7FA; }
        .teacher-sidebar { background: white; border-right: 1px solid var(--border); display: flex; flex-direction: column; padding: 20px; }
        .sidebar-header { margin-bottom: 40px; display: flex; align-items: center; gap: 10px; color: var(--primary); }
        .sidebar-btn { width: 100%; text-align: left; padding: 12px 15px; background: transparent; border-radius: 10px; color: #777; font-weight: 500; display: flex; align-items: center; gap: 12px; cursor: pointer; margin-bottom: 5px; }
        .sidebar-btn:hover, .sidebar-btn.active { background-color: #E3F2FD; color: var(--primary); }
        .teacher-content { padding: 30px; overflow-y: auto; }
        .teacher-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 30px; }
        
        /* Teacher Components */
        .t-card { background: white; padding: 20px; border-radius: 16px; border: 1px solid var(--border); box-shadow: 0 4px 12px rgba(0,0,0,0.05); margin-bottom: 20px; }
        .btn-primary-lg { background: var(--primary); color: white; padding: 10px 20px; border-radius: 8px; font-weight: 600; display: inline-flex; align-items: center; gap: 8px; }
        .data-table { width: 100%; border-collapse: collapse; }
        .data-table th, .data-table td { padding: 12px; text-align: left; border-bottom: 1px solid #eee; }
        .data-table th { background: #f9f9f9; color: #555; font-weight: 600; }
        
        /* Manual Point List */
        .student-list-item { display: flex; justify-content: space-between; align-items: center; padding: 10px; border-bottom: 1px solid #eee; }
        .point-controls { display: flex; gap: 5px; }
        .point-btn { width: 30px; height: 30px; border-radius: 50%; border: 1px solid var(--primary); color: var(--primary); background: white; font-weight: bold; }
        .point-btn:hover { background: var(--primary); color: white; }

        /* Student App (Mobile) */
        #student-app { width: 100%; height: 100%; flex-direction: column; background-color: #FAFAFA; max-width: 480px; margin: 0 auto; position: relative; box-shadow: 0 0 50px rgba(0,0,0,0.1); }
        .mobile-header { padding: 20px; background: white; display: flex; justify-content: space-between; align-items: center; position: sticky; top: 0; z-index: 100; box-shadow: 0 2px 10px rgba(0,0,0,0.03); }
        .student-points { background: linear-gradient(45deg, #FFD700, #FFA500); color: white; padding: 5px 12px; border-radius: 20px; font-weight: 700; font-size: 0.9em; display: flex; align-items: center; gap: 5px; }
        .mobile-content { flex-grow: 1; overflow-y: auto; padding: 20px; padding-bottom: 90px; }
        .mobile-page { display: none; animation: fadeIn 0.3s ease; }
        .mobile-page.active { display: block; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        
        /* Rank Item Student */
        .rank-item { display: flex; align-items: center; padding: 12px; border-bottom: 1px solid #f0f0f0; background: white; margin-bottom: 5px; border-radius: 10px; }
        .rank-num { width: 30px; font-weight: 700; color: var(--primary); font-size: 1.2em; text-align: center; }
        .rank-info { flex-grow: 1; margin-left: 10px; }
        .rank-pts { font-weight: 700; color: #FFAA00; }

        /* Bottom Nav */
        .bottom-nav { position: absolute; bottom: 0; width: 100%; background: white; padding: 10px 20px; display: flex; justify-content: space-around; border-top: 1px solid #eee; border-top-left-radius: 20px; border-top-right-radius: 20px; }
        .nav-item { display: flex; flex-direction: column; align-items: center; color: #BBB; font-size: 0.75em; gap: 4px; background: none; cursor: pointer; }
        .nav-item.active { color: var(--primary); font-weight: 600; }
        .nav-item i { font-size: 1.4em; }

        /* Footer */
        .miapps-footer { text-align: center; padding: 20px; font-size: 0.75em; color: #aaa; margin-top: auto; }
    </style>
</head>
<body>

    <div id="login-page" class="flex-center">
        <div class="login-card">
            <h1 style="color: var(--primary); margin-bottom: 5px;">e-Learning</h1>
            <h2 style="font-weight: 400; margin-bottom: 30px; color: #666;">English by Mam Yanti</h2>
            <button id="login-btn" class="login-btn">
                <img src="https://developers.google.com/identity/images/g-logo.png" alt="G" width="20"> Masuk dengan Google
            </button>
            <div id="login-spinner" class="hidden" style="margin-top: 20px;">
                 <div class="spinner"></div><p style="margin-top: 10px; font-size: 0.8em; color: #888;">Memuat...</p>
            </div>
        </div>
        <div class="miapps-footer" style="color: white;">Web ini dibuat oleh MiAppsDeveloper 2025</div>
    </div>

    <div id="teacher-app" class="hidden">
        <nav class="teacher-sidebar">
            <div class="sidebar-header"><i class="fa-solid fa-graduation-cap fa-xl"></i><h3>Mam Yanti</h3></div>
            <div>
                <button class="sidebar-btn active" onclick="switchTeacherTab('t-dashboard')"><i class="fa-solid fa-house"></i> Dashboard</button>
                <button class="sidebar-btn" onclick="switchTeacherTab('t-rank')"><i class="fa-solid fa-trophy"></i> Leaderboard</button>
                <button class="sidebar-btn" id="teacher-logout"><i class="fa-solid fa-right-from-bracket"></i> Keluar</button>
            </div>
        </nav>

        <main class="teacher-content">
            <div id="t-dashboard" class="teacher-tab">
                <div class="teacher-header">
                    <h1>Dashboard</h1>
                    <button class="btn-primary-lg" onclick="openManualPointModal()"><i class="fa-solid fa-star"></i> Beri Poin Manual</button>
                </div>
                <div class="t-card">
                    <h3><i class="fa-solid fa-chart-line"></i> Statistik Singkat</h3>
                    <p>Total Siswa Terdaftar: <strong id="t-total-students">0</strong></p>
                </div>
            </div>

            <div id="t-rank" class="teacher-tab hidden">
                <div class="teacher-header"><h1>Leaderboard Siswa</h1></div>
                <div class="t-card">
                    <table class="data-table">
                        <thead><tr><th>Rank</th><th>Nama</th><th>Kelas</th><th>Poin</th></tr></thead>
                        <tbody id="teacher-rank-tbody">
                            <tr><td colspan="4" style="text-align:center;">Memuat data...</td></tr>
                        </tbody>
                    </table>
                </div>
            </div>
            <div class="miapps-footer">Web ini dibuat oleh MiAppsDeveloper 2025</div>
        </main>
    </div>

    <div id="point-modal" class="modal-overlay hidden">
        <div class="modal-card">
            <div class="modal-header">
                <h3>Beri Poin Siswa</h3>
                <button class="close-modal" onclick="closeManualPointModal()">&times;</button>
            </div>
            <input type="text" id="search-student" placeholder="Cari nama siswa..." style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 8px; margin-bottom: 15px;">
            <div id="point-student-list" style="max-height: 300px; overflow-y: auto;">
                <div class="spinner"></div>
            </div>
        </div>
    </div>

    <div id="student-app" class="hidden">
        <div class="mobile-header">
            <div>
                <h2 style="font-size: 1.1em; color: var(--primary);">Hi, <span id="s-name-display">...</span></h2>
                <p style="font-size: 0.8em; color: #999;" id="s-class-display">Loading...</p>
            </div>
            <div class="student-points"><i class="fa-solid fa-star"></i> <span id="s-points-display">0</span></div>
        </div>

        <div class="mobile-content">
            <div id="s-home" class="mobile-page active">
                <div class="t-card" style="background: #E3F2FD; border: none;">
                    <h3 style="color: var(--primary);">Poin Kamu: <span id="s-home-points">0</span></h3>
                    <p style="font-size: 0.8em; opacity: 0.8;">Kumpulkan poin dari kuis dan keaktifan!</p>
                </div>
                <h3 style="margin: 20px 0 10px;">Menu</h3>
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px;">
                     <button class="t-card btn" style="text-align: center;" onclick="alert('Kuis belum dimulai')">
                        <i class="fa-solid fa-rocket fa-2x" style="color: #FF6B6B; margin-bottom: 10px;"></i><br>Kuis
                     </button>
                     <button class="t-card btn" style="text-align: center;" onclick="switchStudentPage('s-rank', document.getElementById('nav-rank'))">
                        <i class="fa-solid fa-trophy fa-2x" style="color: #FFD700; margin-bottom: 10px;"></i><br>Rank
                     </button>
                </div>
            </div>

            <div id="s-rank" class="mobile-page">
                <h2 style="margin-bottom: 15px;">Top Students</h2>
                <div id="student-rank-list">
                    <div class="spinner"></div>
                </div>
            </div>
            
            <div id="s-chat" class="mobile-page">
                <div class="t-card" style="text-align:center; padding: 50px 20px;">
                    <i class="fa-brands fa-whatsapp fa-3x" style="color: #25D366; margin-bottom: 15px;"></i>
                    <p>Fitur Chat akan aktif di update berikutnya.</p>
                </div>
            </div>

            <div id="s-profile" class="mobile-page">
                <div class="t-card" style="text-align: center; padding: 30px;">
                    <h2 id="p-name">...</h2>
                    <p id="p-email" style="color: #999; margin-bottom: 20px;">...</p>
                    <button class="btn" style="color: red; border: 1px solid red; padding: 10px 30px; border-radius: 20px; background: white;" onclick="auth.signOut()">Keluar</button>
                </div>
            </div>
            
            <div class="miapps-footer">Web ini dibuat oleh MiAppsDeveloper 2025</div>
        </div>

        <nav class="bottom-nav">
            <button class="nav-item active" onclick="switchStudentPage('s-home', this)"><i class="fa-solid fa-house"></i> Home</button>
            <button class="nav-item" onclick="switchStudentPage('s-chat', this)"><i class="fa-brands fa-whatsapp"></i> Chat</button>
            <button class="nav-item" id="nav-rank" onclick="switchStudentPage('s-rank', this)"><i class="fa-solid fa-trophy"></i> Rank</button>
            <button class="nav-item" onclick="switchStudentPage('s-profile', this)"><i class="fa-solid fa-user"></i> Me</button>
        </nav>
    </div>

    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-firestore.js"></script>

    <script>
        const firebaseConfig = {
            apiKey: "AIzaSyDpYabA0lb-0uh3Pe-URmeY7WxpIHj7c5Q",
            authDomain: "e-learning-mamyanti.firebaseapp.com",
            projectId: "e-learning-mamyanti",
            storageBucket: "e-learning-mamyanti.appspot.com",
            messagingSenderId: "198925356373",
            appId: "1:198925356373:web:754ae2355b925aa50333dc"
        };
        firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        const db = firebase.firestore();
        const TEACHER_EMAIL = "elearningmamyanti@gmail.com";
        
        let currentUser = null;
        let userRole = null;

        // --- AUTH HANDLING ---
        auth.onAuthStateChanged(async (user) => {
            if (user) {
                currentUser = user;
                document.getElementById('login-page').classList.add('hidden');
                
                // Cek Role di Database
                const userDoc = await db.collection('users').doc(user.uid).get();
                if (!userDoc.exists) {
                    // Register new user defaults
                    const role = user.email.toLowerCase() === TEACHER_EMAIL ? 'teacher' : 'student';
                    await db.collection('users').doc(user.uid).set({
                        name: user.displayName, email: user.email, role: role, 
                        totalPoints: 0, className: 'Belum Masuk Kelas', photoUrl: user.photoURL
                    });
                    userRole = role;
                } else {
                    userRole = userDoc.data().role;
                }

                if (userRole === 'teacher') {
                    initTeacherApp();
                } else {
                    initStudentApp();
                }
            } else {
                document.getElementById('login-page').classList.remove('hidden');
                document.getElementById('teacher-app').classList.add('hidden');
                document.getElementById('student-app').classList.add('hidden');
            }
        });

        document.getElementById('login-btn').onclick = () => {
            document.getElementById('login-spinner').classList.remove('hidden');
            document.getElementById('login-btn').style.display = 'none';
            auth.signInWithPopup(new firebase.auth.GoogleAuthProvider()).catch(e => {
                alert("Error: " + e.message);
                document.getElementById('login-spinner').classList.add('hidden');
                document.getElementById('login-btn').style.display = 'flex';
            });
        };

        document.getElementById('teacher-logout').onclick = () => auth.signOut();

        // --- TEACHER LOGIC ---
        function initTeacherApp() {
            document.getElementById('teacher-app').classList.remove('hidden');
            document.getElementById('teacher-app').style.display = 'grid';
            
            // Load Leaderboard Real-time
            db.collection('users').where('role', '==', 'student').orderBy('totalPoints', 'desc').onSnapshot(snap => {
                const tbody = document.getElementById('teacher-rank-tbody');
                document.getElementById('t-total-students').innerText = snap.size;
                
                if(snap.empty) { tbody.innerHTML = '<tr><td colspan="4" style="text-align:center">Belum ada siswa</td></tr>'; return; }
                
                let html = '';
                let rank = 1;
                snap.forEach(doc => {
                    const d = doc.data();
                    html += `<tr>
                        <td><span style="background:${rank===1?'#FFD700':'#eee'}; padding:5px 10px; border-radius:10px; font-weight:bold;">${rank}</span></td>
                        <td>${d.name}</td>
                        <td>${d.className || '-'}</td>
                        <td style="color: var(--primary); font-weight:bold;">${d.totalPoints || 0} Pts</td>
                    </tr>`;
                    rank++;
                });
                tbody.innerHTML = html;
            });
        }

        // Teacher Tabs
        window.switchTeacherTab = (id) => {
            document.querySelectorAll('.teacher-tab').forEach(e => e.classList.add('hidden'));
            document.getElementById(id).classList.remove('hidden');
            document.querySelectorAll('.sidebar-btn').forEach(b => b.classList.remove('active'));
            event.currentTarget.classList.add('active');
        }

        // Teacher: Manual Points Modal
        window.openManualPointModal = () => {
            document.getElementById('point-modal').classList.remove('hidden');
            const listEl = document.getElementById('point-student-list');
            listEl.innerHTML = '<div class="spinner"></div>';
            
            // Fetch students once
            db.collection('users').where('role', '==', 'student').orderBy('name').get().then(snap => {
                if(snap.empty) { listEl.innerHTML = '<p style="text-align:center">Tidak ada siswa.</p>'; return; }
                let html = '';
                snap.forEach(doc => {
                    const d = doc.data();
                    html += `<div class="student-list-item">
                        <span>${d.name} <small>(${d.className || '-'})</small></span>
                        <div class="point-controls">
                            <button class="point-btn" onclick="givePoint('${doc.id}', 5)">+5</button>
                            <button class="point-btn" onclick="givePoint('${doc.id}', 10)">+10</button>
                        </div>
                    </div>`;
                });
                listEl.innerHTML = html;
                
                // Simple Filter
                document.getElementById('search-student').onkeyup = (e) => {
                    const term = e.target.value.toLowerCase();
                    const items = listEl.querySelectorAll('.student-list-item');
                    items.forEach(item => {
                        const text = item.innerText.toLowerCase();
                        item.style.display = text.includes(term) ? 'flex' : 'none';
                    });
                };
            });
        };

        window.closeManualPointModal = () => document.getElementById('point-modal').classList.add('hidden');

        window.givePoint = (uid, amount) => {
            db.collection('users').doc(uid).update({
                totalPoints: firebase.firestore.FieldValue.increment(amount)
            }).then(() => {
                // Optional: Show visual feedback via toast (skipped for simplicity)
                console.log("Poin added");
            });
        };

        // --- STUDENT LOGIC ---
        function initStudentApp() {
            document.getElementById('student-app').classList.remove('hidden');
            document.getElementById('student-app').style.display = 'flex';
            
            // 1. Listener Data Diri (Realtime Points)
            db.collection('users').doc(currentUser.uid).onSnapshot(doc => {
                const d = doc.data();
                document.getElementById('s-name-display').innerText = d.name.split(' ')[0];
                document.getElementById('p-name').innerText = d.name;
                document.getElementById('p-email').innerText = d.email;
                document.getElementById('s-class-display').innerText = d.className || 'Belum Masuk Kelas';
                
                // Update Poin di Header & Home
                const pts = d.totalPoints || 0;
                document.getElementById('s-points-display').innerText = pts;
                document.getElementById('s-home-points').innerText = pts;
            });

            // 2. Listener Leaderboard (Top 20)
            db.collection('users').where('role', '==', 'student').orderBy('totalPoints', 'desc').limit(20).onSnapshot(snap => {
                const listEl = document.getElementById('student-rank-list');
                if(snap.empty) { listEl.innerHTML = '<p style="text-align:center">Belum ada data.</p>'; return; }
                
                let html = '';
                let rank = 1;
                snap.forEach(doc => {
                    const d = doc.data();
                    const isMe = doc.id === currentUser.uid;
                    const style = isMe ? 'border: 2px solid var(--primary); background: #E3F2FD;' : '';
                    
                    html += `<div class="rank-item" style="${style}">
                        <div class="rank-num">${rank}</div>
                        <div class="rank-info">
                            <div class="rank-name">${d.name} ${isMe ? '(Anda)' : ''}</div>
                            <div class="rank-class">${d.className || '-'}</div>
                        </div>
                        <div class="rank-pts">${d.totalPoints || 0}</div>
                    </div>`;
                    rank++;
                });
                listEl.innerHTML = html;
            });
        }

        window.switchStudentPage = (id, btn) => {
            document.querySelectorAll('.mobile-page').forEach(e => e.classList.remove('active'));
            document.getElementById(id).classList.add('active');
            document.querySelectorAll('.nav-item').forEach(b => b.classList.remove('active'));
            btn.classList.add('active');
        };

    </script>
</body>
</html>