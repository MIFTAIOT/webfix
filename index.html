<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>e-Learning English by Mam Yanti (Ultimate)</title>
    
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <style>
        /* --- 1. GLOBAL CSS (MODERN UI) --- */
        :root {
            --primary: #4A90E2; --secondary: #50E3C2; --accent: #FF6B6B;
            --bg: #F4F7F6; --text: #333; --card-bg: #FFF;
            --wa-bg: #E5DDD5; --wa-me: #D9FDD3;
        }
        * { box-sizing: border-box; margin: 0; padding: 0; outline: none; -webkit-tap-highlight-color: transparent; }
        body { font-family: 'Poppins', sans-serif; background: var(--bg); color: var(--text); height: 100vh; overflow: hidden; }
        
        .hidden { display: none !important; }
        .flex-center { display: flex; justify-content: center; align-items: center; }
        .btn { cursor: pointer; border: none; font-family: inherit; transition: 0.2s; font-weight: 500; display: inline-flex; align-items: center; justify-content: center; gap: 8px; }
        .btn:active { transform: scale(0.98); }
        
        /* Components */
        .card { background: var(--card-bg); padding: 20px; border-radius: 16px; box-shadow: 0 4px 10px rgba(0,0,0,0.05); margin-bottom: 15px; }
        .input-group { margin-bottom: 15px; }
        .input-field { width: 100%; padding: 12px; border: 1px solid #ddd; border-radius: 10px; font-family: inherit; }
        .btn-primary { background: var(--primary); color: white; padding: 10px 20px; border-radius: 10px; width: 100%; }
        .btn-danger { background: var(--accent); color: white; padding: 10px 20px; border-radius: 10px; }
        .badge { padding: 4px 10px; border-radius: 20px; font-size: 0.8em; font-weight: bold; }
        .badge-green { background: #E8F5E9; color: #2E7D32; }
        .badge-red { background: #FFEBEE; color: #C62828; }

        /* --- 2. TEACHER UI (LANDSCAPE) --- */
        #teacher-app { display: grid; grid-template-columns: 260px 1fr; height: 100vh; }
        .sidebar { background: white; border-right: 1px solid #eee; padding: 20px; display: flex; flex-direction: column; }
        .menu-btn { width: 100%; text-align: left; padding: 12px; background: transparent; color: #666; border-radius: 10px; margin-bottom: 5px; }
        .menu-btn.active, .menu-btn:hover { background: #E3F2FD; color: var(--primary); font-weight: 600; }
        .main-content { padding: 30px; overflow-y: auto; }
        
        /* Table */
        .table-container { overflow-x: auto; }
        table { width: 100%; border-collapse: collapse; margin-top: 10px; }
        th, td { padding: 12px; text-align: left; border-bottom: 1px solid #eee; }
        th { background: #f9f9f9; color: #777; font-size: 0.9em; }

        /* --- 3. STUDENT UI (MOBILE) --- */
        #student-app { max-width: 480px; margin: 0 auto; background: #fafafa; height: 100vh; display: flex; flex-direction: column; position: relative; box-shadow: 0 0 30px rgba(0,0,0,0.1); }
        .mobile-header { padding: 20px; background: white; display: flex; justify-content: space-between; align-items: center; box-shadow: 0 2px 5px rgba(0,0,0,0.03); z-index: 10; }
        .mobile-body { flex: 1; overflow-y: auto; padding: 20px; padding-bottom: 80px; }
        .mobile-nav { position: absolute; bottom: 0; width: 100%; background: white; padding: 10px 0; display: flex; justify-content: space-around; border-top: 1px solid #eee; z-index: 20; }
        .nav-item { display: flex; flex-direction: column; align-items: center; color: #ccc; font-size: 0.7em; background: none; }
        .nav-item.active { color: var(--primary); }
        .nav-item i { font-size: 1.4em; margin-bottom: 3px; }

        /* --- 4. GAME & CHAT --- */
        .buzzer-btn { width: 180px; height: 180px; border-radius: 50%; background: radial-gradient(#ff5252, #d32f2f); color: white; font-size: 1.5em; font-weight: bold; box-shadow: 0 10px 20px rgba(211, 47, 47, 0.4); margin: 40px auto; display: flex; justify-content: center; align-items: center; border: 8px solid rgba(255,255,255,0.3); }
        .buzzer-btn:active { transform: scale(0.95); }
        .chat-box { height: 100%; display: flex; flex-direction: column; background: var(--wa-bg); }
        .chat-list { flex: 1; overflow-y: auto; padding: 15px; display: flex; flex-direction: column; gap: 8px; }
        .chat-bubble { max-width: 75%; padding: 8px 12px; border-radius: 8px; font-size: 0.9em; position: relative; }
        .chat-me { align-self: flex-end; background: var(--wa-me); }
        .chat-other { align-self: flex-start; background: white; }

        /* --- 5. LOGIN & MODAL --- */
        #login-page { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: linear-gradient(135deg, #4A90E2, #50E3C2); z-index: 9999; flex-direction: column; }
        .login-box { background: white; padding: 40px; border-radius: 20px; text-align: center; width: 90%; max-width: 400px; }
        .modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 2000; display: flex; justify-content: center; align-items: center; }
        .modal-content { background: white; width: 90%; max-width: 500px; padding: 25px; border-radius: 15px; max-height: 80vh; overflow-y: auto; }
        
        /* Spinner */
        .loader { width: 24px; height: 24px; border: 3px solid #ddd; border-top-color: var(--primary); border-radius: 50%; animation: spin 1s infinite; display: inline-block; }
        @keyframes spin { 100% { transform: rotate(360deg); } }
    </style>
</head>
<body>

    <div id="login-page" class="flex-center">
        <div class="login-box">
            <h1 style="color: var(--primary); margin-bottom: 5px;">e-Learning</h1>
            <p style="color: #666; margin-bottom: 30px;">English by Mam Yanti</p>
            <button id="btn-login" class="btn btn-primary" style="background: white; color: #333; border: 1px solid #ddd;">
                <img src="https://developers.google.com/identity/images/g-logo.png" width="20"> Masuk dengan Google
            </button>
            <div id="login-loading" class="hidden" style="margin-top: 15px;"><div class="loader"></div></div>
        </div>
    </div>

    <div id="teacher-app" class="hidden">
        <aside class="sidebar">
            <div style="display: flex; align-items: center; gap: 10px; margin-bottom: 30px; color: var(--primary);">
                <i class="fa-solid fa-graduation-cap fa-2x"></i>
                <div><h3 style="line-height: 1;">Mam Yanti</h3><small>Guru</small></div>
            </div>
            <button class="btn menu-btn active" onclick="openTab('t-home')"><i class="fa-solid fa-house"></i> Dashboard</button>
            <button class="btn menu-btn" onclick="openTab('t-class')"><i class="fa-solid fa-users"></i> Data Kelas</button>
            <button class="btn menu-btn" onclick="openTab('t-tasks')"><i class="fa-solid fa-file-pen"></i> Tugas & PR</button>
            <button class="btn menu-btn" onclick="openTab('t-materi')"><i class="fa-brands fa-google-drive"></i> Materi (Drive)</button>
            <button class="btn menu-btn" onclick="openTab('t-game')"><i class="fa-solid fa-gamepad"></i> Game & Kuis</button>
            <button class="btn menu-btn" onclick="openTab('t-chat')"><i class="fa-brands fa-whatsapp"></i> Chat</button>
            <button class="btn menu-btn" onclick="handleLogout()" style="margin-top: auto; color: var(--accent);"><i class="fa-solid fa-right-from-bracket"></i> Logout</button>
        </aside>

        <main class="main-content">
            
            <div id="t-home" class="tab-view">
                <h1>Dashboard</h1>
                <div class="card" style="margin-top: 20px;">
                    <h3>Kontrol Kelas</h3>
                    <p>Klik tombol di bawah saat jam pelajaran selesai.</p>
                    <button class="btn btn-danger" onclick="triggerEndClass()"><i class="fa-solid fa-bell"></i> Akhiri Kelas & Minta Feedback</button>
                </div>
                <div class="card">
                    <h3>Feedback Siswa Hari Ini</h3>
                    <div id="t-feedback-list">Memuat...</div>
                </div>
            </div>

            <div id="t-class" class="tab-view hidden">
                <h1>Manajemen Kelas</h1>
                <div class="card">
                    <h3>Buat Kelas Baru</h3>
                    <div style="display: flex; gap: 10px;">
                        <input type="text" id="new-class-name" class="input-field" placeholder="Nama Kelas (Misal: XII IPA 1)">
                        <button class="btn btn-primary" style="width: auto;" onclick="createClass()">Buat</button>
                    </div>
                </div>
                <div class="card">
                    <h3>Daftar Kelas & Kode</h3>
                    <div class="table-container">
                        <table id="t-class-table">
                            <thead><tr><th>Nama Kelas</th><th>Kode Unik</th><th>Jml Siswa</th><th>Aksi</th></tr></thead>
                            <tbody></tbody>
                        </table>
                    </div>
                </div>
                <div class="card">
                    <h3>Rekap Absensi</h3>
                    <select id="absen-class-select" class="input-field" onchange="loadAttendanceRecap()"><option>Pilih Kelas...</option></select>
                    <div id="absen-list" style="margin-top: 10px;"></div>
                </div>
            </div>

            <div id="t-tasks" class="tab-view hidden">
                <h1>Tugas & Pengumpulan</h1>
                <div class="card">
                    <h3>Buat Slot Tugas</h3>
                    <div class="input-group">
                        <input type="text" id="task-title" class="input-field" placeholder="Judul Tugas">
                    </div>
                    <div class="input-group">
                        <input type="date" id="task-date" class="input-field">
                    </div>
                    <div class="input-group">
                        <select id="task-class-target" class="input-field"><option>Pilih Kelas...</option></select>
                    </div>
                    <button class="btn btn-primary" onclick="createTask()">Publikasikan Tugas</button>
                </div>
                <div class="card">
                    <h3>Pantau Pengumpulan</h3>
                    <div id="t-task-list">Memuat...</div>
                </div>
            </div>

            <div id="t-materi" class="tab-view hidden">
                <h1>Materi Pelajaran</h1>
                <div class="card">
                    <h3>Upload Materi</h3>
                    <p style="font-size: 0.9em; color: #666; margin-bottom: 10px;">Gunakan tombol ini untuk memilih file dari Google Drive Anda.</p>
                    <input type="text" id="mat-title" class="input-field" placeholder="Judul Materi" style="margin-bottom: 10px;">
                    <button class="btn btn-primary" onclick="initDrivePicker()"><i class="fa-brands fa-google-drive"></i> Pilih dari Google Drive</button>
                    <p id="drive-status" style="margin-top: 5px; font-size: 0.8em;"></p>
                </div>
                <div class="card">
                    <h3>Library Materi</h3>
                    <div id="t-material-list"></div>
                </div>
            </div>

            <div id="t-game" class="tab-view hidden">
                <h1>Game Show</h1>
                <div class="card">
                    <h3>Buzzer Battle</h3>
                    <div style="display: flex; gap: 10px; margin-bottom: 20px;">
                        <button class="btn btn-primary" onclick="randomizeTeams()">1. Acak Tim</button>
                        <button class="btn btn-primary" onclick="setGameState('playing')">2. Mulai Buzzer</button>
                        <button class="btn" style="background: #ccc;" onclick="setGameState('idle')">Stop</button>
                    </div>
                    <div style="display: flex; gap: 20px;">
                        <div style="flex: 1; background: #E74C3C; color: white; padding: 20px; border-radius: 10px; text-align: center;">
                            <h2>RED</h2><h1 id="score-red" style="font-size: 3em;">0</h1>
                        </div>
                        <div style="flex: 1; background: #3498DB; color: white; padding: 20px; border-radius: 10px; text-align: center;">
                            <h2>BLUE</h2><h1 id="score-blue" style="font-size: 3em;">0</h1>
                        </div>
                    </div>
                    <div id="buzzer-winner" class="hidden" style="margin-top: 20px; padding: 20px; border: 2px solid #333; border-radius: 10px; text-align: center;">
                        <h2>üö® BUZZER DITEKAN!</h2>
                        <h1 id="winner-name">...</h1>
                        <div style="margin-top: 10px;">
                            <button class="btn btn-primary" style="background: green;" onclick="handleAnswer(true)">Benar (+100)</button>
                            <button class="btn btn-danger" onclick="handleAnswer(false)">Salah</button>
                        </div>
                    </div>
                </div>
            </div>

            <div id="t-chat" class="tab-view hidden" style="height: calc(100vh - 100px);">
                <div class="chat-box" style="border-radius: 16px; overflow: hidden;">
                    <div id="t-chat-list" class="chat-list"></div>
                    <div style="padding: 10px; background: #eee; display: flex; gap: 10px;">
                        <input type="text" id="t-chat-input" class="input-field" style="margin: 0;" placeholder="Pesan...">
                        <button class="btn btn-primary" style="width: auto;" onclick="sendChat('teacher')"><i class="fa-solid fa-paper-plane"></i></button>
                    </div>
                </div>
            </div>

        </main>
    </div>

    <div id="student-app" class="hidden">
        <header class="mobile-header">
            <div>
                <h3 style="color: var(--primary); margin: 0;">Hi, <span id="s-name">Siswa</span></h3>
                <span id="s-class-display" style="font-size: 0.8em; color: #777;">Belum Masuk Kelas</span>
            </div>
            <div class="badge badge-green"><i class="fa-solid fa-star"></i> <span id="s-points">0</span></div>
        </header>

        <div class="mobile-body">
            
            <div id="s-home" class="s-view">
                <div class="card" style="border-left: 5px solid var(--primary);">
                    <h3>Absensi Harian</h3>
                    <p id="s-absen-status">Anda belum absen hari ini.</p>
                    <button id="btn-absen" class="btn btn-primary" style="margin-top: 10px;" onclick="doAbsensi()">Absen Sekarang</button>
                </div>

                <div id="join-class-card" class="card hidden">
                    <h3>Gabung Kelas</h3>
                    <p>Minta kode unik ke Mam Yanti.</p>
                    <input type="text" id="class-code-input" class="input-field" placeholder="Kode Kelas (6 Digit)">
                    <button class="btn btn-primary" style="margin-top: 10px;" onclick="joinClass()">Gabung</button>
                </div>

                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px;">
                    <div class="card" style="text-align: center; margin: 0;" onclick="openStudentTab('s-task')">
                        <i class="fa-solid fa-file-pen fa-2x" style="color: var(--primary);"></i><br><b>Tugas</b>
                    </div>
                    <div class="card" style="text-align: center; margin: 0;" onclick="openStudentTab('s-materi')">
                        <i class="fa-brands fa-google-drive fa-2x" style="color: var(--secondary);"></i><br><b>Materi</b>
                    </div>
                </div>
            </div>

            <div id="s-task" class="s-view hidden">
                <h2>Daftar Tugas</h2>
                <div id="s-task-list">Memuat...</div>
            </div>

            <div id="s-materi" class="s-view hidden">
                <h2>Materi Belajar</h2>
                <div id="s-material-list">Memuat...</div>
            </div>

            <div id="s-chat" class="s-view hidden" style="height: 100%;">
                <div class="chat-box">
                    <div id="s-chat-list" class="chat-list"></div>
                    <div style="padding: 10px; background: #eee; display: flex; gap: 10px;">
                        <input type="text" id="s-chat-input" class="input-field" style="margin: 0;" placeholder="Pesan...">
                        <button class="btn btn-primary" style="width: auto;" onclick="sendChat('student')"><i class="fa-solid fa-paper-plane"></i></button>
                    </div>
                </div>
            </div>

            <div id="s-profile" class="s-view hidden">
                <div class="card" style="text-align: center;">
                    <div style="width: 80px; height: 80px; background: #eee; border-radius: 50%; margin: 0 auto 15px;">
                        <img src="" id="s-profile-pic" style="width: 100%; height: 100%; border-radius: 50%;">
                    </div>
                    <h2 id="s-profile-name">Nama</h2>
                    <p id="s-profile-email" style="color: #777;">Email</p>
                    <button class="btn btn-danger" onclick="handleLogout()" style="margin-top: 20px;">Logout</button>
                </div>
            </div>

        </div>

        <nav class="mobile-nav">
            <button class="nav-item active" onclick="openStudentTab('s-home', this)"><i class="fa-solid fa-house"></i> Home</button>
            <button class="nav-item" onclick="openStudentTab('s-task', this)"><i class="fa-solid fa-clipboard-check"></i> Tugas</button>
            <button class="nav-item" onclick="openStudentTab('s-chat', this)"><i class="fa-brands fa-whatsapp"></i> Chat</button>
            <button class="nav-item" onclick="openStudentTab('s-profile', this)"><i class="fa-solid fa-user"></i> Profil</button>
        </nav>

        <div id="game-overlay" class="hidden" style="position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: white; z-index: 3000; flex-direction: column; align-items: center; justify-content: center;">
            <h2 id="team-badge" class="badge" style="font-size: 1.5em; margin-bottom: 20px;">TEAM</h2>
            <button id="buzzer-btn" class="buzzer-btn" disabled>TEKAN!</button>
            <p id="game-status" style="margin-top: 20px; font-weight: bold;">Menunggu Guru...</p>
        </div>
    </div>

    <div id="feedback-modal" class="modal-overlay hidden">
        <div class="modal-content" style="text-align: center;">
            <h2>Kelas Selesai!</h2>
            <p>Bagaimana pelajaran hari ini?</p>
            <div style="font-size: 2em; margin: 15px 0;">
                <span onclick="rate(1)">‚≠ê</span><span onclick="rate(2)">‚≠ê</span><span onclick="rate(3)">‚≠ê</span><span onclick="rate(4)">‚≠ê</span><span onclick="rate(5)">‚≠ê</span>
            </div>
            <input type="hidden" id="rating-val">
            <textarea id="feedback-txt" class="input-field" placeholder="Saran untuk Mam Yanti..."></textarea>
            <button class="btn btn-primary" style="margin-top: 10px;" onclick="sendFeedback()">Kirim</button>
        </div>
    </div>

    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-firestore.js"></script>
    <script src="https://apis.google.com/js/api.js"></script>

    <script>
        // 1. FIREBASE CONFIG (Gunakan Config Asli Kamu)
        const firebaseConfig = {
            apiKey: "AIzaSyDpYabA0lb-0uh3Pe-URmeY7WxpIHj7c5Q",
            authDomain: "e-learning-mamyanti.firebaseapp.com",
            projectId: "e-learning-mamyanti",
            storageBucket: "e-learning-mamyanti.appspot.com",
            messagingSenderId: "198925356373",
            appId: "1:198925356373:web:754ae2355b925aa50333dc"
        };
        
        // 2. GOOGLE API CONFIG (Untuk Drive Picker)
        const GOOGLE_API_KEY = "AIzaSyBJ9yRe5AYOJGiYwAqlm5wK1La3LhhuS5A"; // Placeholder, ganti jika perlu
        const CLIENT_ID = "198925356373-mb0ame0q1sh3elqlq4mofgdakn8df9jh.apps.googleusercontent.com";
        const APP_ID = "198925356373";

        firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        const db = firebase.firestore();
        const TEACHER_EMAIL = "elearningmamyanti@gmail.com";

        let currentUser = null;
        let myClassId = null;
        let myTeam = null;

        // --- AUTH LOGIC ---
        auth.onAuthStateChanged(async (user) => {
            if (user) {
                currentUser = user;
                document.getElementById('login-page').classList.add('hidden');
                
                // Cek User di DB
                const doc = await db.collection('users').doc(user.uid).get();
                if (!doc.exists) {
                    // Register Baru
                    const role = user.email.toLowerCase() === TEACHER_EMAIL ? 'teacher' : 'student';
                    await db.collection('users').doc(user.uid).set({
                        name: user.displayName,
                        email: user.email,
                        role: role,
                        photo: user.photoURL,
                        totalPoints: 0,
                        classId: null,
                        team: 'none'
                    });
                    if (role === 'teacher') initTeacher(); else initStudent();
                } else {
                    // User Lama
                    const data = doc.data();
                    if (data.role === 'teacher') initTeacher(); else initStudent();
                }
            } else {
                // Belum Login / Logout
                document.getElementById('login-page').classList.remove('hidden');
                document.getElementById('teacher-app').classList.add('hidden');
                document.getElementById('student-app').classList.add('hidden');
                document.getElementById('login-loading').classList.add('hidden');
                document.getElementById('btn-login').style.display = 'flex';
            }
        });

        document.getElementById('btn-login').onclick = () => {
            document.getElementById('login-loading').classList.remove('hidden');
            document.getElementById('btn-login').style.display = 'none';
            auth.signInWithPopup(new firebase.auth.GoogleAuthProvider()).catch(e => {
                alert("Login Gagal: " + e.message);
                document.getElementById('login-loading').classList.add('hidden');
                document.getElementById('btn-login').style.display = 'flex';
            });
        };

        window.handleLogout = () => {
            if(confirm("Yakin ingin keluar?")) auth.signOut();
        };

        // --- TEACHER FUNCTIONS ---
        function initTeacher() {
            document.getElementById('teacher-app').classList.remove('hidden');
            
            // Load Listeners
            loadClasses();
            loadTasksTeacher();
            loadMaterialsTeacher();
            loadFeedbacks();
            initGameListenerTeacher();
            initChat('teacher');
        }

        // Class Logic
        window.createClass = async () => {
            const name = document.getElementById('new-class-name').value;
            if(!name) return alert("Nama kelas wajib diisi!");
            const code = Math.floor(100000 + Math.random() * 900000).toString(); // 6 Digit Code
            await db.collection('classes').add({
                name: name,
                code: code,
                teacherId: currentUser.uid,
                createdAt: firebase.firestore.FieldValue.serverTimestamp()
            });
            alert(`Kelas ${name} berhasil dibuat! Kode: ${code}`);
            document.getElementById('new-class-name').value = '';
        };

        function loadClasses() {
            db.collection('classes').orderBy('createdAt', 'desc').onSnapshot(snap => {
                const tbody = document.querySelector('#t-class-table tbody');
                const selectTask = document.getElementById('task-class-target');
                const selectAbsen = document.getElementById('absen-class-select');
                
                let html = '';
                let opts = '<option value="">Pilih Kelas...</option>';

                snap.forEach(doc => {
                    const d = doc.data();
                    html += `<tr>
                        <td>${d.name}</td>
                        <td><span class="badge badge-green">${d.code}</span></td>
                        <td>-</td> <td><button class="btn btn-danger" onclick="deleteClass('${doc.id}')">Hapus</button></td>
                    </tr>`;
                    opts += `<option value="${doc.id}">${d.name}</option>`;
                });
                tbody.innerHTML = html;
                selectTask.innerHTML = opts;
                selectAbsen.innerHTML = opts;
            });
        }

        window.deleteClass = async (id) => {
            if(confirm("Hapus kelas ini?")) await db.collection('classes').doc(id).delete();
        };

        // Task Logic
        window.createTask = async () => {
            const title = document.getElementById('task-title').value;
            const date = document.getElementById('task-date').value;
            const cls = document.getElementById('task-class-target').value;
            if(!title || !date || !cls) return alert("Lengkapi data tugas!");

            await db.collection('assignments').add({
                title: title,
                deadline: date,
                classId: cls,
                createdAt: new Date()
            });
            alert("Tugas dipublikasikan!");
        };

        function loadTasksTeacher() {
            db.collection('assignments').orderBy('createdAt', 'desc').onSnapshot(snap => {
                let html = '';
                snap.forEach(doc => {
                    const d = doc.data();
                    html += `<div class="card">
                        <h4>${d.title}</h4>
                        <p><small>Deadline: ${d.deadline}</small></p>
                        <button class="btn btn-primary" onclick="viewSubmissions('${doc.id}')">Lihat Pengumpulan</button>
                    </div>`;
                });
                document.getElementById('t-task-list').innerHTML = html;
            });
        }
        
        window.viewSubmissions = (id) => {
            // Simple Alert for now, can be expanded to modal
            alert("Fitur Lihat Pengumpulan untuk ID: " + id + " (Backend Ready)");
        };

        // Absensi Logic
        window.loadAttendanceRecap = async () => {
            const classId = document.getElementById('absen-class-select').value;
            if(!classId) return;
            const today = new Date().toISOString().slice(0,10);
            
            const snap = await db.collection('attendance').where('classId', '==', classId).where('date', '==', today).get();
            let html = `<h4>Absensi Tanggal ${today}</h4><ul>`;
            if(snap.empty) html += "<li>Belum ada yang absen.</li>";
            else snap.forEach(doc => {
                html += `<li>${doc.data().name} (${doc.data().time})</li>`;
            });
            html += "</ul>";
            document.getElementById('absen-list').innerHTML = html;
        };

        // Drive Picker (Simplified Integration)
        window.initDrivePicker = () => {
            if(confirm("Membuka Google Drive Picker... (Pastikan Pop-up diizinkan)")) {
                // Simulasi Add Material karena API Key user mungkin expired/restricted
                const title = document.getElementById('mat-title').value;
                if(!title) return alert("Isi judul materi dulu!");
                const mockUrl = prompt("Masukkan Link Google Drive / Youtube (Manual):", "https://drive.google.com/...");
                if(mockUrl) {
                    db.collection('materials').add({
                        title: title,
                        url: mockUrl,
                        createdAt: new Date()
                    });
                }
            }
        };
        
        function loadMaterialsTeacher() {
            db.collection('materials').orderBy('createdAt', 'desc').onSnapshot(snap => {
                let html = '';
                snap.forEach(doc => {
                    html += `<div class="card"><a href="${doc.data().url}" target="_blank">${doc.data().title}</a> <button style="float:right; color:red; border:none; background:none;" onclick="db.collection('materials').doc('${doc.id}').delete()">Hapus</button></div>`;
                });
                document.getElementById('t-material-list').innerHTML = html;
            });
        }

        // Game Logic (Buzzer)
        function initGameListenerTeacher() {
            db.collection('game').doc('state').onSnapshot(doc => {
                if(!doc.exists) return;
                const d = doc.data();
                document.getElementById('score-red').innerText = d.redScore;
                document.getElementById('score-blue').innerText = d.blueScore;
                
                const winnerBox = document.getElementById('buzzer-winner');
                if(d.status === 'buzzed') {
                    winnerBox.classList.remove('hidden');
                    document.getElementById('winner-name').innerText = d.buzzerBy.name + " (" + d.buzzerBy.team.toUpperCase() + ")";
                } else {
                    winnerBox.classList.add('hidden');
                }
            });
        }

        window.randomizeTeams = async () => {
            if(!confirm("Acak Tim Siswa?")) return;
            const snap = await db.collection('users').where('role', '==', 'student').get();
            let ids = []; snap.forEach(d => ids.push(d.id));
            ids.sort(() => Math.random() - 0.5);
            const mid = Math.ceil(ids.length / 2);
            const batch = db.batch();
            ids.slice(0, mid).forEach(id => batch.update(db.collection('users').doc(id), {team: 'red'}));
            ids.slice(mid).forEach(id => batch.update(db.collection('users').doc(id), {team: 'blue'}));
            batch.set(db.collection('game').doc('state'), {status: 'idle', redScore: 0, blueScore: 0});
            await batch.commit();
            alert("Tim berhasil diacak!");
        };
        window.setGameState = (s) => db.collection('game').doc('state').update({status: s});
        window.handleAnswer = async (correct) => {
            const state = (await db.collection('game').doc('state').get()).data();
            if(correct) {
                const update = state.buzzerBy.team === 'red' ? {redScore: state.redScore+100} : {blueScore: state.blueScore+100};
                await db.collection('game').doc('state').update({...update, status: 'idle'});
                db.collection('users').doc(state.buzzerBy.uid).update({totalPoints: firebase.firestore.FieldValue.increment(20)});
            } else {
                await db.collection('game').doc('state').update({status: 'idle'});
            }
        };

        // Feedback Logic
        window.triggerEndClass = () => {
            if(confirm("Akhiri Kelas?")) db.collection('system').doc('classState').set({status: 'ended', ts: new Date()});
        };
        function loadFeedbacks() {
            const today = new Date().toISOString().slice(0,10);
            db.collection('feedbacks').where('date', '==', today).onSnapshot(snap => {
                let html = '';
                snap.forEach(doc => {
                    const d = doc.data();
                    html += `<div style="border-bottom:1px solid #eee; padding:10px;"><b>${d.name}</b> (${d.rating}‚≠ê): ${d.text}</div>`;
                });
                document.getElementById('t-feedback-list').innerHTML = html || "Belum ada feedback.";
            });
        }

        // --- STUDENT FUNCTIONS ---
        function initStudent() {
            document.getElementById('student-app').classList.remove('hidden');
            
            // Load Profile
            db.collection('users').doc(currentUser.uid).onSnapshot(doc => {
                const d = doc.data();
                document.getElementById('s-name').innerText = d.name.split(' ')[0];
                document.getElementById('s-points').innerText = d.totalPoints;
                document.getElementById('s-profile-name').innerText = d.name;
                document.getElementById('s-profile-email').innerText = d.email;
                document.getElementById('s-profile-pic').src = d.photo || "https://ui-avatars.com/api/?name="+d.name;
                myClassId = d.classId;
                myTeam = d.team;

                if(myClassId) {
                    document.getElementById('join-class-card').classList.add('hidden');
                    db.collection('classes').doc(myClassId).get().then(c => {
                        if(c.exists) document.getElementById('s-class-display').innerText = c.data().name;
                    });
                    loadStudentData();
                } else {
                    document.getElementById('join-class-card').classList.remove('hidden');
                }
            });

            // Game Listener
            db.collection('game').doc('state').onSnapshot(doc => {
                const d = doc.data();
                const overlay = document.getElementById('game-overlay');
                if(d.status === 'idle') {
                    overlay.classList.add('hidden');
                } else {
                    overlay.classList.remove('hidden');
                    document.getElementById('team-badge').innerText = "TEAM " + (myTeam || '?').toUpperCase();
                    document.getElementById('team-badge').className = "badge " + (myTeam === 'red' ? "badge-red" : "badge-green");
                    const btn = document.getElementById('buzzer-btn');
                    const txt = document.getElementById('game-status');

                    if(d.status === 'playing') {
                        btn.disabled = false; btn.style.filter = 'none'; txt.innerText = "CEPAT TEKAN!";
                    } else if(d.status === 'buzzed') {
                        btn.disabled = true;
                        if(d.buzzerBy.uid === currentUser.uid) {
                            btn.style.background = "#2ecc71"; txt.innerText = "KAMU MENEKAN!";
                        } else {
                            btn.style.filter = 'grayscale(1)'; txt.innerText = d.buzzerBy.name + " menekan!";
                        }
                    }
                }
            });

            // Feedback Listener
            db.collection('system').doc('classState').onSnapshot(doc => {
                if(doc.exists && doc.data().status === 'ended') {
                    const last = localStorage.getItem('last_feedback');
                    const today = new Date().toISOString().slice(0,10);
                    if(last !== today) document.getElementById('feedback-modal').classList.remove('hidden');
                }
            });
            
            initChat('student');
        }

        window.joinClass = async () => {
            const code = document.getElementById('class-code-input').value;
            const snap = await db.collection('classes').where('code', '==', code).get();
            if(snap.empty) return alert("Kode Salah!");
            await db.collection('users').doc(currentUser.uid).update({classId: snap.docs[0].id});
            alert("Berhasil Gabung!");
        };

        function loadStudentData() {
            // Check Absen
            const today = new Date().toISOString().slice(0,10);
            db.collection('attendance').where('uid', '==', currentUser.uid).where('date', '==', today).get().then(snap => {
                if(!snap.empty) {
                    document.getElementById('btn-absen').disabled = true;
                    document.getElementById('btn-absen').innerText = "Sudah Absen";
                    document.getElementById('s-absen-status').innerText = "Hadir jam " + snap.docs[0].data().time;
                }
            });

            // Load Tasks
            db.collection('assignments').where('classId', '==', myClassId).onSnapshot(snap => {
                let html = '';
                snap.forEach(doc => {
                    html += `<div class="card">
                        <h4>${doc.data().title}</h4>
                        <small>Deadline: ${doc.data().deadline}</small>
                        <button class="btn btn-primary" style="margin-top:5px; font-size:0.8em;" onclick="submitTask('${doc.id}')">Kumpulkan Link</button>
                    </div>`;
                });
                document.getElementById('s-task-list').innerHTML = html;
            });

            // Load Materials
            db.collection('materials').orderBy('createdAt', 'desc').onSnapshot(snap => {
                let html = '';
                snap.forEach(doc => {
                    html += `<div class="card" onclick="openMaterial('${doc.data().url}')">
                        <i class="fa-solid fa-book-open" style="color:var(--primary);"></i> <b>${doc.data().title}</b>
                        <br><small>Klik untuk buka (+5 Poin)</small>
                    </div>`;
                });
                document.getElementById('s-material-list').innerHTML = html;
            });
        }

        window.doAbsensi = async () => {
            const today = new Date().toISOString().slice(0,10);
            const time = new Date().toLocaleTimeString();
            await db.collection('attendance').add({
                uid: currentUser.uid, name: currentUser.displayName, date: today, time: time, classId: myClassId
            });
            db.collection('users').doc(currentUser.uid).update({totalPoints: firebase.firestore.FieldValue.increment(10)});
            alert("Absen Berhasil!");
            document.getElementById('btn-absen').disabled = true;
        };

        window.submitTask = async (taskId) => {
            const link = prompt("Masukkan Link Google Drive / Docs Tugas:");
            if(link) {
                await db.collection('submissions').add({
                    taskId: taskId, uid: currentUser.uid, name: currentUser.displayName, link: link, submittedAt: new Date()
                });
                alert("Tugas dikirim!");
            }
        };

        window.openMaterial = (url) => {
            window.open(url, '_blank');
            if(!sessionStorage.getItem('read_'+url)) {
                db.collection('users').doc(currentUser.uid).update({totalPoints: firebase.firestore.FieldValue.increment(5)});
                sessionStorage.setItem('read_'+url, true);
            }
        };

        // --- SHARED CHAT ---
        function initChat(role) {
            const el = document.getElementById(role === 'teacher' ? 't-chat-list' : 's-chat-list');
            db.collection('chats').orderBy('ts').onSnapshot(snap => {
                el.innerHTML = '';
                snap.forEach(doc => {
                    const d = doc.data();
                    const isMe = d.uid === currentUser.uid;
                    const cls = isMe ? 'chat-me' : 'chat-other';
                    el.innerHTML += `<div class="chat-bubble ${cls}"><b>${isMe?'':d.name}</b> ${d.msg}</div>`;
                });
                el.scrollTop = el.scrollHeight;
            });
        }
        window.sendChat = (role) => {
            const inp = document.getElementById(role === 'teacher' ? 't-chat-input' : 's-chat-input');
            if(!inp.value) return;
            db.collection('chats').add({msg: inp.value, uid: currentUser.uid, name: currentUser.displayName.split(' ')[0], ts: new Date()});
            inp.value = '';
        };

        // --- UTILS ---
        window.openTab = (id) => {
            document.querySelectorAll('.tab-view').forEach(e => e.classList.add('hidden'));
            document.getElementById(id).classList.remove('hidden');
            document.querySelectorAll('.menu-btn').forEach(e => e.classList.remove('active'));
            event.currentTarget.classList.add('active');
        };
        window.openStudentTab = (id, btn) => {
            document.querySelectorAll('.s-view').forEach(e => e.classList.add('hidden'));
            document.getElementById(id).classList.remove('hidden');
            document.querySelectorAll('.nav-item').forEach(e => e.classList.remove('active'));
            if(btn) btn.classList.add('active');
        };
        
        // Feedback
        let ratingVal = 0;
        window.rate = (n) => { ratingVal = n; alert(n + " Bintang"); };
        window.sendFeedback = async () => {
            const txt = document.getElementById('feedback-txt').value;
            if(!ratingVal) return alert("Pilih bintang!");
            await db.collection('feedbacks').add({
                name: currentUser.displayName, rating: ratingVal, text: txt, date: new Date().toISOString().slice(0,10)
            });
            localStorage.setItem('last_feedback', new Date().toISOString().slice(0,10));
            document.getElementById('feedback-modal').classList.add('hidden');
            alert("Terima kasih!");
        };

    </script>
</body>
</html>