<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>e-Learning English by Mam Yanti</title>
    
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <style>
        /* GLOBAL & RESET */
        :root {
            --primary: #4A90E2; --secondary: #50E3C2; --accent: #FF6B6B;
            --bg-body: #F0F2F5; --text-main: #333; --border: #E0E0E0; --radius: 16px;
            --red-team: #E74C3C; --blue-team: #3498DB;
            --wa-bg: #E5DDD5; --wa-header: #075E54; --wa-chat-me: #D9FDD3;
        }
        * { box-sizing: border-box; margin: 0; padding: 0; outline: none; -webkit-tap-highlight-color: transparent; }
        body { font-family: 'Poppins', sans-serif; background-color: var(--bg-body); color: var(--text-main); height: 100vh; overflow: hidden; }
        .hidden { display: none !important; }
        .flex-center { display: flex; justify-content: center; align-items: center; }
        .btn { cursor: pointer; border: none; font-family: inherit; transition: 0.2s; }
        .spinner { width: 30px; height: 30px; border: 3px solid #eee; border-top-color: var(--primary); border-radius: 50%; animation: spin 1s linear infinite; margin: 0 auto; }
        @keyframes spin { 100% { transform: rotate(360deg); } }

        /* MODALS */
        .modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.6); z-index: 2000; display: flex; justify-content: center; align-items: center; backdrop-filter: blur(3px); }
        .modal-card { background: white; width: 90%; max-width: 450px; padding: 25px; border-radius: 20px; box-shadow: 0 10px 40px rgba(0,0,0,0.2); text-align: center; animation: popIn 0.3s ease; }
        @keyframes popIn { from { transform: scale(0.8); opacity: 0; } to { transform: scale(1); opacity: 1; } }
        
        /* Feedback Stars */
        .star-rating { display: flex; justify-content: center; gap: 10px; margin: 20px 0; flex-direction: row-reverse; }
        .star-rating input { display: none; }
        .star-rating label { font-size: 2em; color: #ddd; cursor: pointer; transition: 0.2s; }
        .star-rating input:checked ~ label, .star-rating label:hover, .star-rating label:hover ~ label { color: #FFD700; transform: scale(1.1); }

        /* Login */
        #login-page { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: linear-gradient(135deg, #4A90E2 0%, #50E3C2 100%); z-index: 9999; flex-direction: column; }
        .login-card { background: white; padding: 40px; border-radius: 24px; width: 90%; max-width: 400px; text-align: center; box-shadow: 0 20px 60px rgba(0,0,0,0.2); }
        
        /* Teacher CSS */
        #teacher-app { width: 100%; height: 100vh; display: grid; grid-template-columns: 260px 1fr; background-color: #F5F7FA; }
        .teacher-sidebar { background: white; border-right: 1px solid var(--border); display: flex; flex-direction: column; padding: 20px; }
        .sidebar-btn { width: 100%; text-align: left; padding: 12px 15px; background: transparent; border-radius: 10px; color: #777; font-weight: 500; margin-bottom: 5px; cursor: pointer; display: flex; gap: 10px; align-items: center; }
        .sidebar-btn.active, .sidebar-btn:hover { background: #E3F2FD; color: var(--primary); }
        .teacher-content { padding: 30px; overflow-y: auto; display: flex; flex-direction: column; }
        .btn-primary-lg { background: var(--primary); color: white; padding: 10px 20px; border-radius: 8px; font-weight: 600; }
        .btn-danger-lg { background: var(--accent); color: white; padding: 10px 20px; border-radius: 8px; font-weight: 600; box-shadow: 0 4px 10px rgba(255, 107, 107, 0.3); }
        .t-card { background: white; padding: 20px; border-radius: 16px; border: 1px solid var(--border); margin-bottom: 20px; }
        .data-table { width: 100%; border-collapse: collapse; }
        .data-table th, .data-table td { padding: 12px; text-align: left; border-bottom: 1px solid #eee; }

        /* GAME UI */
        .game-scoreboard { display: flex; gap: 20px; margin-bottom: 20px; }
        .team-score { flex: 1; padding: 20px; border-radius: 15px; color: white; text-align: center; box-shadow: 0 4px 15px rgba(0,0,0,0.1); }
        .team-red { background: var(--red-team); }
        .team-blue { background: var(--blue-team); }
        .buzzer-winner { background: #FFF; padding: 20px; border-radius: 15px; border: 2px solid #333; text-align: center; margin-bottom: 20px; animation: pulse 1s infinite; }
        @keyframes pulse { 0% { transform: scale(1); } 50% { transform: scale(1.02); } 100% { transform: scale(1); } }
        #student-game-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: white; z-index: 1500; display: flex; flex-direction: column; padding: 20px; transition: 0.3s; }
        .buzzer-btn { width: 200px; height: 200px; border-radius: 50%; border: 10px solid rgba(255,255,255,0.5); background: radial-gradient(circle, #ff5252 0%, #b71c1c 100%); color: white; font-weight: bold; font-size: 1.5em; box-shadow: 0 10px 30px rgba(0,0,0,0.3); margin: auto; cursor: pointer; display: flex; align-items: center; justify-content: center; transition: transform 0.1s; }
        .buzzer-btn:active { transform: scale(0.95); }
        .buzzer-btn:disabled { filter: grayscale(100%); cursor: not-allowed; }

        /* CHAT UI (WhatsApp Style) */
        .chat-container { display: flex; flex-direction: column; height: 100%; background-color: var(--wa-bg); background-image: url('https://user-images.githubusercontent.com/15075759/28719144-86dc0f70-73b1-11e7-911d-60d70fcded21.png'); background-size: 400px; border-radius: var(--radius); overflow: hidden; }
        .chat-messages { flex: 1; overflow-y: auto; padding: 15px; display: flex; flex-direction: column; gap: 8px; }
        .chat-bubble { max-width: 80%; padding: 8px 12px; border-radius: 8px; position: relative; font-size: 0.9em; line-height: 1.4; box-shadow: 0 1px 2px rgba(0,0,0,0.1); }
        .chat-bubble.me { align-self: flex-end; background-color: var(--wa-chat-me); border-top-right-radius: 0; }
        .chat-bubble.you { align-self: flex-start; background-color: #FFF; border-top-left-radius: 0; }
        .chat-sender { font-weight: bold; font-size: 0.8em; color: #e57e25; margin-bottom: 2px; }
        .chat-time { font-size: 0.7em; color: #999; float: right; margin-left: 8px; margin-top: 4px; }
        .chat-input-area { padding: 10px; background: #F0F0F0; display: flex; gap: 10px; align-items: center; }
        .chat-input { flex: 1; padding: 12px; border-radius: 20px; border: none; outline: none; }
        .chat-send-btn { width: 45px; height: 45px; border-radius: 50%; background: var(--wa-header); color: white; display: flex; align-items: center; justify-content: center; border: none; cursor: pointer; }

        /* Student CSS */
        #student-app { width: 100%; height: 100%; flex-direction: column; background-color: #FAFAFA; max-width: 480px; margin: 0 auto; position: relative; box-shadow: 0 0 50px rgba(0,0,0,0.1); }
        .mobile-header { padding: 20px; background: white; display: flex; justify-content: space-between; align-items: center; box-shadow: 0 2px 10px rgba(0,0,0,0.03); }
        .student-points { background: linear-gradient(45deg, #FFD700, #FFA500); color: white; padding: 5px 12px; border-radius: 20px; font-weight: 700; }
        .mobile-content { flex-grow: 1; overflow-y: auto; padding: 20px; padding-bottom: 90px; display: flex; flex-direction: column; }
        .mobile-page { display: none; animation: fadeIn 0.3s ease; flex-grow: 1; flex-direction: column; }
        .mobile-page.active { display: flex; }
        .bottom-nav { position: absolute; bottom: 0; width: 100%; background: white; padding: 10px 20px; display: flex; justify-content: space-around; border-top: 1px solid #eee; border-top-left-radius: 20px; border-top-right-radius: 20px; }
        .nav-item { display: flex; flex-direction: column; align-items: center; color: #BBB; font-size: 0.75em; gap: 4px; background: none; cursor: pointer; }
        .nav-item.active { color: var(--primary); font-weight: 600; }
        .nav-item i { font-size: 1.4em; }
        
        /* Manual Point List */
        .student-list-item { display: flex; justify-content: space-between; align-items: center; padding: 10px; border-bottom: 1px solid #eee; }
        .point-btn { width: 30px; height: 30px; border-radius: 50%; border: 1px solid var(--primary); color: var(--primary); background: white; font-weight: bold; }
        .point-btn:hover { background: var(--primary); color: white; }
    </style>
</head>
<body>

    <div id="login-page" class="flex-center">
        <div class="login-card">
            <h1 style="color: var(--primary); margin-bottom: 5px;">e-Learning</h1>
            <h2 style="font-weight: 400; margin-bottom: 30px; color: #666;">English by Mam Yanti</h2>
            <button id="login-btn" class="btn" style="background:white; border:1px solid #ddd; padding:12px; border-radius:50px; width:100%; font-weight:600; display:flex; align-items:center; justify-content:center; gap:10px;">
                <img src="https://developers.google.com/identity/images/g-logo.png" width="20"> Masuk dengan Google
            </button>
            <div id="login-spinner" class="hidden" style="margin-top: 20px;"><div class="spinner"></div></div>
        </div>
    </div>

    <div id="teacher-app" class="hidden">
        <nav class="teacher-sidebar">
            <div style="margin-bottom:40px; display:flex; align-items:center; gap:10px; color:var(--primary);">
                <i class="fa-solid fa-graduation-cap fa-xl"></i><h3 style="font-size:1.2em;">Mam Yanti</h3>
            </div>
            <button class="sidebar-btn active" onclick="switchTeacherTab('t-dashboard')"><i class="fa-solid fa-house"></i> Dashboard</button>
            <button class="sidebar-btn" onclick="switchTeacherTab('t-game')"><i class="fa-solid fa-gamepad"></i> Game Show</button>
            <button class="sidebar-btn" onclick="switchTeacherTab('t-chat')"><i class="fa-brands fa-whatsapp"></i> Chat Kelas</button>
            <button class="sidebar-btn" onclick="switchTeacherTab('t-rank')"><i class="fa-solid fa-trophy"></i> Leaderboard</button>
            <button class="sidebar-btn" onclick="switchTeacherTab('t-feedback')"><i class="fa-solid fa-comment-dots"></i> Feedback</button>
            <button class="sidebar-btn" onclick="auth.signOut()" style="margin-top:20px; color:var(--accent);"><i class="fa-solid fa-right-from-bracket"></i> Keluar</button>
        </nav>

        <main class="teacher-content">
            <div id="t-dashboard" class="teacher-tab">
                <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:30px;">
                    <h1>Dashboard</h1>
                    <div style="display:flex; gap:10px;">
                        <button class="btn-primary-lg btn" onclick="openManualPointModal()"><i class="fa-solid fa-star"></i> Beri Poin</button>
                        <button class="btn-danger-lg btn" onclick="triggerEndClass()"><i class="fa-solid fa-bell"></i> Akhiri Kelas</button>
                    </div>
                </div>
                <div class="t-card">
                    <h3>Status Kelas</h3>
                    <p id="class-status-text" style="font-size:1.2em; margin-top:10px; color:#666;">Kelas sedang aktif...</p>
                </div>
            </div>
            
            <div id="t-game" class="teacher-tab hidden">
                <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:20px;">
                    <h1><i class="fa-solid fa-gamepad"></i> Team Battle (Buzzer)</h1>
                    <button class="btn-primary-lg btn" onclick="initGameTeams()">1. Acak & Bagi Tim</button>
                </div>
                
                <div class="game-scoreboard">
                    <div class="team-score team-red">
                        <h2>RED TEAM</h2>
                        <h1 style="font-size:3em;" id="score-red">0</h1>
                    </div>
                    <div class="team-score team-blue">
                        <h2>BLUE TEAM</h2>
                        <h1 style="font-size:3em;" id="score-blue">0</h1>
                    </div>
                </div>

                <div id="buzzer-display" class="buzzer-winner hidden">
                    <h2 style="color:#333;">üö® YANG MENEKAN DULUAN:</h2>
                    <h1 style="font-size:2.5em; color:var(--primary); margin:10px 0;" id="buzzer-winner-name">...</h1>
                    <h3 id="buzzer-winner-team">TEAM ...</h3>
                    <div style="margin-top:20px; display:flex; justify-content:center; gap:10px;">
                        <button class="btn btn-primary-lg" style="background:#27ae60;" onclick="handleAnswer(true)">Benar (+100)</button>
                        <button class="btn btn-danger-lg" onclick="handleAnswer(false)">Salah (Reset)</button>
                    </div>
                </div>

                <div class="t-card" style="text-align:center;">
                    <h3>Kontrol Game</h3>
                    <p style="margin-bottom:15px; color:#777;">Bacakan soal secara lisan, lalu klik tombol di bawah.</p>
                    <button id="btn-start-buzzer" class="btn btn-primary-lg" onclick="setGameState('playing')">MULAI BUZZER (Siswa Bisa Tekan)</button>
                    <button class="btn" style="background:#ccc; padding:10px 20px; border-radius:8px;" onclick="setGameState('idle')">Stop / Pause Game</button>
                </div>
            </div>

            <div id="t-chat" class="teacher-tab hidden" style="height:100%;">
                <div class="chat-container">
                    <div class="chat-messages" id="teacher-chat-list">
                        </div>
                    <div class="chat-input-area">
                        <input type="text" id="teacher-chat-input" class="chat-input" placeholder="Balas pesan siswa...">
                        <button class="chat-send-btn" onclick="sendChat('teacher')"><i class="fa-solid fa-paper-plane"></i></button>
                    </div>
                </div>
            </div>

            <div id="t-rank" class="teacher-tab hidden">
                <h1>Leaderboard</h1>
                <div class="t-card">
                    <table class="data-table">
                        <thead><tr><th>#</th><th>Nama</th><th>Poin</th></tr></thead>
                        <tbody id="teacher-rank-tbody"><tr><td colspan="3">Memuat...</td></tr></tbody>
                    </table>
                </div>
            </div>
            
            <div id="t-feedback" class="teacher-tab hidden">
                <h1>Hasil Feedback Siswa</h1>
                <div class="t-card">
                    <table class="data-table">
                        <thead><tr><th>Nama</th><th>Rating</th><th>Saran</th></tr></thead>
                        <tbody id="teacher-feedback-tbody"><tr><td colspan="3">Belum ada feedback hari ini.</td></tr></tbody>
                    </table>
                </div>
            </div>
        </main>
    </div>

    <div id="point-modal" class="modal-overlay hidden">
        <div class="modal-card" style="text-align:left;">
            <div style="display:flex; justify-content:space-between; margin-bottom:15px;"><h3>Beri Poin</h3><button onclick="closeManualPointModal()" class="btn" style="font-size:1.5em;">&times;</button></div>
            <div id="point-student-list" style="height:300px; overflow-y:auto;"></div>
        </div>
    </div>

    <div id="student-app" class="hidden">
        <div class="mobile-header">
            <div><h2 style="font-size:1.1em; color:var(--primary);">Hi, <span id="s-name-display">...</span></h2></div>
            <div class="student-points"><i class="fa-solid fa-star"></i> <span id="s-points-display">0</span></div>
        </div>

        <div class="mobile-content">
            <div id="s-home" class="mobile-page active">
                <div class="t-card" style="background:#E3F2FD; border:none; text-align:center;">
                    <h1 style="color:var(--primary); font-size:3em;" id="s-home-points">0</h1>
                    <p>Total Poin Kamu</p>
                </div>
                <h3 style="margin:20px 0 10px;">Menu</h3>
                <div style="display:grid; grid-template-columns:1fr 1fr; gap:10px;">
                    <button class="t-card btn" onclick="switchStudentPage('s-rank', document.getElementById('nav-rank'))">
                        <i class="fa-solid fa-trophy fa-2x" style="color:#FFD700;"></i><br>Rank
                    </button>
                     <button class="t-card btn" onclick="alert('Tunggu Mam Yanti mengaktifkan game!')">
                        <i class="fa-solid fa-gamepad fa-2x" style="color:#9B59B6;"></i><br>Game
                    </button>
                </div>
            </div>
            
            <div id="s-chat" class="mobile-page" style="display:none;">
                <div class="chat-container" style="border-radius:0;">
                    <div class="chat-messages" id="student-chat-list"></div>
                    <div class="chat-input-area">
                        <input type="text" id="student-chat-input" class="chat-input" placeholder="Ketik pesan...">
                        <button class="chat-send-btn" onclick="sendChat('student')"><i class="fa-solid fa-paper-plane"></i></button>
                    </div>
                </div>
            </div>
            
            <div id="s-rank" class="mobile-page">
                <h2>Top Students</h2>
                <div id="student-rank-list"></div>
            </div>
            
            <div id="s-profile" class="mobile-page">
                <div class="t-card" style="text-align:center;">
                    <h2 id="p-name">...</h2>
                    <p id="p-email" style="color:#999;">...</p>
                    <button class="btn" style="color:red; border:1px solid red; padding:10px 30px; border-radius:20px; background:white; margin-top:20px;" onclick="auth.signOut()">Keluar</button>
                </div>
            </div>
        </div>
        
        <nav class="bottom-nav">
            <button class="nav-item active" onclick="switchStudentPage('s-home', this)"><i class="fa-solid fa-house"></i> Home</button>
            <button class="nav-item" onclick="switchStudentPage('s-chat', this)"><i class="fa-brands fa-whatsapp"></i> Chat</button>
            <button class="nav-item" id="nav-rank" onclick="switchStudentPage('s-rank', this)"><i class="fa-solid fa-trophy"></i> Rank</button>
            <button class="nav-item" onclick="switchStudentPage('s-profile', this)"><i class="fa-solid fa-user"></i> Me</button>
        </nav>

        <div id="student-game-overlay" class="hidden">
            <div style="text-align:center; margin-bottom:30px;">
                <h2 style="font-size:2em; margin-bottom:5px;">TEAM BATTLE</h2>
                <span id="s-team-badge" style="padding:5px 15px; border-radius:20px; color:white; font-weight:bold;">...</span>
            </div>
            
            <button id="btn-buzzer" class="buzzer-btn" disabled>
                <i class="fa-solid fa-hand-pointer"></i><br>TEKAN!
            </button>
            
            <p id="s-game-status" class="game-status-text">Menunggu Mam Yanti...</p>
        </div>

    </div>

    <div id="feedback-modal" class="modal-overlay hidden">
        <div class="modal-card">
            <h2 style="color:var(--primary);">Kelas Selesai!</h2>
            <p style="color:#666; margin-top:5px;">Bagaimana pelajaran hari ini?</p>
            <div class="star-rating">
                <input type="radio" id="star5" name="rating" value="5"><label for="star5">‚òÖ</label>
                <input type="radio" id="star4" name="rating" value="4"><label for="star4">‚òÖ</label>
                <input type="radio" id="star3" name="rating" value="3"><label for="star3">‚òÖ</label>
                <input type="radio" id="star2" name="rating" value="2"><label for="star2">‚òÖ</label>
                <input type="radio" id="star1" name="rating" value="1"><label for="star1">‚òÖ</label>
            </div>
            <textarea id="feedback-text" placeholder="Tulis saran topik untuk minggu depan..." style="width:100%; padding:15px; border-radius:10px; border:1px solid #ddd; margin-bottom:15px; min-height:80px; font-family:inherit;"></textarea>
            <button id="submit-feedback-btn" class="btn btn-primary-lg" style="width:100%;">Kirim Feedback</button>
        </div>
    </div>
    
    <audio id="sound-buzzer" src="https://www.myinstants.com/media/sounds/buzzer.mp3"></audio>
    <audio id="sound-correct" src="https://www.myinstants.com/media/sounds/correct.mp3"></audio>
    <audio id="sound-wrong" src="https://www.myinstants.com/media/sounds/wrong_1.mp3"></audio>

    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-firestore.js"></script>

    <script>
        const firebaseConfig = {
            apiKey: "AIzaSyDpYabA0lb-0uh3Pe-URmeY7WxpIHj7c5Q",
            authDomain: "e-learning-mamyanti.firebaseapp.com",
            projectId: "e-learning-mamyanti",
            storageBucket: "e-learning-mamyanti.appspot.com",
            messagingSenderId: "198925356373",
            appId: "1:198925356373:web:754ae2355b925aa50333dc"
        };
        firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        const db = firebase.firestore();
        const TEACHER_EMAIL = "elearningmamyanti@gmail.com";
        let currentUser = null;
        let myTeam = null;

        // AUTH LISTENER
        auth.onAuthStateChanged(async (user) => {
            if (user) {
                currentUser = user;
                document.getElementById('login-page').classList.add('hidden');
                const userDoc = await db.collection('users').doc(user.uid).get();
                
                if (!userDoc.exists) {
                    const role = user.email.toLowerCase() === TEACHER_EMAIL ? 'teacher' : 'student';
                    await db.collection('users').doc(user.uid).set({ name: user.displayName, email: user.email, role: role, totalPoints: 0, team: 'none' });
                    role === 'teacher' ? initTeacher() : initStudent();
                } else {
                    userDoc.data().role === 'teacher' ? initTeacher() : initStudent();
                }
            } else {
                document.getElementById('login-page').classList.remove('hidden');
                document.getElementById('teacher-app').classList.add('hidden');
                document.getElementById('student-app').classList.add('hidden');
            }
        });

        document.getElementById('login-btn').onclick = () => {
            document.getElementById('login-spinner').classList.remove('hidden');
            auth.signInWithPopup(new firebase.auth.GoogleAuthProvider()).catch(e => {
                alert(e.message); document.getElementById('login-spinner').classList.add('hidden');
            });
        };

        /* --- CHAT FUNCTION --- */
        function initChat(role) {
            const containerId = role === 'teacher' ? 'teacher-chat-list' : 'student-chat-list';
            const listEl = document.getElementById(containerId);
            
            db.collection('chats').orderBy('timestamp').onSnapshot(snap => {
                listEl.innerHTML = '';
                snap.forEach(doc => {
                    const d = doc.data();
                    const isMe = d.uid === currentUser.uid;
                    const type = isMe ? 'me' : 'you';
                    const date = d.timestamp ? new Date(d.timestamp.toDate()).toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'}) : '...';
                    
                    const html = `
                        <div class="chat-bubble ${type}">
                            ${!isMe ? `<div class="chat-sender">${d.name}</div>` : ''}
                            ${d.text}
                            <div class="chat-time">${date}</div>
                        </div>
                    `;
                    listEl.innerHTML += html;
                });
                listEl.scrollTop = listEl.scrollHeight; // Auto scroll bottom
            });
        }

        window.sendChat = async (role) => {
            const inputId = role === 'teacher' ? 'teacher-chat-input' : 'student-chat-input';
            const input = document.getElementById(inputId);
            const text = input.value.trim();
            if(!text) return;
            
            input.value = '';
            await db.collection('chats').add({
                text: text,
                uid: currentUser.uid,
                name: currentUser.displayName.split(' ')[0],
                timestamp: firebase.firestore.FieldValue.serverTimestamp()
            });
        };

        /* --- TEACHER LOGIC --- */
        function initTeacher() {
            document.getElementById('teacher-app').classList.remove('hidden');
            document.getElementById('teacher-app').style.display = 'grid';
            
            initChat('teacher'); // Init Chat

            // Load Leaderboard
            db.collection('users').where('role', '==', 'student').orderBy('totalPoints', 'desc').onSnapshot(snap => {
                let html = ''; let rank=1;
                snap.forEach(doc => {
                    const d = doc.data();
                    html += `<tr><td>${rank++}</td><td>${d.name} <span style="color:${d.team==='red'?'red':d.team==='blue'?'blue':'#999'}">‚óè</span></td><td style="font-weight:bold;">${d.totalPoints}</td></tr>`;
                });
                document.getElementById('teacher-rank-tbody').innerHTML = html || '<tr><td colspan="3">Kosong</td></tr>';
            });

            // Load Feedback
            const today = new Date().toISOString().slice(0, 10);
            db.collection('feedbacks').where('date', '==', today).onSnapshot(snap => {
                let html = '';
                snap.forEach(doc => { html += `<tr><td>${doc.data().studentName}</td><td>‚≠ê ${doc.data().rating}</td><td>${doc.data().text}</td></tr>`; });
                document.getElementById('teacher-feedback-tbody').innerHTML = html || '<tr><td colspan="3">Nihil.</td></tr>';
            });

            // GAME LISTENER (Teacher)
            db.collection('game').doc('state').onSnapshot(doc => {
                if(!doc.exists) return;
                const data = doc.data();
                document.getElementById('score-red').innerText = data.redScore || 0;
                document.getElementById('score-blue').innerText = data.blueScore || 0;
                
                const winnerDiv = document.getElementById('buzzer-display');
                const startBtn = document.getElementById('btn-start-buzzer');
                
                if (data.status === 'buzzed') {
                    document.getElementById('sound-buzzer').play(); // SOUND EFECT
                    winnerDiv.classList.remove('hidden');
                    startBtn.disabled = true; startBtn.innerText = "Buzzer Terkunci";
                    document.getElementById('buzzer-winner-name').innerText = data.buzzerBy.name;
                    const tm = data.buzzerBy.team;
                    document.getElementById('buzzer-winner-team').innerText = tm === 'red' ? "TEAM RED" : "TEAM BLUE";
                    document.getElementById('buzzer-winner-team').style.color = tm === 'red' ? "var(--red-team)" : "var(--blue-team)";
                } else if (data.status === 'playing') {
                    winnerDiv.classList.add('hidden');
                    startBtn.disabled = true; startBtn.innerText = "Siswa Sedang Berebut...";
                    startBtn.style.background = "#f39c12";
                } else { // idle
                    winnerDiv.classList.add('hidden');
                    startBtn.disabled = false; startBtn.innerText = "MULAI BUZZER (Siswa Bisa Tekan)";
                    startBtn.style.background = "var(--primary)";
                }
            });
        }

        // Game Control Functions
        window.initGameTeams = async () => {
            if(!confirm("Sistem akan membagi semua siswa menjadi Tim Merah dan Biru secara acak. Lanjut?")) return;
            const snap = await db.collection('users').where('role','==','student').get();
            let students = [];
            snap.forEach(doc => students.push(doc.id));
            students.sort(() => Math.random() - 0.5); 
            
            const mid = Math.ceil(students.length / 2);
            const red = students.slice(0, mid);
            const blue = students.slice(mid);
            
            const batch = db.batch();
            red.forEach(uid => batch.update(db.collection('users').doc(uid), { team: 'red' }));
            blue.forEach(uid => batch.update(db.collection('users').doc(uid), { team: 'blue' }));
            batch.set(db.collection('game').doc('state'), { status: 'idle', redScore: 0, blueScore: 0 });
            await batch.commit();
            alert("Tim berhasil dibagi!");
        };

        window.setGameState = (status) => {
            db.collection('game').doc('state').update({ status: status });
        };

        window.handleAnswer = async (isCorrect) => {
            const gameDoc = await db.collection('game').doc('state').get();
            const data = gameDoc.data();
            const winner = data.buzzerBy;
            
            if (isCorrect) {
                document.getElementById('sound-correct').play(); // SOUND CORRECT
                const update = winner.team === 'red' ? { redScore: (data.redScore||0)+100 } : { blueScore: (data.blueScore||0)+100 };
                await db.collection('game').doc('state').update({ ...update, status: 'idle' });
                addPt(winner.uid, 20); 
            } else {
                document.getElementById('sound-wrong').play(); // SOUND WRONG
                await db.collection('game').doc('state').update({ status: 'idle' });
            }
        };

        /* --- STUDENT LOGIC --- */
        function initStudent() {
            document.getElementById('student-app').classList.remove('hidden');
            document.getElementById('student-app').style.display = 'flex';
            
            initChat('student'); // Init Chat

            // Listener User Data
            db.collection('users').doc(currentUser.uid).onSnapshot(doc => {
                const d = doc.data();
                document.getElementById('s-name-display').innerText = d.name.split(' ')[0];
                document.getElementById('s-points-display').innerText = d.totalPoints;
                document.getElementById('s-home-points').innerText = d.totalPoints;
                myTeam = d.team || 'none';
            });
            
            // GAME LISTENER (Student UI Overlay)
            db.collection('game').doc('state').onSnapshot(doc => {
                if(!doc.exists) return;
                const data = doc.data();
                const overlay = document.getElementById('student-game-overlay');
                const btn = document.getElementById('btn-buzzer');
                const statusTxt = document.getElementById('s-game-status');
                const badge = document.getElementById('s-team-badge');

                if (data.status === 'idle') {
                    overlay.classList.add('hidden'); // Hide game if idle
                } else {
                    overlay.classList.remove('hidden'); // Show game
                    
                    if (myTeam === 'red') {
                        overlay.style.backgroundColor = "#FDEDEC";
                        badge.style.background = "var(--red-team)"; badge.innerText = "TEAM RED";
                        btn.style.background = "radial-gradient(circle, #ff5252 0%, #b71c1c 100%)";
                    } else if (myTeam === 'blue') {
                        overlay.style.backgroundColor = "#EBF5FB";
                        badge.style.background = "var(--blue-team)"; badge.innerText = "TEAM BLUE";
                        btn.style.background = "radial-gradient(circle, #3498db 0%, #2980b9 100%)";
                    } else {
                         badge.style.background = "#999"; badge.innerText = "NO TEAM";
                    }

                    if (data.status === 'playing') {
                        btn.disabled = false;
                        btn.style.filter = "none";
                        statusTxt.innerText = "CEPAT TEKAN TOMBOLNYA!";
                        statusTxt.style.color = "var(--primary)";
                    } else if (data.status === 'buzzed') {
                        btn.disabled = true;
                        if (data.buzzerBy.uid === currentUser.uid) {
                            statusTxt.innerText = "KAMU YANG MENEKAN!";
                            btn.style.background = "#2ecc71";
                        } else {
                            statusTxt.innerText = `${data.buzzerBy.name} sudah menekan!`;
                            btn.style.filter = "grayscale(100%)";
                        }
                    }
                }
            });
            
            document.getElementById('btn-buzzer').onclick = () => {
                const btn = document.getElementById('btn-buzzer');
                btn.disabled = true; 
                db.runTransaction(async (t) => {
                    const ref = db.collection('game').doc('state');
                    const doc = await t.get(ref);
                    if (doc.data().status === 'playing') {
                        t.update(ref, { 
                            status: 'buzzed', 
                            buzzerBy: { uid: currentUser.uid, name: currentUser.displayName.split(' ')[0], team: myTeam } 
                        });
                    }
                });
            };

            // Listener Leaderboard
            db.collection('users').where('role', '==', 'student').orderBy('totalPoints', 'desc').limit(10).onSnapshot(snap => {
                let html = ''; let rank=1;
                snap.forEach(doc => {
                    const isMe = doc.id === currentUser.uid;
                    html += `<div class="student-list-item" style="${isMe?'background:#E3F2FD; border-radius:10px;':''}">
                        <span style="font-weight:bold; width:30px; color:var(--primary);">${rank++}</span>
                        <span style="flex-grow:1;">${doc.data().name} ${isMe?'(Anda)':''}</span>
                        <span style="font-weight:bold; color:#FFA500;">${doc.data().totalPoints}</span>
                    </div>`;
                });
                document.getElementById('student-rank-list').innerHTML = html;
            });

            // Trigger Popup Feedback
            db.collection('system').doc('classState').onSnapshot(doc => {
                if(doc.exists && doc.data().status === 'ended') {
                     const lastFeedback = localStorage.getItem('lastFeedbackDate');
                     const today = new Date().toISOString().slice(0, 10);
                     if (lastFeedback !== today) document.getElementById('feedback-modal').classList.remove('hidden');
                } else {
                    document.getElementById('feedback-modal').classList.add('hidden');
                }
            });
        }

        /* --- SHARED FUNCTIONS --- */
        window.triggerEndClass = async () => {
            if(confirm("Akhiri kelas?")) {
                await db.collection('system').doc('classState').set({ status: 'ended', timestamp: new Date() });
                alert("Kelas diakhiri.");
                document.getElementById('class-status-text').innerText = "Kelas berakhir.";
            }
        };

        document.getElementById('submit-feedback-btn').onclick = async () => {
            const rating = document.querySelector('input[name="rating"]:checked');
            const text = document.getElementById('feedback-text').value;
            if(!rating || !text) { alert("Isi semua!"); return; }
            document.getElementById('submit-feedback-btn').innerText = "Mengirim...";
            await db.collection('feedbacks').add({ studentId: currentUser.uid, studentName: currentUser.displayName, rating: rating.value, text: text, date: new Date().toISOString().slice(0, 10) });
            localStorage.setItem('lastFeedbackDate', new Date().toISOString().slice(0, 10));
            alert("Terkirim!");
            document.getElementById('feedback-modal').classList.add('hidden');
        };

        window.switchTeacherTab = (id) => {
            document.querySelectorAll('.teacher-tab').forEach(e => e.classList.add('hidden'));
            document.getElementById(id).classList.remove('hidden');
            document.querySelectorAll('.sidebar-btn').forEach(b => b.classList.remove('active'));
            event.currentTarget.classList.add('active');
        };
        window.switchStudentPage = (id, btn) => {
            document.querySelectorAll('.mobile-page').forEach(e => e.classList.remove('active'));
            document.getElementById(id).classList.add('active');
            document.querySelectorAll('.nav-item').forEach(b => b.classList.remove('active'));
            btn.classList.add('active');
        };
        window.openManualPointModal = () => {
            document.getElementById('point-modal').classList.remove('hidden');
            db.collection('users').where('role','==','student').get().then(snap => {
                let html = ''; snap.forEach(doc => { html += `<div class="student-list-item"><span>${doc.data().name}</span><div><button class="point-btn" onclick="addPt('${doc.id}',5)">+5</button> <button class="point-btn" onclick="addPt('${doc.id}',10)">+10</button></div></div>`; });
                document.getElementById('point-student-list').innerHTML = html;
            });
        };
        window.closeManualPointModal = () => document.getElementById('point-modal').classList.add('hidden');
        window.addPt = (uid, val) => {
            db.collection('users').doc(uid).update({ totalPoints: firebase.firestore.FieldValue.increment(val) });
        };
    </script>
</body>
</html>