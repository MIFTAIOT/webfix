<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>e-Learning English by Mam Yanti (PRO Version)</title>
    
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <style>
        /* =========================================
           1. GLOBAL STYLES (MODERN UI)
           ========================================= */
        :root {
            --primary: #4A90E2; --secondary: #50E3C2; --accent: #FF6B6B;
            --bg-body: #F0F2F5; --text-main: #333; --border: #E0E0E0; --radius: 12px;
            --red-team: #E74C3C; --blue-team: #3498DB;
            --wa-bg: #E5DDD5; --wa-header: #075E54; --wa-chat-me: #D9FDD3;
        }
        * { box-sizing: border-box; margin: 0; padding: 0; outline: none; -webkit-tap-highlight-color: transparent; }
        body { font-family: 'Poppins', sans-serif; background-color: var(--bg-body); color: var(--text-main); height: 100vh; overflow: hidden; }
        
        .hidden { display: none !important; }
        .flex-center { display: flex; justify-content: center; align-items: center; }
        .btn { cursor: pointer; border: none; font-family: inherit; transition: 0.2s; font-weight: 500; }
        .btn:active { transform: scale(0.98); }
        
        /* Spinner */
        .spinner { width: 30px; height: 30px; border: 3px solid #eee; border-top-color: var(--primary); border-radius: 50%; animation: spin 1s linear infinite; margin: 0 auto; }
        @keyframes spin { 100% { transform: rotate(360deg); } }

        /* COMPONENTS */
        .t-card { background: white; padding: 20px; border-radius: var(--radius); border: 1px solid var(--border); margin-bottom: 15px; box-shadow: 0 2px 5px rgba(0,0,0,0.03); }
        .input-field { width: 100%; padding: 12px; border: 1px solid #ddd; border-radius: 8px; margin-bottom: 10px; font-family: inherit; }
        .btn-primary { background: var(--primary); color: white; padding: 10px 20px; border-radius: 8px; width: 100%; }
        .btn-danger { background: var(--accent); color: white; padding: 10px 20px; border-radius: 8px; }
        
        /* LIST ITEMS */
        .list-item { display: flex; justify-content: space-between; align-items: center; padding: 12px; border-bottom: 1px solid #eee; }
        .list-item:last-child { border-bottom: none; }
        .tag { padding: 4px 8px; border-radius: 4px; font-size: 0.8em; background: #eee; color: #555; }

        /* =========================================
           2. TEACHER DASHBOARD (LANDSCAPE)
           ========================================= */
        #teacher-app { width: 100%; height: 100vh; display: grid; grid-template-columns: 250px 1fr; background-color: #F5F7FA; }
        .teacher-sidebar { background: white; border-right: 1px solid var(--border); padding: 20px; display: flex; flex-direction: column; }
        .sidebar-menu { flex-grow: 1; overflow-y: auto; margin-top: 20px; }
        .sidebar-btn { width: 100%; text-align: left; padding: 12px 15px; background: transparent; border-radius: 10px; color: #666; margin-bottom: 5px; display: flex; align-items: center; gap: 10px; }
        .sidebar-btn.active, .sidebar-btn:hover { background: #E3F2FD; color: var(--primary); font-weight: 600; }
        .teacher-content { padding: 30px; overflow-y: auto; }
        
        /* =========================================
           3. STUDENT APP (PORTRAIT/MOBILE)
           ========================================= */
        #student-app { width: 100%; height: 100%; display: flex; flex-direction: column; background-color: #FAFAFA; max-width: 480px; margin: 0 auto; box-shadow: 0 0 50px rgba(0,0,0,0.1); position: relative; }
        .mobile-header { padding: 15px 20px; background: white; display: flex; justify-content: space-between; align-items: center; box-shadow: 0 2px 10px rgba(0,0,0,0.03); z-index: 10; }
        .mobile-content { flex-grow: 1; overflow-y: auto; padding: 20px; padding-bottom: 80px; }
        .mobile-page { display: none; animation: fadeIn 0.3s ease; }
        .mobile-page.active { display: block; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

        .bottom-nav { position: absolute; bottom: 0; width: 100%; background: white; padding: 10px 0; display: flex; justify-content: space-around; border-top: 1px solid #eee; z-index: 10; }
        .nav-item { display: flex; flex-direction: column; align-items: center; color: #BBB; font-size: 0.7em; gap: 4px; background: none; }
        .nav-item.active { color: var(--primary); font-weight: 600; }
        .nav-item i { font-size: 1.4em; }

        /* =========================================
           4. GAME & CHAT MODULES
           ========================================= */
        .buzzer-btn { width: 180px; height: 180px; border-radius: 50%; border: 8px solid rgba(255,255,255,0.5); background: radial-gradient(circle, #ff5252 0%, #b71c1c 100%); color: white; font-size: 1.5em; font-weight: bold; box-shadow: 0 10px 30px rgba(0,0,0,0.2); margin: 20px auto; display: flex; justify-content: center; align-items: center; }
        .buzzer-btn:active { transform: scale(0.95); }
        .buzzer-btn:disabled { filter: grayscale(100%); cursor: not-allowed; }
        
        .chat-container { display: flex; flex-direction: column; height: 100%; background: var(--wa-bg); }
        .chat-messages { flex: 1; overflow-y: auto; padding: 15px; display: flex; flex-direction: column; gap: 8px; }
        .chat-bubble { max-width: 80%; padding: 8px 12px; border-radius: 8px; font-size: 0.9em; position: relative; }
        .chat-bubble.me { align-self: flex-end; background: var(--wa-chat-me); }
        .chat-bubble.you { align-self: flex-start; background: white; }

        /* =========================================
           5. LOGIN & MODALS
           ========================================= */
        #login-page { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: linear-gradient(135deg, #4A90E2, #50E3C2); z-index: 9999; flex-direction: column; }
        .login-card { background: white; padding: 40px; border-radius: 20px; width: 90%; max-width: 400px; text-align: center; box-shadow: 0 20px 50px rgba(0,0,0,0.2); }
        
        .modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 2000; display: flex; justify-content: center; align-items: center; }
        .modal-card { background: white; width: 90%; max-width: 500px; padding: 25px; border-radius: 15px; max-height: 90vh; overflow-y: auto; }
    </style>
</head>
<body>

    <div id="login-page" class="flex-center">
        <div class="login-card">
            <h1 style="color: var(--primary);">e-Learning English</h1>
            <p style="color: #777; margin-bottom: 30px;">By Mam Yanti</p>
            <button id="login-btn" class="btn btn-primary" style="display:flex; align-items:center; justify-content:center; gap:10px;">
                <img src="https://developers.google.com/identity/images/g-logo.png" width="20"> Masuk dengan Google
            </button>
            <div id="login-spinner" class="hidden" style="margin-top:20px;"><div class="spinner"></div></div>
        </div>
        <div style="position:absolute; bottom:20px; color:white; font-size:0.8em;">Created by MiAppsDeveloper 2025</div>
    </div>

    <div id="teacher-app" class="hidden">
        <nav class="teacher-sidebar">
            <div style="display:flex; align-items:center; gap:10px; margin-bottom:30px; color:var(--primary);">
                <i class="fa-solid fa-graduation-cap fa-2x"></i>
                <h3 style="line-height:1.2;">Mam Yanti<br><span style="font-size:0.6em; color:#888;">Teacher Mode</span></h3>
            </div>
            
            <div class="sidebar-menu">
                <button class="sidebar-btn active" onclick="showTab('t-dashboard')"><i class="fa-solid fa-house"></i> Dashboard</button>
                <button class="sidebar-btn" onclick="showTab('t-classes')"><i class="fa-solid fa-chalkboard-user"></i> Data Kelas</button>
                <button class="sidebar-btn" onclick="showTab('t-tasks')"><i class="fa-solid fa-file-pen"></i> Tugas & PR</button>
                <button class="sidebar-btn" onclick="showTab('t-materials')"><i class="fa-solid fa-book"></i> Materi (Drive)</button>
                <button class="sidebar-btn" onclick="showTab('t-games')"><i class="fa-solid fa-gamepad"></i> Game & Kuis</button>
                <button class="sidebar-btn" onclick="showTab('t-chat')"><i class="fa-brands fa-whatsapp"></i> Chat Kelas</button>
                <button class="sidebar-btn" onclick="showTab('t-rank')"><i class="fa-solid fa-trophy"></i> Leaderboard</button>
            </div>
            
            <button class="sidebar-btn" onclick="auth.signOut()" style="color:var(--accent); margin-top:auto;"><i class="fa-solid fa-right-from-bracket"></i> Keluar</button>
        </nav>

        <main class="teacher-content">
            
            <div id="t-dashboard" class="tab-content">
                <h1>Dashboard Guru</h1>
                <div style="display:grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap:20px; margin-top:20px;">
                    <div class="t-card">
                        <h3>Status Kelas</h3>
                        <p id="class-status-display" style="font-size:1.2em; color:var(--primary);">Aktif</p>
                        <button class="btn btn-danger" style="width:100%; margin-top:10px;" onclick="triggerEndClass()">Akhiri Kelas (Feedback)</button>
                    </div>
                    <div class="t-card">
                        <h3>Quick Action</h3>
                        <button class="btn btn-primary" style="margin-bottom:10px;" onclick="openManualPointModal()">+ Beri Poin Manual</button>
                    </div>
                </div>
                
                <h3 style="margin-top:30px;">Hasil Feedback Terbaru</h3>
                <div class="t-card">
                    <div id="feedback-list-teacher">Belum ada feedback hari ini.</div>
                </div>
            </div>

            <div id="t-classes" class="tab-content hidden">
                <h1>Manajemen Kelas</h1>
                <div class="t-card">
                    <h3>Buat Kelas Baru</h3>
                    <div style="display:flex; gap:10px;">
                        <input type="text" id="new-class-name" class="input-field" placeholder="Nama Kelas (Cth: XII MIPA 1)" style="margin:0;">
                        <button class="btn btn-primary" style="width:auto;" onclick="createClass()">Buat</button>
                    </div>
                </div>
                <div class="t-card">
                    <h3>Daftar Kelas & Kode Unik</h3>
                    <div id="class-list-container">Memuat...</div>
                </div>
            </div>

            <div id="t-tasks" class="tab-content hidden">
                <h1>Manajemen Tugas</h1>
                <div class="t-card">
                    <h3>Buat Slot Tugas Baru</h3>
                    <input type="text" id="task-title" class="input-field" placeholder="Judul Tugas">
                    <textarea id="task-desc" class="input-field" placeholder="Instruksi Tugas..."></textarea>
                    <input type="date" id="task-deadline" class="input-field">
                    <select id="task-class-target" class="input-field"><option>Pilih Kelas...</option></select>
                    <button class="btn btn-primary" onclick="createAssignment()">Publikasikan Tugas</button>
                </div>
                <div class="t-card">
                    <h3>Tugas Aktif</h3>
                    <div id="task-list-teacher">Memuat...</div>
                </div>
            </div>

            <div id="t-materials" class="tab-content hidden">
                <h1>Materi Pelajaran</h1>
                <div class="t-card">
                    <h3>Upload dari Google Drive / Link</h3>
                    <input type="text" id="mat-title" class="input-field" placeholder="Judul Materi">
                    <input type="text" id="mat-url" class="input-field" placeholder="Link Google Drive / Youtube">
                    <select id="mat-class-target" class="input-field"><option>Semua Kelas</option></select>
                    <button class="btn btn-primary" onclick="addMaterial()">Posting Materi</button>
                    <p style="font-size:0.8em; color:#777; margin-top:10px;">*Siswa akan mendapat poin jika membuka materi ini.</p>
                </div>
                <div class="t-card">
                    <h3>Daftar Materi</h3>
                    <div id="material-list-teacher">Memuat...</div>
                </div>
            </div>

            <div id="t-games" class="tab-content hidden">
                <h1>Game & Kuis</h1>
                <div class="t-card">
                    <h3>Team Battle (Buzzer)</h3>
                    <div style="display:flex; gap:10px; margin-bottom:20px;">
                        <button class="btn btn-primary" onclick="initGameTeams()">1. Bagi Tim (Acak)</button>
                        <button class="btn btn-primary" onclick="setGameState('playing')">2. Mulai Buzzer</button>
                        <button class="btn" style="background:#ccc;" onclick="setGameState('idle')">Stop</button>
                    </div>
                    
                    <div style="display:flex; gap:20px; text-align:center; color:white;">
                        <div style="flex:1; background:var(--red-team); padding:20px; border-radius:10px;">
                            <h2>RED</h2><h1 style="font-size:3em;" id="score-red">0</h1>
                        </div>
                        <div style="flex:1; background:var(--blue-team); padding:20px; border-radius:10px;">
                            <h2>BLUE</h2><h1 style="font-size:3em;" id="score-blue">0</h1>
                        </div>
                    </div>
                    
                    <div id="buzzer-winner-display" class="hidden" style="text-align:center; margin-top:20px; padding:20px; border:2px solid #333; border-radius:10px;">
                        <h2>üö® BUZZER DITEKAN!</h2>
                        <h1 id="buzzer-who">...</h1>
                        <div style="margin-top:10px;">
                            <button class="btn btn-primary" style="background:green;" onclick="handleAnswer(true)">Benar (+100)</button>
                            <button class="btn btn-danger" onclick="handleAnswer(false)">Salah</button>
                        </div>
                    </div>
                </div>
            </div>

            <div id="t-chat" class="tab-content hidden" style="height: calc(100vh - 100px);">
                <div class="chat-container" style="height:100%; border-radius:10px; overflow:hidden;">
                    <div class="chat-messages" id="chat-list-teacher"></div>
                    <div style="padding:10px; background:#f0f0f0; display:flex; gap:10px;">
                        <input type="text" id="chat-input-teacher" class="input-field" style="margin:0;" placeholder="Ketik pesan...">
                        <button class="btn btn-primary" style="width:auto;" onclick="sendChat('teacher')"><i class="fa-solid fa-paper-plane"></i></button>
                    </div>
                </div>
            </div>

            <div id="t-rank" class="tab-content hidden">
                <h1>Leaderboard Siswa</h1>
                <div class="t-card">
                    <div id="rank-list-teacher">Memuat...</div>
                </div>
            </div>

        </main>
    </div>

    <div id="student-app" class="hidden">
        <div class="mobile-header">
            <div>
                <h2 style="font-size:1.1em; color:var(--primary);">Hi, <span id="s-name">Student</span></h2>
                <span id="s-class-name" style="font-size:0.8em; color:#777;">Belum masuk kelas</span>
            </div>
            <div style="background:#FFF8E1; padding:5px 10px; border-radius:15px; color:#FFA000; font-weight:bold;">
                <i class="fa-solid fa-star"></i> <span id="s-points">0</span>
            </div>
        </div>

        <div class="mobile-content">
            
            <div id="s-home" class="mobile-page active">
                
                <div class="t-card" style="border-left:5px solid var(--primary);">
                    <h3>Absensi Hari Ini</h3>
                    <p id="absent-status">Belum absen.</p>
                    <button id="btn-absen" class="btn btn-primary" style="margin-top:10px;" onclick="submitAttendance()">Absen Sekarang</button>
                </div>

                <div id="join-class-box" class="t-card hidden">
                    <h3>Gabung Kelas</h3>
                    <input type="text" id="class-code-input" class="input-field" placeholder="Masukkan Kode Kelas">
                    <button class="btn btn-primary" onclick="joinClass()">Gabung</button>
                </div>

                <div style="display:grid; grid-template-columns:1fr 1fr; gap:10px;">
                    <div class="t-card" style="text-align:center; background:#E3F2FD;" onclick="showMobilePage('s-tasks')">
                        <i class="fa-solid fa-file-pen fa-2x" style="color:var(--primary);"></i><br><b>Tugas</b>
                    </div>
                    <div class="t-card" style="text-align:center; background:#E0F2F1;" onclick="showMobilePage('s-materials')">
                        <i class="fa-solid fa-book fa-2x" style="color:var(--secondary);"></i><br><b>Materi</b>
                    </div>
                </div>
            </div>

            <div id="s-tasks" class="mobile-page">
                <h2>Daftar Tugas</h2>
                <div id="task-list-student">Memuat...</div>
            </div>

            <div id="s-materials" class="mobile-page">
                <h2>Materi Belajar</h2>
                <div id="material-list-student">Memuat...</div>
            </div>

            <div id="s-chat" class="mobile-page" style="height:100%;">
                <div class="chat-container" style="height:100%;">
                    <div class="chat-messages" id="chat-list-student"></div>
                    <div style="padding:10px; background:#f0f0f0; display:flex; gap:10px;">
                        <input type="text" id="chat-input-student" class="input-field" style="margin:0;" placeholder="Pesan...">
                        <button class="btn btn-primary" style="width:auto;" onclick="sendChat('student')"><i class="fa-solid fa-paper-plane"></i></button>
                    </div>
                </div>
            </div>

            <div id="s-rank" class="mobile-page">
                <h2>Leaderboard</h2>
                <div class="t-card" id="rank-list-student">Memuat...</div>
            </div>
        </div>

        <div id="game-overlay" class="hidden" style="position:fixed; top:0; left:0; width:100%; height:100%; background:white; z-index:2000; flex-direction:column; align-items:center; justify-content:center;">
            <h2 id="team-badge" style="padding:5px 20px; border-radius:20px; color:white; margin-bottom:20px;">TEAM...</h2>
            <button id="buzzer-btn" class="buzzer-btn" disabled>TEKAN!</button>
            <p id="game-status-text" style="margin-top:20px; font-weight:bold;">Menunggu Guru...</p>
        </div>

        <nav class="bottom-nav">
            <button class="nav-item active" onclick="showMobilePage('s-home', this)"><i class="fa-solid fa-house"></i> Home</button>
            <button class="nav-item" onclick="showMobilePage('s-tasks', this)"><i class="fa-solid fa-file-circle-check"></i> Tugas</button>
            <button class="nav-item" onclick="showMobilePage('s-chat', this)"><i class="fa-brands fa-whatsapp"></i> Chat</button>
            <button class="nav-item" onclick="showMobilePage('s-rank', this)"><i class="fa-solid fa-trophy"></i> Rank</button>
        </nav>
    </div>

    <div id="modal-point" class="modal-overlay hidden">
        <div class="modal-card">
            <div style="display:flex; justify-content:space-between;"><h3>Beri Poin Manual</h3><button onclick="closeModal('modal-point')" class="btn">X</button></div>
            <div id="student-list-point" style="margin-top:15px; max-height:300px; overflow-y:auto;"></div>
        </div>
    </div>

    <div id="modal-feedback" class="modal-overlay hidden">
        <div class="modal-card" style="text-align:center;">
            <h2 style="color:var(--primary);">Kelas Selesai!</h2>
            <p>Bagaimana pelajaran hari ini?</p>
            <div style="font-size:2em; margin:10px 0;">
                <span onclick="setRating(1)">‚≠ê</span><span onclick="setRating(2)">‚≠ê</span><span onclick="setRating(3)">‚≠ê</span><span onclick="setRating(4)">‚≠ê</span><span onclick="setRating(5)">‚≠ê</span>
            </div>
            <input type="hidden" id="rating-val">
            <textarea id="feedback-text" class="input-field" placeholder="Saran untuk Mam Yanti..."></textarea>
            <button class="btn btn-primary" onclick="submitFeedback()">Kirim</button>
        </div>
    </div>

    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-firestore.js"></script>
    <script src="https://apis.google.com/js/api.js"></script>

    <script>
        // 1. CONFIGURATION
        const firebaseConfig = {
            apiKey: "AIzaSyDpYabA0lb-0uh3Pe-URmeY7WxpIHj7c5Q",
            authDomain: "e-learning-mamyanti.firebaseapp.com",
            projectId: "e-learning-mamyanti",
            storageBucket: "e-learning-mamyanti.appspot.com",
            messagingSenderId: "198925356373",
            appId: "1:198925356373:web:754ae2355b925aa50333dc"
        };
        firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        const db = firebase.firestore();
        const TEACHER_EMAIL = "elearningmamyanti@gmail.com";
        let currentUser = null;
        let myClassId = null;
        let myTeam = null;

        // 2. AUTH & ROUTING
        auth.onAuthStateChanged(async (user) => {
            if (user) {
                currentUser = user;
                document.getElementById('login-page').classList.add('hidden');
                const doc = await db.collection('users').doc(user.uid).get();
                
                if (!doc.exists) {
                    // Register logic
                    const role = user.email.toLowerCase() === TEACHER_EMAIL ? 'teacher' : 'student';
                    await db.collection('users').doc(user.uid).set({
                        name: user.displayName, email: user.email, role: role, 
                        totalPoints: 0, classId: null, team: 'none'
                    });
                    if(role === 'teacher') initTeacher(); else initStudent();
                } else {
                    if(doc.data().role === 'teacher') initTeacher(); else initStudent();
                }
            } else {
                document.getElementById('login-page').classList.remove('hidden');
                document.getElementById('teacher-app').classList.add('hidden');
                document.getElementById('student-app').classList.add('hidden');
            }
        });

        document.getElementById('login-btn').onclick = () => {
            document.getElementById('login-spinner').classList.remove('hidden');
            auth.signInWithPopup(new firebase.auth.GoogleAuthProvider()).catch(e => alert(e.message));
        };

        // 3. TEACHER LOGIC (COMPLEX)
        function initTeacher() {
            document.getElementById('teacher-app').classList.remove('hidden');
            document.getElementById('teacher-app').style.display = 'grid';
            loadClasses();
            loadTasksTeacher();
            loadMaterialsTeacher();
            initGameTeacher();
            initChat('teacher');
            initLeaderboardTeacher();
            
            // Feedback Listener
            const today = new Date().toISOString().slice(0,10);
            db.collection('feedbacks').where('date','==',today).onSnapshot(snap => {
                let html = '';
                snap.forEach(d => html += `<div class="t-card"><b>${d.data().studentName}</b> (${d.data().rating}‚≠ê): ${d.data().text}</div>`);
                document.getElementById('feedback-list-teacher').innerHTML = html || 'Belum ada.';
            });
        }

        // -- Class Management
        window.createClass = async () => {
            const name = document.getElementById('new-class-name').value;
            if(!name) return;
            const code = Math.random().toString(36).substring(2, 8).toUpperCase();
            await db.collection('classes').add({ name, code, teacherId: currentUser.uid });
            alert("Kelas dibuat! Kode: " + code);
            document.getElementById('new-class-name').value = '';
        };
        function loadClasses() {
            db.collection('classes').onSnapshot(snap => {
                let html = ''; let opts = '<option value="all">Semua Kelas</option>';
                snap.forEach(doc => {
                    const d = doc.data();
                    html += `<div class="list-item"><span><b>${d.name}</b></span> <span class="tag">${d.code}</span></div>`;
                    opts += `<option value="${doc.id}">${d.name}</option>`;
                });
                document.getElementById('class-list-container').innerHTML = html;
                document.getElementById('task-class-target').innerHTML = opts;
                document.getElementById('mat-class-target').innerHTML = opts;
            });
        }

        // -- Task Management
        window.createAssignment = async () => {
            const title = document.getElementById('task-title').value;
            const desc = document.getElementById('task-desc').value;
            const date = document.getElementById('task-deadline').value;
            const cls = document.getElementById('task-class-target').value;
            if(!title || !date) return alert("Lengkapi data tugas");
            await db.collection('assignments').add({ title, description: desc, deadline: date, classId: cls, createdAt: new Date() });
            alert("Tugas dipublikasikan!");
        };
        function loadTasksTeacher() {
            db.collection('assignments').orderBy('createdAt','desc').onSnapshot(snap => {
                let html = '';
                snap.forEach(doc => {
                    html += `<div class="list-item"><span>${doc.data().title}</span> <span class="tag">${doc.data().deadline}</span></div>`;
                });
                document.getElementById('task-list-teacher').innerHTML = html;
            });
        }

        // -- Material Management
        window.addMaterial = async () => {
            const title = document.getElementById('mat-title').value;
            const url = document.getElementById('mat-url').value;
            if(!title || !url) return alert("Data tidak lengkap");
            await db.collection('materials').add({ title, url, createdAt: new Date() });
            alert("Materi diposting!");
        };
        function loadMaterialsTeacher() {
            db.collection('materials').orderBy('createdAt','desc').onSnapshot(snap => {
                let html = '';
                snap.forEach(doc => html += `<div class="list-item"><a href="${doc.data().url}" target="_blank">${doc.data().title}</a></div>`);
                document.getElementById('material-list-teacher').innerHTML = html;
            });
        }

        // -- Game Logic
        function initGameTeacher() {
            db.collection('game').doc('state').onSnapshot(doc => {
                const d = doc.data();
                document.getElementById('score-red').innerText = d.redScore;
                document.getElementById('score-blue').innerText = d.blueScore;
                if(d.status === 'buzzed') {
                    document.getElementById('buzzer-winner-display').classList.remove('hidden');
                    document.getElementById('buzzer-who').innerText = d.buzzerBy.name + " (" + d.buzzerBy.team.toUpperCase() + ")";
                } else {
                    document.getElementById('buzzer-winner-display').classList.add('hidden');
                }
            });
        }
        window.initGameTeams = async () => {
            if(!confirm("Acak Tim?")) return;
            const snap = await db.collection('users').where('role','==','student').get();
            let ids = []; snap.forEach(d => ids.push(d.id));
            ids.sort(() => Math.random() - 0.5);
            const mid = Math.ceil(ids.length/2);
            const batch = db.batch();
            ids.slice(0,mid).forEach(id => batch.update(db.collection('users').doc(id), {team:'red'}));
            ids.slice(mid).forEach(id => batch.update(db.collection('users').doc(id), {team:'blue'}));
            batch.set(db.collection('game').doc('state'), {status:'idle', redScore:0, blueScore:0});
            await batch.commit();
            alert("Tim Dibagi!");
        };
        window.setGameState = (s) => db.collection('game').doc('state').update({status: s});
        window.handleAnswer = async (correct) => {
            const state = (await db.collection('game').doc('state').get()).data();
            if(correct) {
                const team = state.buzzerBy.team;
                const update = team === 'red' ? {redScore: state.redScore+100} : {blueScore: state.blueScore+100};
                await db.collection('game').doc('state').update({...update, status:'idle'});
                // Bonus point to student
                db.collection('users').doc(state.buzzerBy.uid).update({totalPoints: firebase.firestore.FieldValue.increment(20)});
            } else {
                await db.collection('game').doc('state').update({status:'idle'});
            }
        };

        // 4. STUDENT LOGIC (RESTORED)
        function initStudent() {
            document.getElementById('student-app').classList.remove('hidden');
            // Load User Data & Absen Check
            db.collection('users').doc(currentUser.uid).onSnapshot(doc => {
                const d = doc.data();
                document.getElementById('s-name').innerText = d.name.split(' ')[0];
                document.getElementById('s-points').innerText = d.totalPoints;
                myClassId = d.classId;
                myTeam = d.team;
                if(myClassId) {
                    document.getElementById('join-class-box').classList.add('hidden');
                    document.getElementById('s-class-name').innerText = "Kelas Terdaftar";
                    loadStudentContent();
                } else {
                    document.getElementById('join-class-box').classList.remove('hidden');
                }
            });
            
            // Game Listener
            db.collection('game').doc('state').onSnapshot(doc => {
                const d = doc.data();
                const overlay = document.getElementById('game-overlay');
                const badge = document.getElementById('team-badge');
                const btn = document.getElementById('buzzer-btn');
                const txt = document.getElementById('game-status-text');
                
                if(d.status === 'idle') {
                    overlay.classList.add('hidden');
                } else {
                    overlay.classList.remove('hidden');
                    overlay.style.background = myTeam === 'red' ? '#FFEBEE' : '#E3F2FD';
                    badge.style.background = myTeam === 'red' ? 'var(--red-team)' : 'var(--blue-team)';
                    badge.innerText = "TEAM " + myTeam.toUpperCase();
                    
                    if(d.status === 'playing') {
                        btn.disabled = false; btn.style.filter = 'none'; txt.innerText = "CEPAT TEKAN!";
                    } else if (d.status === 'buzzed') {
                        btn.disabled = true;
                        if(d.buzzerBy.uid === currentUser.uid) {
                            txt.innerText = "KAMU MENEKAN!"; btn.style.background = '#2ecc71';
                        } else {
                            txt.innerText = d.buzzerBy.name + " menekan!"; btn.style.filter = 'grayscale(1)';
                        }
                    }
                }
            });
            
            // Buzzer Click
            document.getElementById('buzzer-btn').onclick = () => {
                document.getElementById('buzzer-btn').disabled = true;
                db.runTransaction(async t => {
                    const ref = db.collection('game').doc('state');
                    const s = (await t.get(ref)).data();
                    if(s.status === 'playing') {
                        t.update(ref, {status:'buzzed', buzzerBy: {uid: currentUser.uid, name:currentUser.displayName.split(' ')[0], team: myTeam}});
                    }
                });
            };
            
            // Feedback Trigger
            db.collection('system').doc('classState').onSnapshot(doc => {
                if(doc.exists && doc.data().status === 'ended') {
                    const last = localStorage.getItem('last_feedback');
                    const today = new Date().toISOString().slice(0,10);
                    if(last !== today) document.getElementById('modal-feedback').classList.remove('hidden');
                }
            });

            initChat('student');
            initLeaderboardStudent();
        }

        window.joinClass = async () => {
            const code = document.getElementById('class-code-input').value.toUpperCase();
            const snap = await db.collection('classes').where('code','==',code).get();
            if(snap.empty) return alert("Kode salah!");
            await db.collection('users').doc(currentUser.uid).update({classId: snap.docs[0].id});
            alert("Berhasil gabung!");
        };

        function loadStudentContent() {
            // Absen Check
            const today = new Date().toISOString().slice(0,10);
            db.collection('attendance').doc(today + "_" + currentUser.uid).get().then(doc => {
                if(doc.exists) {
                    document.getElementById('btn-absen').disabled = true;
                    document.getElementById('btn-absen').innerText = "Sudah Absen";
                    document.getElementById('absent-status').innerText = "Hadir pukul " + doc.data().time;
                }
            });
            
            // Load Tasks
            db.collection('assignments').orderBy('createdAt','desc').onSnapshot(snap => {
                let html = '';
                snap.forEach(doc => {
                    html += `<div class="t-card">
                        <b>${doc.data().title}</b><br><small>Deadline: ${doc.data().deadline}</small>
                        <button class="btn btn-primary" style="margin-top:5px; font-size:0.8em;" onclick="submitTask('${doc.id}')">Kumpulkan Link</button>
                    </div>`;
                });
                document.getElementById('task-list-student').innerHTML = html;
            });

            // Load Materials
            db.collection('materials').orderBy('createdAt','desc').onSnapshot(snap => {
                let html = '';
                snap.forEach(doc => {
                    html += `<div class="t-card" onclick="clickMaterial('${doc.data().url}')">
                        <i class="fa-solid fa-book-open" style="color:var(--primary);"></i> <b>${doc.data().title}</b><br>
                        <small style="color:#777;">Klik untuk buka (+5 Poin)</small>
                    </div>`;
                });
                document.getElementById('material-list-student').innerHTML = html;
            });
        }

        window.submitAttendance = async () => {
            const today = new Date().toISOString().slice(0,10);
            const time = new Date().toLocaleTimeString();
            await db.collection('attendance').doc(today + "_" + currentUser.uid).set({
                uid: currentUser.uid, name: currentUser.displayName, time: time, classId: myClassId
            });
            // Bonus Point Absen
            db.collection('users').doc(currentUser.uid).update({totalPoints: firebase.firestore.FieldValue.increment(10)});
            alert("Absen berhasil! +10 Poin");
            document.getElementById('btn-absen').disabled = true;
            document.getElementById('btn-absen').innerText = "Sudah Absen";
        };

        window.submitTask = async (taskId) => {
            const link = prompt("Masukkan Link Google Drive / Dokumen Tugas:");
            if(!link) return;
            await db.collection('submissions').add({
                taskId, uid: currentUser.uid, link, submittedAt: new Date(), name: currentUser.displayName
            });
            alert("Tugas dikumpulkan!");
        };

        window.clickMaterial = (url) => {
            window.open(url, '_blank');
            // Anti spam point (simple logic)
            if(!sessionStorage.getItem('read_'+url)) {
                db.collection('users').doc(currentUser.uid).update({totalPoints: firebase.firestore.FieldValue.increment(5)});
                sessionStorage.setItem('read_'+url, true);
            }
        };

        // 5. SHARED LOGIC (CHAT, UI, FEEDBACK)
        function initChat(role) {
            const el = document.getElementById(role === 'teacher' ? 'chat-list-teacher' : 'chat-list-student');
            db.collection('chats').orderBy('ts').onSnapshot(snap => {
                el.innerHTML = '';
                snap.forEach(doc => {
                    const d = doc.data();
                    const isMe = d.uid === currentUser.uid;
                    const cls = isMe ? 'me' : 'you';
                    el.innerHTML += `<div class="chat-bubble ${cls}"><b>${isMe?'':d.name}</b> ${d.msg}</div>`;
                });
                el.scrollTop = el.scrollHeight;
            });
        }
        window.sendChat = (role) => {
            const inp = document.getElementById(role === 'teacher' ? 'chat-input-teacher' : 'chat-input-student');
            if(!inp.value) return;
            db.collection('chats').add({msg: inp.value, uid: currentUser.uid, name: currentUser.displayName.split(' ')[0], ts: new Date()});
            inp.value = '';
        };

        function initLeaderboardTeacher() {
            db.collection('users').where('role','==','student').orderBy('totalPoints','desc').onSnapshot(snap => {
                let html = ''; let r=1;
                snap.forEach(d => html += `<div class="list-item"><span>${r++}. ${d.data().name}</span><b>${d.data().totalPoints}</b></div>`);
                document.getElementById('rank-list-teacher').innerHTML = html;
            });
        }
        function initLeaderboardStudent() {
             db.collection('users').where('role','==','student').orderBy('totalPoints','desc').limit(10).onSnapshot(snap => {
                let html = ''; let r=1;
                snap.forEach(d => html += `<div class="t-card" style="padding:10px;">#${r++} <b>${d.data().name}</b> <span style="float:right; color:#f39c12;">${d.data().totalPoints} pts</span></div>`);
                document.getElementById('rank-list-student').innerHTML = html;
            });
        }

        window.triggerEndClass = () => {
            if(confirm("Akhiri Kelas?")) db.collection('system').doc('classState').set({status: 'ended', ts: new Date()});
        };
        
        let currentRating = 0;
        window.setRating = (n) => { currentRating = n; alert(n + " Bintang dipilih"); };
        window.submitFeedback = async () => {
            const txt = document.getElementById('feedback-text').value;
            if(!currentRating) return alert("Pilih bintang!");
            await db.collection('feedbacks').add({studentName: currentUser.displayName, rating: currentRating, text: txt, date: new Date().toISOString().slice(0,10)});
            localStorage.setItem('last_feedback', new Date().toISOString().slice(0,10));
            document.getElementById('modal-feedback').classList.add('hidden');
            alert("Terima kasih!");
        };

        // UI Helpers
        window.showTab = (id) => {
            document.querySelectorAll('.tab-content').forEach(el => el.classList.add('hidden'));
            document.getElementById(id).classList.remove('hidden');
            document.querySelectorAll('.sidebar-btn').forEach(el => el.classList.remove('active'));
            event.currentTarget.classList.add('active');
        };
        window.showMobilePage = (id, btn) => {
            document.querySelectorAll('.mobile-page').forEach(el => el.classList.remove('active'));
            document.getElementById(id).classList.add('active');
            document.querySelectorAll('.nav-item').forEach(el => el.classList.remove('active'));
            if(btn) btn.classList.add('active');
        };
        window.openManualPointModal = () => {
            document.getElementById('modal-point').classList.remove('hidden');
            db.collection('users').where('role','==','student').get().then(snap => {
                let html = '';
                snap.forEach(doc => html += `<div class="list-item"><span>${doc.data().name}</span> <button class="btn btn-primary" style="width:auto;" onclick="givePoint('${doc.id}')">+5</button></div>`);
                document.getElementById('student-list-point').innerHTML = html;
            });
        };
        window.closeModal = (id) => document.getElementById(id).classList.add('hidden');
        window.givePoint = (uid) => {
            db.collection('users').doc(uid).update({totalPoints: firebase.firestore.FieldValue.increment(5)});
            alert("Poin diberikan!");
        };
    </script>
</body>
</html>