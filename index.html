<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>e-Learning English by Mam Yanti</title>
    
    <!-- Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Fredoka:wght@300;400;500;600;700&family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    
    <!-- Icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <!-- Tailwind CSS (Untuk Styling Cepat & Modern) -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Animations -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/4.1.1/animate.min.css"/>

    <!-- SweetAlert2 (Popup Cantik) -->
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

    <!-- Chart.js (Untuk Visualisasi Data Sederhana) -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: {
                        sans: ['Poppins', 'sans-serif'],
                        fun: ['Fredoka', 'sans-serif'],
                    },
                    colors: {
                        mamPrimary: '#4F46E5', // Indigo profesional
                        mamSecondary: '#10B981', // Emerald
                        studPrimary: '#FF9F1C', // Orange ceria
                        studSecondary: '#2EC4B6', // Tosca
                        studBg: '#CBF3F0', // Pastel Blue
                        studCard: '#FFFFFF',
                    }
                }
            }
        }
    </script>

    <style>
        /* Custom CSS untuk hal-hal spesifik */
        body { overflow-x: hidden; }
        
        /* Tampilan Siswa: Mobile Friendly & Cute */
        body.student-mode {
            background-color: #CBF3F0;
            font-family: 'Fredoka', sans-serif;
            background-image: radial-gradient(#FFBF69 1px, transparent 1px);
            background-size: 20px 20px;
        }

        /* Tampilan Guru: Laptop Friendly & Clean */
        body.teacher-mode {
            background-color: #F3F4F6;
            font-family: 'Poppins', sans-serif;
        }

        /* Scrollbar cantik */
        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-track { background: #f1f1f1; }
        ::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: #94a3b8; }

        /* Animasi Kustom */
        .floating { animation: float 3s ease-in-out infinite; }
        @keyframes float {
            0% { transform: translateY(0px); }
            50% { transform: translateY(-10px); }
            100% { transform: translateY(0px); }
        }
        
        .card-hover:hover { transform: translateY(-5px); box-shadow: 0 10px 20px rgba(0,0,0,0.1); }

        /* Hide/Show Utility */
        .page { display: none; }
        .page.active { display: block; }
        .sub-page { display: none; }
        .sub-page.active { display: block; }

        /* Bottom Nav Siswa */
        .bottom-nav {
            position: fixed; bottom: 0; width: 100%; background: white;
            box-shadow: 0 -5px 20px rgba(0,0,0,0.05);
            display: flex; justify-content: space-around; padding: 10px 0;
            border-top-left-radius: 20px; border-top-right-radius: 20px;
            z-index: 50;
        }
        .nav-item { text-align: center; color: #9CA3AF; font-size: 0.8em; cursor: pointer; transition: 0.3s; }
        .nav-item.active { color: #FF9F1C; transform: scale(1.1); font-weight: bold; }
        .nav-item i { font-size: 1.5em; display: block; margin-bottom: 2px; }
    </style>
</head>
<body>

    <!-- ================= LOGIN PAGE ================= -->
    <div id="login-page" class="page active min-h-screen flex flex-col items-center justify-center bg-gradient-to-br from-indigo-500 to-purple-600 p-4">
        <div class="bg-white p-8 rounded-3xl shadow-2xl w-full max-w-md text-center animate__animated animate__zoomIn">
            <div class="mb-6 relative">
                <div class="absolute -top-16 left-1/2 transform -translate-x-1/2 bg-white p-4 rounded-full shadow-lg">
                    <i class="fa-solid fa-graduation-cap text-5xl text-indigo-600"></i>
                </div>
            </div>
            <h1 class="text-3xl font-bold text-gray-800 mt-8 font-fun">e-Learning English</h1>
            <p class="text-indigo-500 font-medium text-lg">by Mam Yanti</p>
            <p class="text-gray-500 mt-4 text-sm">Platform belajar bahasa Inggris yang seru dan interaktif!</p>
            
            <button id="login-btn" class="mt-8 w-full bg-white border-2 border-gray-200 text-gray-700 font-semibold py-3 px-4 rounded-xl flex items-center justify-center gap-3 hover:bg-gray-50 transition transform hover:scale-105 shadow-sm">
                <img src="https://developers.google.com/identity/images/g-logo.png" class="w-6 h-6" alt="Google">
                Masuk dengan Google
            </button>
            
            <div id="login-spinner" class="hidden mt-8 flex justify-center">
                <div class="animate-spin rounded-full h-10 w-10 border-b-2 border-indigo-600"></div>
            </div>

            <div class="mt-8 text-xs text-gray-400">
                &copy; MiAppsDeveloper 2025
            </div>
        </div>
    </div>

    <!-- ================= TEACHER DASHBOARD (LAPTOP UI) ================= -->
    <div id="teacher-dashboard" class="page hidden min-h-screen flex bg-gray-100 text-gray-800">
        <!-- Sidebar -->
        <aside class="w-64 bg-white shadow-xl hidden md:flex flex-col z-10 fixed h-full">
            <div class="p-6 border-b flex items-center gap-3">
                <div class="w-10 h-10 rounded-full bg-indigo-100 flex items-center justify-center text-indigo-600 font-bold">MY</div>
                <div>
                    <h2 class="font-bold text-lg">Mam Yanti</h2>
                    <p class="text-xs text-gray-500">Teacher Admin</p>
                </div>
            </div>
            <nav class="flex-1 p-4 space-y-2 overflow-y-auto">
                <button onclick="teacherNav('t-home')" class="t-nav-btn w-full flex items-center gap-3 px-4 py-3 text-gray-600 hover:bg-indigo-50 hover:text-indigo-600 rounded-xl transition font-medium active bg-indigo-50 text-indigo-600">
                    <i class="fa-solid fa-house"></i> Dashboard
                </button>
                <button onclick="teacherNav('t-class')" class="t-nav-btn w-full flex items-center gap-3 px-4 py-3 text-gray-600 hover:bg-indigo-50 hover:text-indigo-600 rounded-xl transition font-medium">
                    <i class="fa-solid fa-chalkboard-user"></i> Manajemen Kelas
                </button>
                <button onclick="teacherNav('t-points')" class="t-nav-btn w-full flex items-center gap-3 px-4 py-3 text-gray-600 hover:bg-indigo-50 hover:text-indigo-600 rounded-xl transition font-medium">
                    <i class="fa-solid fa-star"></i> Poin & Leaderboard
                </button>
                <button onclick="teacherNav('t-games')" class="t-nav-btn w-full flex items-center gap-3 px-4 py-3 text-gray-600 hover:bg-indigo-50 hover:text-indigo-600 rounded-xl transition font-medium">
                    <i class="fa-solid fa-gamepad"></i> Game & Ice Breaking
                </button>
                <button onclick="teacherNav('t-quiz')" class="t-nav-btn w-full flex items-center gap-3 px-4 py-3 text-gray-600 hover:bg-indigo-50 hover:text-indigo-600 rounded-xl transition font-medium">
                    <i class="fa-solid fa-file-circle-question"></i> Bank Soal & Kuis
                </button>
                <button onclick="teacherNav('t-feedback')" class="t-nav-btn w-full flex items-center gap-3 px-4 py-3 text-gray-600 hover:bg-indigo-50 hover:text-indigo-600 rounded-xl transition font-medium">
                    <i class="fa-solid fa-comment-dots"></i> Feedback & Saran
                </button>
            </nav>
            <div class="p-4 border-t">
                <button id="teacher-logout-btn" class="w-full flex items-center gap-3 px-4 py-3 text-red-500 hover:bg-red-50 rounded-xl transition font-medium">
                    <i class="fa-solid fa-right-from-bracket"></i> Keluar
                </button>
            </div>
        </aside>

        <!-- Main Content Area -->
        <main class="flex-1 md:ml-64 p-8 overflow-y-auto">
            <!-- Home / Dashboard -->
            <div id="t-home" class="sub-page active animate__animated animate__fadeIn">
                <header class="flex justify-between items-center mb-8">
                    <div>
                        <h1 class="text-2xl font-bold text-gray-800">Dashboard Ringkasan</h1>
                        <p class="text-gray-500">Selamat datang kembali, Mam Yanti!</p>
                    </div>
                    <div class="bg-white px-4 py-2 rounded-full shadow-sm text-sm font-medium text-gray-600">
                        <i class="fa-regular fa-calendar mr-2"></i> <span id="current-date"></span>
                    </div>
                </header>

                <!-- Quick Stats -->
                <div class="grid grid-cols-1 md:grid-cols-4 gap-6 mb-8">
                    <div class="bg-white p-6 rounded-2xl shadow-sm border border-gray-100 flex items-center gap-4">
                        <div class="w-12 h-12 rounded-full bg-blue-100 text-blue-600 flex items-center justify-center text-xl"><i class="fa-solid fa-users"></i></div>
                        <div><div class="text-2xl font-bold" id="stat-total-students">0</div><div class="text-xs text-gray-500">Total Siswa</div></div>
                    </div>
                    <div class="bg-white p-6 rounded-2xl shadow-sm border border-gray-100 flex items-center gap-4">
                        <div class="w-12 h-12 rounded-full bg-green-100 text-green-600 flex items-center justify-center text-xl"><i class="fa-solid fa-check"></i></div>
                        <div><div class="text-2xl font-bold" id="stat-active-tasks">0</div><div class="text-xs text-gray-500">Tugas Aktif</div></div>
                    </div>
                </div>
                
                <!-- Quick Actions -->
                <div class="bg-gradient-to-r from-indigo-600 to-purple-600 rounded-2xl p-8 text-white shadow-lg mb-8">
                    <h2 class="text-xl font-bold mb-4">Mulai Kelas Sekarang?</h2>
                    <div class="flex gap-4">
                        <button onclick="teacherNav('t-games')" class="bg-white text-indigo-600 px-6 py-2 rounded-lg font-semibold hover:bg-gray-100 transition"><i class="fa-solid fa-dice mr-2"></i> Ice Breaking</button>
                        <button onclick="requestFeedbackGlobal()" class="bg-indigo-500 border border-indigo-400 text-white px-6 py-2 rounded-lg font-semibold hover:bg-indigo-400 transition"><i class="fa-solid fa-bullhorn mr-2"></i> Minta Feedback</button>
                    </div>
                </div>
            </div>

            <!-- Class Management -->
            <div id="t-class" class="sub-page animate__animated animate__fadeIn">
                <h1 class="text-2xl font-bold text-gray-800 mb-6">Manajemen Kelas</h1>
                <div class="bg-white p-6 rounded-2xl shadow-sm border border-gray-100 mb-6">
                    <h3 class="font-bold mb-4">Buat Kelas Baru</h3>
                    <div class="flex gap-4">
                        <input type="text" id="class-name-input" placeholder="Nama Kelas (Cth: XII IPA 1)" class="flex-1 border rounded-xl px-4 py-2 focus:outline-none focus:ring-2 focus:ring-indigo-500">
                        <button id="create-class-btn" class="bg-indigo-600 text-white px-6 py-2 rounded-xl hover:bg-indigo-700 transition">Buat</button>
                    </div>
                </div>
                <div id="class-list-container" class="grid grid-cols-1 md:grid-cols-3 gap-6">
                    <!-- Class Cards Injected Here -->
                </div>
            </div>

            <!-- Points & Leaderboard (Manual Points) -->
            <div id="t-points" class="sub-page animate__animated animate__fadeIn">
                <h1 class="text-2xl font-bold text-gray-800 mb-6">Sistem Poin & Leaderboard</h1>
                <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
                    <!-- Manual Input -->
                    <div class="lg:col-span-2 bg-white p-6 rounded-2xl shadow-sm border border-gray-100">
                        <div class="flex justify-between items-center mb-4">
                            <h3 class="font-bold text-lg">Berikan Poin Manual (Keaktifan)</h3>
                            <select id="points-class-filter" class="border rounded-lg px-3 py-1 text-sm">
                                <option value="">Pilih Kelas</option>
                            </select>
                        </div>
                        <p class="text-sm text-gray-500 mb-4">Klik tombol "+" untuk memberikan poin kepada siswa yang menjawab pertanyaan atau aktif di kelas.</p>
                        <div id="student-points-list" class="space-y-3 max-h-[500px] overflow-y-auto pr-2">
                            <div class="text-center text-gray-400 py-10">Pilih kelas untuk memuat siswa.</div>
                        </div>
                    </div>
                    
                    <!-- Live Leaderboard Preview -->
                    <div class="bg-white p-6 rounded-2xl shadow-sm border border-gray-100">
                        <h3 class="font-bold text-lg mb-4 text-indigo-600"><i class="fa-solid fa-trophy mr-2"></i>Top Leaderboard</h3>
                        <div id="top-leaderboard-preview" class="space-y-4">
                            <!-- Top 5 Rendered Here -->
                        </div>
                    </div>
                </div>
            </div>

            <!-- Games & Ice Breaking -->
            <div id="t-games" class="sub-page animate__animated animate__fadeIn">
                <h1 class="text-2xl font-bold text-gray-800 mb-6">Game Center & Ice Breaking</h1>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <!-- Random Group Generator -->
                    <div class="bg-white p-6 rounded-2xl shadow-sm border border-gray-100 card-hover">
                        <div class="w-12 h-12 rounded-xl bg-purple-100 text-purple-600 flex items-center justify-center text-2xl mb-4"><i class="fa-solid fa-users-viewfinder"></i></div>
                        <h3 class="text-xl font-bold mb-2">Random Group Generator</h3>
                        <p class="text-gray-500 text-sm mb-4">Bagi siswa di kelas menjadi beberapa kelompok secara acak otomatis.</p>
                        <div class="flex gap-2 mb-4">
                            <select id="game-class-select" class="border rounded-lg px-3 py-2 text-sm flex-1">
                                <option value="">Pilih Kelas</option>
                            </select>
                            <input type="number" id="group-count" placeholder="Jml Kelompok" class="border rounded-lg px-3 py-2 w-24 text-sm">
                        </div>
                        <button onclick="generateRandomGroups()" class="w-full bg-purple-600 text-white py-2 rounded-xl hover:bg-purple-700 transition">Generate Groups</button>
                        <div id="group-result" class="mt-4 space-y-2 text-sm"></div>
                    </div>

                    <!-- Topic Spin -->
                    <div class="bg-white p-6 rounded-2xl shadow-sm border border-gray-100 card-hover">
                        <div class="w-12 h-12 rounded-xl bg-pink-100 text-pink-600 flex items-center justify-center text-2xl mb-4"><i class="fa-solid fa-spinner"></i></div>
                        <h3 class="text-xl font-bold mb-2">Topic Spinner</h3>
                        <p class="text-gray-500 text-sm mb-4">Dapatkan topik acak untuk Speaking / Discussion session.</p>
                        <div id="topic-display" class="bg-gray-50 border border-dashed border-gray-300 rounded-xl p-6 text-center font-bold text-gray-700 text-lg mb-4 min-h-[100px] flex items-center justify-center">
                            ?
                        </div>
                        <button onclick="spinTopic()" class="w-full bg-pink-500 text-white py-2 rounded-xl hover:bg-pink-600 transition">Putar Topik</button>
                    </div>
                </div>
            </div>
            
            <!-- Quiz & Feedback Placeholders (Simplified for this UI demo) -->
            <div id="t-quiz" class="sub-page animate__animated animate__fadeIn">
                 <h1 class="text-2xl font-bold text-gray-800 mb-6">Bank Soal & Kuis</h1>
                 <div class="bg-yellow-50 border border-yellow-200 p-4 rounded-xl text-yellow-800">
                     Fitur manajemen kuis masih menggunakan logika sistem lama, namun dengan tampilan baru yang terintegrasi di Dashboard ini. (Akses penuh fitur kuis ada di tombol "Buat Kuis Baru").
                 </div>
                 <button id="open-legacy-quiz-mgr" class="mt-4 bg-indigo-600 text-white px-6 py-2 rounded-xl">Buka Manajer Kuis</button>
            </div>

            <div id="t-feedback" class="sub-page animate__animated animate__fadeIn">
                <h1 class="text-2xl font-bold text-gray-800 mb-6">Feedback Siswa</h1>
                <div class="bg-white p-6 rounded-2xl shadow-sm mb-6">
                    <div class="flex justify-between items-center">
                        <h3 class="font-bold">Status Sesi Feedback: <span id="feedback-status-text" class="text-red-500">Tertutup</span></h3>
                        <button id="toggle-feedback-btn" class="bg-green-500 text-white px-4 py-2 rounded-xl hover:bg-green-600 transition">Buka Sesi Feedback</button>
                    </div>
                </div>
                <div id="feedback-list" class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <!-- Feedback cards -->
                </div>
            </div>
        </main>
    </div>

    <!-- ================= STUDENT DASHBOARD (MOBILE UI) ================= -->
    <div id="student-dashboard" class="page hidden min-h-screen pb-20 relative">
        <!-- Header Profile -->
        <div class="bg-white p-6 rounded-b-[30px] shadow-sm sticky top-0 z-40">
            <div class="flex justify-between items-center">
                <div class="flex items-center gap-3">
                    <div class="w-12 h-12 bg-studPrimary rounded-full border-4 border-white shadow-md flex items-center justify-center text-white font-bold text-xl">
                        <i class="fa-regular fa-face-smile"></i>
                    </div>
                    <div>
                        <h2 id="student-name-display" class="font-bold text-gray-800 text-lg font-fun">Hai, Siswa!</h2>
                        <p class="text-xs text-gray-500 bg-gray-100 px-2 py-1 rounded-full inline-block" id="student-class-display">Kelas: -</p>
                    </div>
                </div>
                <div class="text-right">
                    <div class="text-studPrimary font-bold text-2xl font-fun flex items-center gap-1 justify-end">
                        <i class="fa-solid fa-star text-yellow-400"></i> <span id="student-points-display">0</span>
                    </div>
                    <p class="text-xs text-gray-400">Total Poin</p>
                </div>
            </div>
        </div>

        <!-- Main Content Container -->
        <div class="p-5 space-y-6">
            
            <!-- Join Class (If no class) -->
            <div id="s-join-class-card" class="hidden bg-white p-6 rounded-3xl shadow-sm text-center">
                <img src="https://cdn-icons-png.flaticon.com/512/1903/1903172.png" class="w-24 mx-auto mb-4 floating" alt="Join">
                <h3 class="font-bold text-xl text-gray-800 font-fun mb-2">Belum punya kelas?</h3>
                <p class="text-sm text-gray-500 mb-4">Masukkan kode kelas dari Mam Yanti.</p>
                <input type="text" id="s-class-code" placeholder="KODE KELAS" class="w-full border-2 border-studBg rounded-xl px-4 py-3 text-center font-bold text-gray-600 uppercase tracking-widest mb-3 focus:outline-none focus:border-studPrimary">
                <button id="s-join-btn" class="w-full bg-studPrimary text-white py-3 rounded-xl font-bold shadow-md hover:bg-orange-500 transition">GABUNG!</button>
            </div>

            <!-- Menu: Home -->
            <div id="s-home" class="s-tab active">
                <!-- Live Quiz Card -->
                <div class="bg-gradient-to-r from-studSecondary to-teal-400 rounded-3xl p-6 text-white shadow-lg relative overflow-hidden card-hover mb-6">
                    <i class="fa-solid fa-gamepad absolute -right-4 -bottom-4 text-8xl text-white opacity-20"></i>
                    <h3 class="font-bold text-2xl font-fun mb-1">Kuis Live!</h3>
                    <p class="text-sm opacity-90 mb-4">Gabung sesi interaktif sekarang.</p>
                    <div class="bg-white/20 backdrop-blur-sm p-1 rounded-xl flex">
                        <input type="number" id="s-quiz-pin" placeholder="PIN" class="bg-transparent w-full px-3 text-white placeholder-white/70 font-bold focus:outline-none">
                        <button id="s-join-quiz-btn" class="bg-white text-teal-600 px-4 py-2 rounded-lg font-bold text-sm">GO</button>
                    </div>
                </div>

                <div class="grid grid-cols-2 gap-4">
                    <div onclick="studentNav('s-leaderboard')" class="bg-white p-4 rounded-2xl shadow-sm text-center card-hover cursor-pointer">
                        <div class="w-12 h-12 mx-auto bg-yellow-100 rounded-full flex items-center justify-center text-yellow-500 text-xl mb-2"><i class="fa-solid fa-trophy"></i></div>
                        <h4 class="font-bold text-gray-700 font-fun">Peringkat</h4>
                    </div>
                    <div onclick="showSuggestionModal()" class="bg-white p-4 rounded-2xl shadow-sm text-center card-hover cursor-pointer">
                        <div class="w-12 h-12 mx-auto bg-purple-100 rounded-full flex items-center justify-center text-purple-500 text-xl mb-2"><i class="fa-solid fa-lightbulb"></i></div>
                        <h4 class="font-bold text-gray-700 font-fun">Saran Materi</h4>
                    </div>
                </div>

                <!-- Assignments List -->
                <h3 class="font-bold text-gray-800 text-lg mt-6 mb-3 px-2 font-fun">Tugas Kamu</h3>
                <div id="s-task-list" class="space-y-3">
                    <!-- Tasks injected here -->
                    <div class="text-center text-gray-400 text-sm py-4">Memuat tugas...</div>
                </div>
            </div>

            <!-- Menu: Materials -->
            <div id="s-materials" class="s-tab hidden">
                <h2 class="text-2xl font-bold text-gray-800 mb-4 font-fun text-center">Materi Belajar</h2>
                <div id="s-material-list" class="space-y-4">
                    <!-- Materials Injected Here -->
                </div>
            </div>

             <!-- Menu: Leaderboard -->
             <div id="s-leaderboard" class="s-tab hidden">
                <h2 class="text-2xl font-bold text-gray-800 mb-4 font-fun text-center text-studPrimary">Kelas Juara</h2>
                <div class="bg-white rounded-3xl shadow-sm overflow-hidden p-4">
                    <div id="s-leaderboard-list" class="space-y-2">
                        <!-- Leaderboard items -->
                    </div>
                </div>
            </div>

            <!-- Menu: Profile/Settings -->
            <div id="s-profile" class="s-tab hidden text-center pt-10">
                <div class="w-24 h-24 bg-gray-200 rounded-full mx-auto mb-4 border-4 border-white shadow-lg flex items-center justify-center">
                     <i class="fa-solid fa-user text-4xl text-gray-400"></i>
                </div>
                <h2 class="text-xl font-bold text-gray-800" id="s-profile-name">Nama Siswa</h2>
                <p class="text-gray-500 text-sm" id="s-profile-email">email@gmail.com</p>
                
                <button id="student-logout-btn" class="mt-8 bg-red-100 text-red-500 px-8 py-3 rounded-xl font-bold hover:bg-red-200 transition w-full max-w-xs mx-auto">
                    <i class="fa-solid fa-power-off mr-2"></i> Keluar
                </button>
                <div class="mt-8 text-xs text-gray-400 font-fun">
                    Version 9.0 (Major Update)<br>
                    e-Learning by Mam Yanti
                </div>
            </div>

        </div>

        <!-- Bottom Nav -->
        <div class="bottom-nav">
            <div class="nav-item active" onclick="studentNav('s-home', this)">
                <i class="fa-solid fa-house-chimney"></i> Home
            </div>
            <div class="nav-item" onclick="studentNav('s-materials', this)">
                <i class="fa-solid fa-book-open"></i> Materi
            </div>
            <div class="nav-item" onclick="studentNav('s-leaderboard', this)">
                <i class="fa-solid fa-chart-simple"></i> Rank
            </div>
            <div class="nav-item" onclick="studentNav('s-profile', this)">
                <i class="fa-solid fa-user-gear"></i> Profil
            </div>
        </div>
    </div>
    
    <!-- Footer Branding -->
    <footer class="fixed bottom-1 right-2 text-[10px] text-gray-400 pointer-events-none z-[60] mix-blend-multiply">
        Web ini dibuat oleh MiAppsDeveloper 2025
    </footer>

    <!-- Firebase SDKs -->
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-firestore.js"></script>

    <script>
        // ================= FIREBASE CONFIG =================
        const firebaseConfig = {
            apiKey: "AIzaSyDpYabA0lb-0uh3Pe-URmeY7WxpIHj7c5Q",
            authDomain: "e-learning-mamyanti.firebaseapp.com",
            projectId: "e-learning-mamyanti",
            storageBucket: "e-learning-mamyanti.appspot.com",
            messagingSenderId: "198925356373",
            appId: "1:198925356373:web:754ae2355b925aa50333dc"
        };
        
        firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        const db = firebase.firestore();
        const TEACHER_EMAIL = "elearningmamyanti@gmail.com";

        // State Variables
        let currentUser = null;
        let userData = null;
        let unsubscribeSnapshot = null;

        // ================= AUTH LOGIC =================
        const loginBtn = document.getElementById('login-btn');
        const loginSpinner = document.getElementById('login-spinner');

        auth.onAuthStateChanged(async (user) => {
            if (user) {
                currentUser = user;
                loginBtn.classList.add('hidden');
                loginSpinner.classList.remove('hidden');
                
                // Check/Create User Doc
                const userRef = db.collection('users').doc(user.uid);
                const doc = await userRef.get();
                
                if (!doc.exists) {
                    const isTeacher = user.email.toLowerCase() === TEACHER_EMAIL;
                    await userRef.set({
                        name: user.displayName,
                        email: user.email,
                        role: isTeacher ? 'teacher' : 'student',
                        photo: user.photoURL,
                        points: 0, // New: Points System
                        classId: null
                    });
                }
                
                // Get freshest data
                userData = (await userRef.get()).data();
                
                // Route UI
                document.getElementById('login-page').classList.remove('active');
                if (userData.role === 'teacher') {
                    initTeacherDashboard();
                } else {
                    initStudentDashboard();
                }
            } else {
                currentUser = null;
                userData = null;
                document.body.className = ''; // Reset body class
                document.getElementById('login-page').classList.add('active');
                document.getElementById('teacher-dashboard').classList.remove('active');
                document.getElementById('student-dashboard').classList.remove('active');
                loginBtn.classList.remove('hidden');
                loginSpinner.classList.add('hidden');
            }
        });

        loginBtn.addEventListener('click', () => {
            const provider = new firebase.auth.GoogleAuthProvider();
            auth.signInWithPopup(provider).catch(err => Swal.fire('Error', err.message, 'error'));
        });

        // ================= TEACHER LOGIC (Landscape/Desktop) =================
        function initTeacherDashboard() {
            document.body.classList.add('teacher-mode');
            document.getElementById('teacher-dashboard').classList.add('active'); // Use flex instead of block for layout
            document.getElementById('teacher-dashboard').classList.remove('hidden');
            document.getElementById('current-date').innerText = new Date().toLocaleDateString('id-ID', { weekday: 'long', day: 'numeric', month: 'long', year: 'numeric' });

            loadTeacherStats();
            loadClassList();
            
            // Setup Nav
            window.teacherNav = (targetId) => {
                document.querySelectorAll('#teacher-dashboard main .sub-page').forEach(el => {
                    el.classList.remove('active');
                    el.classList.add('hidden');
                });
                const target = document.getElementById(targetId);
                target.classList.remove('hidden');
                target.classList.add('active');
                
                // Update button styles
                document.querySelectorAll('.t-nav-btn').forEach(btn => {
                    btn.classList.remove('bg-indigo-50', 'text-indigo-600');
                });
                event.currentTarget.classList.add('bg-indigo-50', 'text-indigo-600');

                // Load specific data
                if(targetId === 't-points') loadStudentsForPoints();
                if(targetId === 't-games') loadClassesForGames();
                if(targetId === 't-feedback') loadFeedbackList();
            };

            document.getElementById('teacher-logout-btn').onclick = () => auth.signOut();
            
            // Create Class Logic
            document.getElementById('create-class-btn').onclick = async () => {
                const name = document.getElementById('class-name-input').value;
                if(!name) return Swal.fire('Ops', 'Nama kelas wajib diisi', 'warning');
                const code = Math.random().toString(36).substring(2, 8).toUpperCase();
                await db.collection('classes').add({
                    name, code, teacherId: currentUser.uid, feedbackOpen: false 
                });
                document.getElementById('class-name-input').value = '';
                Swal.fire('Sukses', `Kelas ${name} dibuat. Kode: ${code}`, 'success');
                loadClassList();
            };

            // Setup Points Filter
            const pFilter = document.getElementById('points-class-filter');
            pFilter.addEventListener('change', () => loadStudentsForPoints(pFilter.value));
        }

        async function loadTeacherStats() {
            const snaps = await db.collection('users').where('role', '==', 'student').get();
            document.getElementById('stat-total-students').innerText = snaps.size;
            
            const tasks = await db.collection('assignments').where('teacherId', '==', currentUser.uid).get();
            document.getElementById('stat-active-tasks').innerText = tasks.size;
        }

        function loadClassList() {
            db.collection('classes').where('teacherId', '==', currentUser.uid).onSnapshot(snap => {
                const container = document.getElementById('class-list-container');
                const pFilter = document.getElementById('points-class-filter');
                const gFilter = document.getElementById('game-class-select');
                
                container.innerHTML = '';
                let opts = '<option value="">Pilih Kelas</option>';

                snap.forEach(doc => {
                    const d = doc.data();
                    opts += `<option value="${doc.id}">${d.name}</option>`;
                    
                    container.innerHTML += `
                    <div class="bg-white p-6 rounded-2xl shadow-sm border-l-4 border-indigo-500 relative overflow-hidden">
                        <div class="flex justify-between items-start">
                            <div>
                                <h3 class="font-bold text-lg">${d.name}</h3>
                                <p class="text-gray-500 text-sm">Kode: <span class="font-mono font-bold bg-gray-100 px-2 py-1 rounded">${d.code}</span></p>
                            </div>
                            <div class="bg-indigo-50 text-indigo-600 w-10 h-10 rounded-full flex items-center justify-center">
                                <i class="fa-solid fa-users"></i>
                            </div>
                        </div>
                        <button onclick="deleteClass('${doc.id}')" class="text-xs text-red-400 mt-4 hover:text-red-600">Hapus Kelas</button>
                    </div>`;
                });
                pFilter.innerHTML = opts;
                gFilter.innerHTML = opts;
            });
        }

        // --- POINTS SYSTEM (MANUAL) ---
        async function loadStudentsForPoints(classId = null) {
            const list = document.getElementById('student-points-list');
            list.innerHTML = '<div class="text-center py-4"><div class="animate-spin inline-block w-6 h-6 border-2 border-indigo-600 border-t-transparent rounded-full"></div></div>';
            
            let query = db.collection('users').where('role', '==', 'student');
            if(classId) query = query.where('classId', '==', classId);
            
            const snap = await query.get();
            list.innerHTML = '';
            
            if(snap.empty) {
                list.innerHTML = '<p class="text-center text-gray-400">Tidak ada siswa.</p>';
                return;
            }

            snap.forEach(doc => {
                const d = doc.data();
                list.innerHTML += `
                <div class="flex items-center justify-between bg-gray-50 p-3 rounded-xl">
                    <div class="flex items-center gap-3">
                        <div class="w-8 h-8 bg-white rounded-full flex items-center justify-center font-bold text-indigo-600 border">${d.name[0]}</div>
                        <div>
                            <p class="font-bold text-sm text-gray-800">${d.name}</p>
                            <p class="text-xs text-gray-500 points-val" id="pt-${doc.id}">${d.points || 0} Poin</p>
                        </div>
                    </div>
                    <div class="flex gap-2">
                        <button onclick="updatePoints('${doc.id}', 5)" class="bg-green-100 text-green-600 w-8 h-8 rounded-lg hover:bg-green-200 font-bold text-sm">+5</button>
                        <button onclick="updatePoints('${doc.id}', 10)" class="bg-indigo-100 text-indigo-600 w-8 h-8 rounded-lg hover:bg-indigo-200 font-bold text-sm">+10</button>
                    </div>
                </div>`;
            });
            
            updateLeaderboardPreview(classId);
        }

        async function updatePoints(uid, amount) {
            const ref = db.collection('users').doc(uid);
            await db.runTransaction(async (t) => {
                const doc = await t.get(ref);
                const newPoints = (doc.data().points || 0) + amount;
                t.update(ref, { points: newPoints });
            });
            // UI update handled by refresh or reactivity, simple alert for now
            const el = document.getElementById(`pt-${uid}`);
            if(el) {
                const current = parseInt(el.innerText);
                el.innerText = (current + amount) + " Poin";
                el.classList.add('text-green-600', 'font-bold');
                setTimeout(()=> el.classList.remove('text-green-600', 'font-bold'), 1000);
            }
        }

        async function updateLeaderboardPreview(classId) {
            const preview = document.getElementById('top-leaderboard-preview');
            let query = db.collection('users').where('role', '==', 'student').orderBy('points', 'desc').limit(5);
            if(classId) query = db.collection('users').where('role', '==', 'student').where('classId', '==', classId).orderBy('points', 'desc').limit(5);
            
            const snap = await query.get();
            preview.innerHTML = '';
            let rank = 1;
            snap.forEach(doc => {
                const d = doc.data();
                let icon = rank === 1 ? 'ðŸ¥‡' : (rank === 2 ? 'ðŸ¥ˆ' : (rank === 3 ? 'ðŸ¥‰' : `#${rank}`));
                preview.innerHTML += `
                <div class="flex justify-between items-center border-b pb-2">
                    <div class="flex items-center gap-2">
                        <span class="text-xl">${icon}</span>
                        <span class="font-medium text-gray-700">${d.name}</span>
                    </div>
                    <span class="font-bold text-indigo-600">${d.points || 0}</span>
                </div>`;
                rank++;
            });
        }

        // --- GAME CENTER ---
        function loadClassesForGames() {
           // Already handled by class list listener filling #game-class-select
        }

        async function generateRandomGroups() {
            const classId = document.getElementById('game-class-select').value;
            const count = parseInt(document.getElementById('group-count').value);
            const resDiv = document.getElementById('group-result');
            
            if(!classId || !count) return Swal.fire('Info', 'Pilih kelas dan jumlah kelompok', 'info');
            
            resDiv.innerHTML = 'Mengacak...';
            
            const snap = await db.collection('users').where('classId', '==', classId).where('role', '==', 'student').get();
            let students = [];
            snap.forEach(d => students.push(d.data().name));
            
            if(students.length === 0) {
                resDiv.innerHTML = 'Tidak ada siswa di kelas ini.';
                return;
            }

            // Shuffle (Fisher-Yates)
            for (let i = students.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [students[i], students[j]] = [students[j], students[i]];
            }

            // Chunk
            const groups = Array.from({ length: count }, () => []);
            students.forEach((student, index) => {
                groups[index % count].push(student);
            });

            let html = '';
            groups.forEach((g, i) => {
                html += `<div class="bg-gray-50 p-2 rounded border mb-2"><strong>Kelompok ${i+1}:</strong> ${g.join(', ')}</div>`;
            });
            resDiv.innerHTML = html;
        }

        const topics = ["Holiday Plan", "My Favorite Movie", "Future Dream Job", "Most Embarrassing Moment", "Social Media Pros/Cons", "If I had 1 Billion Rupiah", "My Hero", "Online Learning vs Offline"];
        function spinTopic() {
            const display = document.getElementById('topic-display');
            let i = 0;
            const interval = setInterval(() => {
                display.innerText = topics[Math.floor(Math.random() * topics.length)];
                i++;
                if(i > 15) {
                    clearInterval(interval);
                    display.classList.add('text-pink-600', 'scale-110');
                    setTimeout(()=>display.classList.remove('text-pink-600', 'scale-110'), 500);
                }
            }, 100);
        }

        // --- FEEDBACK SYSTEM ---
        async function requestFeedbackGlobal() {
            // Simple implementation: Toggle a global config or update all classes
            // For simplicity, let's update a field in the first class found for demonstration or create a 'config' collection
            Swal.fire({
                title: 'Minta Feedback?',
                text: 'Notifikasi popup akan muncul di layar siswa yang sedang online.',
                icon: 'question',
                showCancelButton: true,
                confirmButtonText: 'Ya, Minta Feedback'
            }).then(async (result) => {
                if (result.isConfirmed) {
                    await db.collection('globalState').doc('feedback').set({
                        active: true,
                        timestamp: firebase.firestore.FieldValue.serverTimestamp()
                    });
                    Swal.fire('Terkirim!', 'Siswa sekarang melihat form feedback.', 'success');
                }
            });
        }
        
        // Listen for feedback in teacher dashboard
        function loadFeedbackList() {
             db.collection('feedbacks').orderBy('timestamp', 'desc').limit(20).onSnapshot(snap => {
                 const div = document.getElementById('feedback-list');
                 div.innerHTML = '';
                 snap.forEach(doc => {
                     const d = doc.data();
                     div.innerHTML += `
                     <div class="bg-white p-4 rounded-xl border shadow-sm">
                        <p class="text-sm font-bold text-gray-800 mb-1">" ${d.message} "</p>
                        <p class="text-xs text-gray-500 text-right">- ${d.studentName || 'Anonim'}</p>
                     </div>`;
                 });
             });
        }

        // ================= STUDENT LOGIC (Mobile/Portrait) =================
        function initStudentDashboard() {
            document.body.classList.add('student-mode');
            document.getElementById('student-dashboard').classList.add('active');
            document.getElementById('student-dashboard').classList.remove('hidden');

            // Update Profile UI
            document.getElementById('student-name-display').innerText = `Hai, ${userData.name.split(' ')[0]}!`;
            document.getElementById('student-class-display').innerText = userData.className ? `Kelas: ${userData.className}` : 'Belum ada kelas';
            document.getElementById('student-points-display').innerText = userData.points || 0;
            
            // Profile Tab
            document.getElementById('s-profile-name').innerText = userData.name;
            document.getElementById('s-profile-email').innerText = userData.email;

            if(!userData.classId) {
                document.getElementById('s-join-class-card').classList.remove('hidden');
            } else {
                loadStudentTasks();
                loadStudentMaterials();
                loadStudentLeaderboard();
                listenForFeedbackRequest();
            }

            // Nav Logic
            window.studentNav = (targetId, el) => {
                document.querySelectorAll('.s-tab').forEach(d => d.classList.add('hidden'));
                document.getElementById(targetId).classList.remove('hidden');
                document.getElementById(targetId).classList.add('animate__animated', 'animate__fadeIn');

                if(el) {
                    document.querySelectorAll('.nav-item').forEach(i => i.classList.remove('active'));
                    el.classList.add('active');
                }
            };

            document.getElementById('student-logout-btn').onclick = () => auth.signOut();
            document.getElementById('s-join-btn').onclick = joinClassStudent;
        }

        async function joinClassStudent() {
            const code = document.getElementById('s-class-code').value.toUpperCase();
            if(!code) return;
            
            const snaps = await db.collection('classes').where('code', '==', code).get();
            if(snaps.empty) return Swal.fire('Gagal', 'Kode kelas tidak ditemukan', 'error');
            
            const classDoc = snaps.docs[0];
            await db.collection('users').doc(currentUser.uid).update({
                classId: classDoc.id,
                className: classDoc.data().name
            });
            location.reload();
        }

        function loadStudentTasks() {
            db.collection('assignments').where('classId', '==', userData.classId).onSnapshot(snap => {
                const div = document.getElementById('s-task-list');
                if(snap.empty) { div.innerHTML = '<div class="text-center text-gray-500 text-sm italic py-4">Tidak ada tugas aktif. Asik! ðŸŽ‰</div>'; return; }
                
                let html = '';
                snap.forEach(doc => {
                    const d = doc.data();
                    html += `
                    <div class="bg-white p-4 rounded-2xl shadow-sm flex justify-between items-center border-l-4 border-studSecondary">
                        <div>
                            <h4 class="font-bold text-gray-800">${d.title}</h4>
                            <p class="text-xs text-gray-500">Deadline: ${new Date(d.deadline.toDate()).toLocaleDateString()}</p>
                        </div>
                        <button class="bg-studSecondary text-white px-3 py-1 rounded-lg text-xs font-bold shadow-sm">Kirim</button>
                    </div>`;
                });
                div.innerHTML = html;
            });
        }
        
        function loadStudentMaterials() {
             // Fake data structure since upload logic wasn't requested in detail update, assuming 'materials' collection
             const div = document.getElementById('s-material-list');
             db.collection('materials').where('classId', '==', userData.classId).limit(5).onSnapshot(snap => {
                 if(snap.empty) { div.innerHTML = '<p class="text-center text-gray-400">Belum ada materi.</p>'; return; }
                 div.innerHTML = '';
                 snap.forEach(doc => {
                     const d = doc.data();
                     div.innerHTML += `
                     <a href="${d.url}" target="_blank" class="block bg-white p-4 rounded-2xl shadow-sm mb-3 flex items-center gap-3 card-hover">
                         <div class="w-10 h-10 bg-red-100 rounded-lg flex items-center justify-center text-red-500"><i class="fa-solid fa-file-pdf"></i></div>
                         <span class="font-bold text-gray-700">${d.name}</span>
                     </a>`;
                 });
             });
        }

        async function loadStudentLeaderboard() {
            const div = document.getElementById('s-leaderboard-list');
            const snap = await db.collection('users').where('classId', '==', userData.classId).orderBy('points', 'desc').limit(10).get();
            
            let rank = 1;
            div.innerHTML = '';
            snap.forEach(doc => {
                const d = doc.data();
                const isMe = doc.id === currentUser.uid;
                div.innerHTML += `
                <div class="flex items-center justify-between p-3 ${isMe ? 'bg-yellow-50 border border-yellow-200 rounded-xl' : 'border-b last:border-0'}">
                    <div class="flex items-center gap-3">
                        <div class="font-bold w-6 text-gray-400">#${rank}</div>
                        <div class="font-bold ${isMe ? 'text-studPrimary' : 'text-gray-700'}">${d.name} ${isMe ? '(Kamu)' : ''}</div>
                    </div>
                    <div class="font-bold text-gray-600">${d.points || 0} pts</div>
                </div>`;
                rank++;
            });
        }
        
        function listenForFeedbackRequest() {
            db.collection('globalState').doc('feedback').onSnapshot(doc => {
                if(doc.exists && doc.data().active) {
                    // Only show if updated recently (simple logic) or trigger once
                    // Check local storage to avoid double popup
                    const lastCheck = localStorage.getItem('lastFeedback');
                    const serverTime = doc.data().timestamp?.toMillis() || 0;
                    
                    if(serverTime > (lastCheck || 0)) {
                        Swal.fire({
                            title: 'Gimana pelajaran hari ini?',
                            input: 'textarea',
                            inputLabel: 'Feedback untuk Mam Yanti',
                            inputPlaceholder: 'Seru banget mam! tapi...',
                            confirmButtonText: 'Kirim',
                            confirmButtonColor: '#FF9F1C',
                            showCancelButton: true
                        }).then(async (res) => {
                            if(res.isConfirmed && res.value) {
                                await db.collection('feedbacks').add({
                                    message: res.value,
                                    studentId: currentUser.uid,
                                    studentName: userData.name,
                                    timestamp: firebase.firestore.FieldValue.serverTimestamp()
                                });
                                localStorage.setItem('lastFeedback', Date.now());
                                Swal.fire('Thanks!', 'Feedback terkirim +2 Poin!', 'success');
                                // Give auto points
                                updatePoints(currentUser.uid, 2);
                            }
                        });
                    }
                }
            });
        }

        window.showSuggestionModal = () => {
            Swal.fire({
                title: 'Saran Materi Minggu Depan?',
                input: 'text',
                inputPlaceholder: 'Misal: Belajar Slang Words dong mam...',
                confirmButtonText: 'Kirim Saran',
                confirmButtonColor: '#2EC4B6'
            }).then(async (res) => {
                if(res.isConfirmed && res.value) {
                    await db.collection('feedbacks').add({
                         message: "[SARAN] " + res.value,
                         studentName: userData.name,
                         timestamp: firebase.firestore.FieldValue.serverTimestamp()
                    });
                    Swal.fire('Siap!', 'Saranmu sudah dicatat Mam Yanti.', 'success');
                }
            });
        };
    </script>
</body>
</html>