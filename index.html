<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>e-Learning English by Mam Yanti</title>
    
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600;700&display=swap" rel="stylesheet">
    
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <style>
        /* CSS Reset and Base Styles */
        :root {
            --primary-color: #4A90E2;
            --secondary-color: #50E3C2;
            --text-color: #4A4A4A;
            --bg-color: #F7F9FC;
            --card-bg: #FFFFFF;
            --border-color: #EAEAEA;
        }

        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }

        body {
            font-family: 'Poppins', sans-serif;
            background-color: var(--bg-color);
            color: var(--text-color);
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            -webkit-tap-highlight-color: transparent; /* Good for mobile */
        }

        /* App Container for Mobile View */
        #app-container {
            width: 100%;
            max-width: 480px; /* Portrait mobile screen width */
            height: 100vh;
            background-color: var(--card-bg);
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.05);
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }
        
        /* General Page Styling */
        .page {
            flex-grow: 1;
            overflow-y: auto;
            padding: 25px;
            display: none; /* Hide all pages by default */
        }
        .page.active {
            display: block;
        }

        /* --- Login Page --- */
        #login-page {
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            text-align: center;
            background: linear-gradient(180deg, var(--primary-color) 0%, var(--secondary-color) 100%);
        }

        .login-card {
            background: var(--card-bg);
            padding: 40px 30px;
            border-radius: 20px;
            width: 90%;
            box-shadow: 0 10px 30px rgba(0,0,0,0.1);
        }

        .login-card h1 {
            color: var(--primary-color);
            font-weight: 700;
            font-size: 1.8em;
        }

        .login-card h2 {
            font-weight: 400;
            font-size: 1.2em;
            margin-bottom: 25px;
        }

        .login-card p {
            font-size: 0.9em;
            margin-bottom: 25px;
        }

        /* General UI Components */
        button {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
            width: 100%;
            padding: 12px 20px;
            border-radius: 12px;
            font-size: 1em;
            font-family: 'Poppins', sans-serif;
            cursor: pointer;
            transition: all 0.2s ease;
            border: none;
            font-weight: 500;
        }

        button.primary {
            background-color: var(--primary-color);
            color: white;
        }
        button.primary:hover {
            background-color: #3a7bc8;
        }
        
        button#login-btn {
            background-color: #fff;
            color: var(--text-color);
            border: 1px solid var(--border-color);
        }
        button#login-btn:hover {
            background-color: #f5f5f5;
        }

        button img { width: 22px; }

        input, textarea, select {
            width: 100%;
            padding: 12px;
            border-radius: 10px;
            border: 1px solid var(--border-color);
            margin-bottom: 15px;
            font-family: 'Poppins', sans-serif;
            font-size: 1em;
            background-color: #fdfdfd;
        }
        textarea { resize: vertical; }

        /* --- Dashboard Styles --- */
        .header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 25px;
        }

        .header h1 {
            font-size: 1.5em;
            font-weight: 600;
        }
        
        .logout-btn {
            background: none;
            border: none;
            color: var(--primary-color);
            font-size: 1.5em;
            cursor: pointer;
            width: auto;
            padding: 5px;
        }

        .feature-card {
            background: var(--card-bg);
            border: 1px solid var(--border-color);
            border-radius: 15px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.03);
        }
        
        .feature-card h3 {
            margin-bottom: 15px;
            font-size: 1.1em;
            font-weight: 600;
            border-bottom: 1px solid var(--border-color);
            padding-bottom: 10px;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        /* Content List Styles */
        .content-list {
            max-height: 250px;
            overflow-y: auto;
        }
        
        .content-item {
            padding: 15px 5px;
            border-bottom: 1px solid var(--border-color);
        }
        .content-item:last-child {
            border-bottom: none;
        }

        .content-item strong {
            display: block;
            margin-bottom: 5px;
            color: var(--primary-color);
        }
        
        .content-item p {
            font-size: 0.95em;
            line-height: 1.5;
            white-space: pre-wrap; /* Agar baris baru di pengumuman terlihat */
        }
        
        .content-item small {
            font-size: 0.8em;
            color: #9B9B9B;
        }
        
        /* Spinner/Loading Indicator */
        .spinner-container {
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 20px;
        }
        .spinner {
            border: 4px solid rgba(0, 0, 0, 0.1);
            width: 36px;
            height: 36px;
            border-radius: 50%;
            border-left-color: var(--primary-color);
            animation: spin 1s ease infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body>

    <div id="app-container">

        <div id="login-page" class="page active">
            <div class="login-card">
                <h1>e-Learning English</h1>
                <h2>by Mam Yanti</h2>
                <p>Silakan masuk dengan Akun Google Anda untuk memulai pembelajaran.</p>
                <button id="login-btn">
                    <img src="https://developers.google.com/identity/images/g-logo.png" alt="Google Logo">
                    <span>Masuk dengan Google</span>
                </button>
                <div class="spinner-container" style="display: none;" id="login-spinner">
                    <div class="spinner"></div>
                </div>
            </div>
        </div>

        <div id="teacher-dashboard-page" class="page">
            <div class="header">
                <h1 id="teacher-welcome">Hai, Mam Yanti!</h1>
                <button class="logout-btn" id="teacher-logout-btn" title="Keluar"><i class="fa-solid fa-right-from-bracket"></i></button>
            </div>
            
            <div class="feature-card">
                <h3><i class="fa-solid fa-bullhorn"></i> Buat Pengumuman</h3>
                <input type="text" id="announcement-title" placeholder="Judul Pengumuman">
                <textarea id="announcement-content" rows="3" placeholder="Isi pengumuman..."></textarea>
                <select id="announcement-class">
                    <option value="">-- Pilih Kelas --</option>
                    <optgroup label="Kelas XII">
                        <option value="XII-1">XII-1</option> <option value="XII-2">XII-2</option> <option value="XII-3">XII-3</option> <option value="XII-4">XII-4</option>
                        <option value="XII-5">XII-5</option> <option value="XII-6">XII-6</option <option value="XII-7">XII-7</option> <option value="XII-8">XII-8</option>
                    </optgroup>
                    <optgroup label="Kelas XI">
                        <option value="XI-5">XI-5</option> <option value="XI-6">XI-6</option> <option value="XI-7">XI-7</option>
                        <option value="XI-8">XI-8</option> <option value="XI-9">XI-9</option> <option value="XI-10">XI-10</option>
                    </optgroup>
                    <option value="SEMUA KELAS">SEMUA KELAS</option>
                </select>
                <button class="primary" id="publish-announcement-btn">Publikasikan</button>
            </div>

            <div class="feature-card">
                <h3><i class="fa-solid fa-cloud-arrow-up"></i> Upload Materi</h3>
                 <select id="material-class-target">
                    <option value="">-- Pilih Kelas untuk Materi --</option>
                    <optgroup label="Kelas XII">
                        <option value="XII-1">XII-1</option> <option value="XII-2">XII-2</option> <option value="XII-3">XII-3</option> <option value="XII-4">XII-4</option>
                        <option value="XII-5">XII-5</option> <option value="XII-6">XII-6</option> <option value="XII-7">XII-7</option> <option value="XII-8">XII-8</option>
                    </optgroup>
                    <optgroup label="Kelas XI">
                        <option value="XI-5">XI-5</option> <option value="XI-6">XI-6</option> <option value="XI-7">XI-7</option>
                        <option value="XI-8">XI-8</option> <option value="XI-9">XI-9</option> <option value="XI-10">XI-10</option>
                    </optgroup>
                    <option value="SEMUA KELAS">SEMUA KELAS</option>
                </select>
                <button id="upload-material-btn"><i class="fa-brands fa-google-drive"></i> Pilih File dari Google Drive</button>
                <p id="upload-status" style="text-align: center; margin-top: 10px; font-size: 0.9em;"></p>
            </div>
            
            <div class="feature-card">
                <h3><i class="fa-solid fa-clipboard-user"></i> Rekap Absensi Otomatis</h3>
                <textarea id="attendance-input" rows="5" placeholder="Tempel daftar absensi di sini.&#10;Format: no.absen_kelas_namalengkap&#10;Contoh: 1_XII-1_Budi Setiawan"></textarea>
                <button class="primary" id="process-attendance-btn">Proses Absensi Hari Ini</button>
            </div>

            <div class="feature-card"><h3><i class="fa-solid fa-file-circle-question"></i> Buat Kuis (Segera Hadir)</h3></div>
            <div class="feature-card"><h3><i class="fa-solid fa-list-check"></i> Periksa Tugas (Segera Hadir)</h3></div>
        </div>

        <div id="student-dashboard-page" class="page">
            <div class="header">
                 <h1 id="student-welcome">Selamat Datang!</h1>
                 <button class="logout-btn" id="student-logout-btn" title="Keluar"><i class="fa-solid fa-right-from-bracket"></i></button>
            </div>
            
            <div id="student-class-selector" style="display:none;" class="feature-card">
                <h3>Pilih Kelas Anda</h3>
                <p>Untuk melihat materi dan pengumuman, silakan pilih kelas Anda terlebih dahulu.</p>
                <select id="student-class-options">
                    <option value="">-- Pilih Kelas --</option>
                    <optgroup label="Kelas XII">
                        <option value="XII-1">XII-1</option> <option value="XII-2">XII-2</option> <option value="XII-3">XII-3</option> <option value="XII-4">XII-4</option>
                        <option value="XII-5">XII-5</option> <option value="XII-6">XII-6</option> <option value="XII-7">XII-7</option> <option value="XII-8">XII-8</option>
                    </optgroup>
                    <optgroup label="Kelas XI">
                        <option value="XI-5">XI-5</option> <option value="XI-6">XI-6</option> <option value="XI-7">XI-7</option>
                        <option value="XI-8">XI-8</option> <option value="XI-9">XI-9</option> <option value="XI-10">XI-10</option>
                    </optgroup>
                </select>
                <button class="primary" id="save-class-btn">Simpan Kelas</button>
            </div>

            <div id="student-main-content" style="display:none;">
                 <div class="feature-card">
                    <h3><i class="fa-solid fa-bullhorn"></i> Pengumuman</h3>
                    <div id="announcement-list" class="content-list">
                        <div class="spinner-container"><div class="spinner"></div></div>
                    </div>
                </div>
                 <div class="feature-card">
                    <h3><i class="fa-solid fa-book-open"></i> Materi Belajar</h3>
                    <div id="material-list" class="content-list">
                         <div class="spinner-container"><div class="spinner"></div></div>
                    </div>
                </div>
                 <div class="feature-card"><h3><i class="fa-solid fa-pen-to-square"></i> Upload Tugas (Segera Hadir)</h3></div>
                <div class="feature-card"><h3><i class="fa-solid fa-comments"></i> Chat Kelas (Segera Hadir)</h3></div>
            </div>
        </div>

    </div> <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-firestore.js"></script>
    
    <script src="https://apis.google.com/js/api.js"></script>
    <script src="https://accounts.google.com/gsi/client"></script>

    <script type="module">
        // =================================================================
        // == KONFIGURASI KUNCI API (SESUAI DATA ANDA) ==
        // =================================================================
        const firebaseConfig = {
            apiKey: "AIzaSyDpYabA0lb-0uh3Pe-URmeY7WxpIHj7c5Q",
            authDomain: "e-learning-mamyanti.firebaseapp.com",
            projectId: "e-learning-mamyanti",
            storageBucket: "e-learning-mamyanti.firebasestorage.app",
            messagingSenderId: "198925356373",
            appId: "1:198925356373:web:754ae2355b925aa50333dc"
        };
        
        // Kunci API dari Google Cloud Console
        const GOOGLE_API_KEY = "AIzaSyBJ9yRe5AYOJGiYwAqlm5wK1La3LhhuS5A";
        
        // ===== CLIENT ID BARU KAMU SUDAH DIMASUKKAN DI SINI =====
        const GOOGLE_CLIENT_ID = "198925356373-mb0ame0q1sh3elqlq4mofgdakn8df9jh.apps.googleusercontent.com";
        
        // APP_ID adalah bagian angka sebelum tanda strip
        const APP_ID = "198925356373"; 
        
        // === INI ADALAH KUNCI PEMBEDA GURU DAN SISWA ===
        const TEACHER_EMAIL = "elearningmamyanti@gmail.com";
        // =================================================================

        // Initialize Firebase and services
        firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        const db = firebase.firestore();

        // DOM Elements
        const pages = document.querySelectorAll('.page');
        const loginBtn = document.getElementById('login-btn');
        const loginSpinner = document.getElementById('login-spinner');
        
        // --- Page Navigation ---
        function showPage(pageId) {
            pages.forEach(page => {
                page.classList.remove('active');
            });
            document.getElementById(pageId).classList.add('active');
        }

        // --- Authentication ---
        auth.onAuthStateChanged(async (user) => {
            if (user) {
                // User sudah login, tampilkan spinner selagi memeriksa role
                loginBtn.style.display = 'none';
                loginSpinner.style.display = 'flex';
                showPage('login-page'); // Tetap di login page dulu
                await handleUserLogin(user);
            } else {
                // User belum login, tampilkan tombol login
                 showPage('login-page');
                 loginBtn.style.display = 'inline-flex';
                 loginSpinner.style.display = 'none';
            }
        });
        
        loginBtn.addEventListener('click', () => {
            loginBtn.style.display = 'none';
            loginSpinner.style.display = 'flex';
            const provider = new firebase.auth.GoogleAuthProvider();
            auth.signInWithPopup(provider).catch(error => {
                console.error("Login error:", error);
                alert("Gagal masuk. Silakan coba lagi.");
                loginBtn.style.display = 'inline-flex';
                loginSpinner.style.display = 'none';
            });
        });

        async function handleUserLogin(user) {
            const userRef = db.collection('users').doc(user.uid);
            const userDoc = await userRef.get();

            // === INI LOGIKA UTAMANYA ===
            // 1. Cek apakah email yang login adalah email GURU
            if (user.email.toLowerCase() === TEACHER_EMAIL.toLowerCase()) {
                if (!userDoc.exists) {
                    await userRef.set({
                        name: user.displayName,
                        email: user.email,
                        role: 'teacher'
                    }, { merge: true });
                }
                initializeTeacherDashboard(user);
            } else {
                // 2. Jika bukan, dia adalah SISWA
                 if (!userDoc.exists) {
                    await userRef.set({
                        name: user.displayName,
                        email: user.email,
                        role: 'student',
                        class: null // Kelas belum dipilih
                    }, { merge: true });
                }
                const userData = (await userRef.get()).data();
                initializeStudentDashboard(user, userData);
            }
        }
        
        // --- Logout Function ---
        function setupLogout(buttonId) {
             document.getElementById(buttonId).addEventListener('click', () => {
                if (confirm('Apakah Anda yakin ingin keluar?')) {
                     auth.signOut();
                }
             });
        }
        
        // =================================================================
        // == TEACHER DASHBOARD LOGIC
        // =================================================================
        function initializeTeacherDashboard(user) {
            setupLogout('teacher-logout-btn');
            
            const publishBtn = document.getElementById('publish-announcement-btn');
            const attendanceBtn = document.getElementById('process-attendance-btn');
            
            // Hapus event listener lama agar tidak duplikat
            publishBtn.replaceWith(publishBtn.cloneNode(true));
            attendanceBtn.replaceWith(attendanceBtn.cloneNode(true));
            document.getElementById('upload-material-btn').replaceWith(document.getElementById('upload-material-btn').cloneNode(true));

            // Tambah event listener baru
            document.getElementById('publish-announcement-btn').addEventListener('click', publishAnnouncement);
            document.getElementById('process-attendance-btn').addEventListener('click', processAttendance);
            
            // Initialize Google Drive Picker
            const uploadBtn = document.getElementById('upload-material-btn');
            uploadBtn.addEventListener('click', () => {
                const targetClass = document.getElementById('material-class-target').value;
                if (!targetClass) {
                    alert("Harap pilih kelas tujuan untuk materi ini.");
                    return;
                }
                // Load API Google
                gapi.load('client:picker', () => {
                    gisLoaded(targetClass); // Mulai proses auth & picker
                });
            });

            showPage('teacher-dashboard-page');
        }

        async function publishAnnouncement() {
            const title = document.getElementById('announcement-title').value.trim();
            const content = document.getElementById('announcement-content').value.trim();
            const targetClass = document.getElementById('announcement-class').value;

            if (!title || !content || !targetClass) {
                alert('Harap isi semua kolom pengumuman.');
                return;
            }

            try {
                await db.collection('announcements').add({
                    title,
                    content,
                    targetClass,
                    createdAt: firebase.firestore.FieldValue.serverTimestamp()
                });
                alert('Pengumuman berhasil dipublikasikan!');
                document.getElementById('announcement-title').value = '';
                document.getElementById('announcement-content').value = '';
                document.getElementById('announcement-class').value = '';
            } catch (error) {
                console.error("Error publishing announcement: ", error);
                alert('Gagal mempublikasikan pengumuman.');
            }
        }
        
        async function processAttendance() {
            const input = document.getElementById('attendance-input').value.trim();
            if (!input) {
                alert("Area absensi masih kosong.");
                return;
            }
            const lines = input.split('\n');
            const dateStr = new Date().toISOString().slice(0, 10); // YYYY-MM-DD
            
            const batch = db.batch();
            let successCount = 0;
            let errorCount = 0;
            
            lines.forEach(line => {
                const parts = line.split('_');
                // Pastikan formatnya benar: no_kelas_nama
                if (parts.length >= 3) { 
                    const [absen, kelas, ...namaParts] = parts;
                    const nama = namaParts.join(' '); // Gabungkan nama jika ada underscore di nama
                    
                    const attendanceRef = db.collection('attendance').doc(dateStr)
                                          .collection(kelas.trim()).doc(nama.trim());
                    batch.set(attendanceRef, {
                        nomorAbsen: absen.trim(),
                        nama: nama.trim(),
                        kelas: kelas.trim(),
                        timestamp: new Date()
                    });
                    successCount++;
                } else if (line.trim() !== '') {
                    errorCount++;
                }
            });
            
            try {
                await batch.commit();
                let message = `${successCount} data absensi berhasil direkap untuk tanggal ${dateStr}.`;
                if (errorCount > 0) {
                    message += `\n${errorCount} baris tidak dapat diproses (format salah).`;
                }
                alert(message);
                document.getElementById('attendance-input').value = '';
            } catch (error) {
                console.error("Error processing attendance: ", error);
                alert("Gagal memproses absensi.");
            }
        }
        
        // --- Google Drive Picker Logic (Teacher) ---
        let tokenClient;

        function gisLoaded(targetClass) {
            tokenClient = google.accounts.oauth2.initTokenClient({
                client_id: GOOGLE_CLIENT_ID,
                scope: 'https://www.googleapis.com/auth/drive.readonly',
                callback: (tokenResponse) => {
                     // Ini adalah callback setelah user setuju (consent)
                     if (tokenResponse.error) {
                        console.error('Error getting token:', tokenResponse.error);
                        alert('Gagal mendapatkan izin Google Drive.');
                        return;
                     }
                     // Langsung panggil gapi.client.init dan createPicker
                     initializePicker(tokenResponse.access_token, targetClass);
                },
            });
            
            // Minta akses token
            tokenClient.requestAccessToken({prompt: 'consent'});
        }
        
        async function initializePicker(accessToken, targetClass) {
            try {
                // Inisialisasi gapi.client dengan API Key
                await gapi.client.init({
                    apiKey: GOOGLE_API_KEY,
                });
                
                // Set access token untuk sesi ini
                gapi.client.setToken({ access_token: accessToken });

                document.getElementById('upload-status').innerText = 'Membuka pemilih file...';
                createPicker(accessToken, targetClass);
            } catch (err) {
                 console.error("Error initializing GAPI client: ", err);
                 alert('Error inisialisasi Google API. Coba lagi.');
                 document.getElementById('upload-status').innerText = 'Gagal memuat.';
            }
        }

        function createPicker(token, targetClass) {
            const view = new google.picker.View(google.picker.ViewId.DOCS);
            // Hanya izinkan file yang umum untuk materi
            view.setMimeTypes("application/pdf,application/vnd.google-apps.presentation,application/vnd.google-apps.document,application/vnd.openxmlformats-officedocument.wordprocessingml.document,application/vnd.openxmlformats-officedocument.presentationml.presentation");
            
            const picker = new google.picker.PickerBuilder()
                .enableFeature(google.picker.Feature.NAV_HIDDEN)
                .setAppId(APP_ID)
                .setOAuthToken(token)
                .addView(view)
                .addView(new google.picker.DocsUploadView()) // Izinkan upload juga
                .setDeveloperKey(GOOGLE_API_KEY)
                .setCallback((data) => pickerCallback(data, targetClass))
                .build();
            picker.setVisible(true);
        }

        async function pickerCallback(data, targetClass) {
            if (data.action === google.picker.Action.PICKED) {
                const doc = data.docs[0];
                document.getElementById('upload-status').innerText = `Menyimpan "${doc.name}"...`;
                try {
                    // Penting: Jadikan file dapat dibaca oleh siapa saja yang punya link
                    // Ini butuh scope 'https://www.googleapis.com/auth/drive' (bukan readonly)
                    // Untuk sekarang, kita asumsikan file sudah di-share
                    
                    await db.collection('materials').add({
                        name: doc.name,
                        url: doc.url || doc.embedUrl, // URL untuk membuka file
                        iconUrl: doc.iconUrl,
                        targetClass: targetClass,
                        createdAt: firebase.firestore.FieldValue.serverTimestamp()
                    });
                    alert(`Materi "${doc.name}" berhasil diupload untuk kelas ${targetClass}!`);
                } catch (error) {
                    console.error("Error saving material:", error);
                    alert("Gagal menyimpan materi ke database.");
                } finally {
                     document.getElementById('upload-status').innerText = '';
                     document.getElementById('material-class-target').value = '';
                }
            } else if (data.action === google.picker.Action.CANCEL) {
                document.getElementById('upload-status').innerText = '';
            }
        }
        
        // =================================================================
        // == STUDENT DASHBOARD LOGIC
        // =================================================================
        
        // Variabel untuk menyimpan listener agar tidak duplikat
        let announcementsListener = null;
        let materialsListener = null;

        function initializeStudentDashboard(user, userData) {
            document.getElementById('student-welcome').textContent = `Hai, ${user.displayName.split(' ')[0]}!`;
            setupLogout('student-logout-btn');

            const classSelectorDiv = document.getElementById('student-class-selector');
            const mainContentDiv = document.getElementById('student-main-content');
            
            if (!userData.class) {
                // Siswa belum punya kelas, tampilkan pilihan
                classSelectorDiv.style.display = 'block';
                mainContentDiv.style.display = 'none';
            } else {
                // Siswa sudah punya kelas, tampilkan konten
                classSelectorDiv.style.display = 'none';
                mainContentDiv.style.display = 'block';
                loadStudentContent(userData.class);
            }

            // Setup event listener untuk tombol simpan kelas
            const saveClassBtn = document.getElementById('save-class-btn');
            saveClassBtn.replaceWith(saveClassBtn.cloneNode(true)); // Hapus listener lama
            document.getElementById('save-class-btn').onclick = async () => {
                const selectedClass = document.getElementById('student-class-options').value;
                if (selectedClass) {
                    try {
                        await db.collection('users').doc(user.uid).update({ class: selectedClass });
                        alert(`Kelas Anda telah disimpan sebagai ${selectedClass}.`);
                        // Muat ulang dashboard dengan data baru (termasuk kelas)
                        initializeStudentDashboard(user, {...userData, class: selectedClass});
                    } catch (err) {
                        alert('Gagal menyimpan kelas. Coba lagi.');
                    }
                }
            };
            
            showPage('student-dashboard-page');
        }
        
        function loadStudentContent(studentClass) {
            const announcementList = document.getElementById('announcement-list');
            const materialList = document.getElementById('material-list');
            
            // Hentikan listener lama jika ada (mencegah kebocoran memori)
            if (announcementsListener) announcementsListener();
            if (materialsListener) materialsListener();

            // Load Announcements (Realtime)
            announcementsListener = db.collection('announcements')
                .where('targetClass', 'in', [studentClass, 'SEMUA KELAS'])
                .orderBy('createdAt', 'desc')
                .limit(10)
                .onSnapshot(snapshot => {
                    if (snapshot.empty) {
                        announcementList.innerHTML = '<p style="text-align:center;">Belum ada pengumuman.</p>';
                        return;
                    }
                    let html = '';
                    snapshot.forEach(doc => {
                        const data = doc.data();
                        const date = data.createdAt ? data.createdAt.toDate().toLocaleDateString('id-ID', {day:'numeric', month:'long', year:'numeric'}) : '';
                        html += `
                            <div class="content-item">
                                <strong>${data.title}</strong>
                                <p>${data.content}</p>
                                <small>${date}</small>
                            </div>`;
                    });
                    announcementList.innerHTML = html;
                }, error => {
                    console.error("Error loading announcements: ", error);
                    announcementList.innerHTML = '<p style="text-align:center; color:red;">Gagal memuat pengumuman.</p>';
                });

            // Load Materials (Realtime)
            materialsListener = db.collection('materials')
                 .where('targetClass', 'in', [studentClass, 'SEMUA KELAS'])
                 .orderBy('createdAt', 'desc')
                 .limit(10)
                 .onSnapshot(snapshot => {
                    if (snapshot.empty) {
                        materialList.innerHTML = '<p style="text-align:center;">Belum ada materi belajar.</p>';
                        return;
                    }
                    let html = '';
                    snapshot.forEach(doc => {
                        const data = doc.data();
                         html += `
                            <a href="${data.url}" target="_blank" rel="noopener noreferrer" style="text-decoration:none; color:inherit;">
                                <div class="content-item" style="display:flex; align-items:center; gap:12px;">
                                    <img src="${data.iconUrl}" alt="icon" style="width:24px; height:24px; flex-shrink:0;">
                                    <span style="font-weight: 500;">${data.name}</span>
                                </div>
                            </a>`;
                    });
                    materialList.innerHTML = html;
                 }, error => {
                    console.error("Error loading materials: ", error);
                    materialList.innerHTML = '<p style="text-align:center; color:red;">Gagal memuat materi.</p>';
                });
        }
    </script>

</body>
</html>