<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>e-Learning English by Mam Yanti</title>
    
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <style>
        /* (CSS LENGKAP - Ada tambahan untuk UI baru v5.0) */
        :root {
            --primary-color: #4A90E2; --secondary-color: #50E3C2; --text-color: #4A4A4A;
            --danger-color: #E24A4A; --bg-color: #F7F9FC; --card-bg: #FFFFFF; --border-color: #EAEAEA;
            --warning-bg: #FFFBEB; --warning-border: #FDE68A;
            /* Tambahan v5.0 */
            --chat-self-bg: #E1F5FE; --chat-other-bg: #F1F3F4;
        }
        * { box-sizing: border-box; margin: 0; padding: 0; }
        body {
            font-family: 'Poppins', sans-serif; background-color: var(--bg-color); color: var(--text-color);
            display: flex; justify-content: center; align-items: center; min-height: 100vh;
            -webkit-tap-highlight-color: transparent;
        }
        #app-container {
            width: 100%; max-width: 480px; height: 100vh; background-color: var(--card-bg);
            display: flex; flex-direction: column; overflow: hidden;
            @media (min-width: 481px) {
                max-height: 90vh; min-height: 700px; border-radius: 20px; box-shadow: 0 10px 40px rgba(0, 0, 0, 0.1);
            }
        }
        .page { flex-grow: 1; overflow-y: auto; padding: 25px; display: none; }
        .page.active { display: block; }
        
        /* Halaman Navigasi Internal (Sub-halaman) */
        .sub-page { display: none; flex-grow: 1; flex-direction: column; } /* v5.0: Tambah flex */
        .sub-page.active { display: flex; } /* v5.0: Ubah ke flex */
        
        #login-page {
            display: none; flex-direction: column; justify-content: center; align-items: center; text-align: center;
            background: linear-gradient(180deg, var(--primary-color) 0%, var(--secondary-color) 100%);
        }
        #login-page.active { display: flex; }
        .login-card { background: var(--card-bg); padding: 40px 30px; border-radius: 20px; width: 90%; box-shadow: 0 10px 30px rgba(0,0,0,0.1); }
        .login-card h1 { color: var(--primary-color); font-weight: 700; font-size: 1.8em; }
        .login-card h2 { font-weight: 400; font-size: 1.2em; margin-bottom: 25px; }
        .login-card p { font-size: 0.9em; margin-bottom: 25px; }
        button {
            display: inline-flex; align-items: center; justify-content: center; gap: 10px; width: 100%;
            padding: 12px 20px; border-radius: 12px; font-size: 1em; font-family: 'Poppins', sans-serif;
            cursor: pointer; transition: all 0.2s ease; border: none; font-weight: 500;
        }
        button.primary { background-color: var(--primary-color); color: white; }
        button.primary:hover { background-color: #3a7bc8; }
        button.primary:disabled { background-color: #aaa; }
        button#login-btn { background-color: #fff; color: var(--text-color); border: 1px solid var(--border-color); }
        button#login-btn:hover { background-color: #f5f5f5; }
        button img { width: 22px; }
        input, textarea, select {
            width: 100%; padding: 12px; border-radius: 10px; border: 1px solid var(--border-color);
            margin-bottom: 15px; font-family: 'Poppins', sans-serif; font-size: 1em; background-color: #fdfdfd;
        }
        textarea { resize: vertical; min-height: 80px; }
        .header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 25px; }
        .header h1 { font-size: 1.5em; font-weight: 600; }
        .logout-btn { background: none; border: none; color: var(--primary-color); font-size: 1.5em; cursor: pointer; width: auto; padding: 5px; }
        .back-btn { background: none; border: none; color: var(--primary-color); font-size: 1.5em; cursor: pointer; width: auto; padding: 5px; }
        .feature-card {
            background: var(--card-bg); border: 1px solid var(--border-color); border-radius: 15px;
            padding: 20px; margin-bottom: 20px; box-shadow: 0 2px 8px rgba(0,0,0,0.03);
        }
        .feature-card h3 {
            margin-bottom: 15px; font-size: 1.1em; font-weight: 600; border-bottom: 1px solid var(--border-color);
            padding-bottom: 10px; display: flex; align-items: center; gap: 10px;
        }
        .content-list { max-height: 250px; overflow-y: auto; }
        .content-item { padding: 15px 5px; border-bottom: 1px solid var(--border-color); }
        .content-item:last-child { border-bottom: none; }
        .content-item strong { display: block; margin-bottom: 5px; color: var(--primary-color); }
        .content-item p { font-size: 0.95em; line-height: 1.5; white-space: pre-wrap; }
        .content-item small { font-size: 0.8em; color: #9B9B9B; }
        
        .list-item-teacher { display: flex; justify-content: space-between; align-items: center; padding: 12px 5px; border-bottom: 1px solid var(--border-color); }
        .list-item-teacher:last-child { border-bottom: none; }
        .list-item-teacher span { flex-grow: 1; font-size: 0.9em; word-break: break-all; }
        .list-item-teacher .code { font-weight: 700; color: var(--primary-color); font-size: 1.1em; }
        .delete-btn { background: var(--danger-color); color: white; border: none; border-radius: 8px; padding: 5px 10px; font-size: 0.8em; width: auto; cursor: pointer; }

        /* Panduan Box */
        .guide-box {
            background: var(--warning-bg); border: 1px solid var(--warning-border);
            padding: 15px; border-radius: 10px; margin-bottom: 15px;
        }
        .guide-box h4 { font-weight: 600; margin-bottom: 10px; }
        .guide-box p { font-size: 0.9em; line-height: 1.6; }
        .guide-box ol { padding-left: 20px; font-size: 0.9em; line-height: 1.6; }

        .spinner-container { display: flex; justify-content: center; align-items: center; padding: 20px; }
        .spinner {
            border: 4px solid rgba(0, 0, 0, 0.1); width: 36px; height: 36px; border-radius: 50%;
            border-left-color: var(--primary-color); animation: spin 1s ease infinite;
        }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

        /* ==================================== */
        /* == CSS TAMBAHAN v5.0 (CHAT) == */
        /* ==================================== */
        .chat-page-container {
            display: flex; flex-direction: column; flex-grow: 1;
            border: 1px solid var(--border-color); border-radius: 15px;
            overflow: hidden;
        }
        .chat-messages {
            flex-grow: 1; padding: 15px; overflow-y: auto;
            background-color: #fdfdfd;
        }
        .chat-message {
            display: flex; flex-direction: column; margin-bottom: 12px;
            max-width: 80%;
        }
        .chat-message .sender {
            font-size: 0.8em; font-weight: 600; margin-bottom: 4px; color: var(--primary-color);
        }
        .chat-message .bubble {
            padding: 10px 14px; border-radius: 18px;
            font-size: 0.95em; line-height: 1.5;
        }
        .chat-message .timestamp {
            font-size: 0.7em; color: #9B9B9B; margin-top: 4px;
        }

        /* Pesan Orang Lain */
        .chat-message.other {
            align-items: flex-start;
        }
        .chat-message.other .bubble {
            background-color: var(--chat-other-bg); border-top-left-radius: 4px;
        }
        .chat-message.other .timestamp { text-align: left; }

        /* Pesan Sendiri */
        .chat-message.self {
            align-items: flex-end; align-self: flex-end;
        }
        .chat-message.self .sender {
            display: none; /* Sembunyikan nama sendiri */
        }
        .chat-message.self .bubble {
            background-color: var(--chat-self-bg); border-top-right-radius: 4px;
            color: #333;
        }
        .chat-message.self .timestamp { text-align: right; }

        .chat-input-area {
            display: flex; padding: 15px; border-top: 1px solid var(--border-color);
            background-color: var(--card-bg);
        }
        .chat-input-area input {
            flex-grow: 1; margin-bottom: 0; margin-right: 10px;
        }
        .chat-input-area button {
            width: auto; padding: 10px 15px;
        }
        /* ==================================== */

    </style>
</head>
<body>

    <div id="app-container">

        <div id="login-page" class="page active">
            <div class="login-card">
                <h1>e-Learning English</h1>
                <h2>by Mam Yanti</h2>
                <p>Silakan masuk dengan Akun Google Anda untuk memulai pembelajaran.</p>
                <button id="login-btn">
                    <img src="https://developers.google.com/identity/images/g-logo.png" alt="Google Logo">
                    <span>Masuk dengan Google</span>
                </button>
                <div class="spinner-container" style="display: none;" id="login-spinner">
                    <div class="spinner"></div>
                </div>
            </div>
        </div>

        <div id="teacher-dashboard-page" class="page">
            
            <div id="teacher-main-menu" class="sub-page active">
                <div class="header">
                    <h1 id="teacher-welcome">Hai, Mam Yanti!</h1>
                    <button class="logout-btn" id="teacher-logout-btn" title="Keluar"><i class="fa-solid fa-right-from-bracket"></i></button>
                </div>
                
                <div class="feature-card">
                    <h3><i class="fa-solid fa-chalkboard-user"></i> Manajemen Kelas</h3>
                    <input type="text" id="class-name-input" placeholder="Nama Kelas Baru (Cth: XII-1)">
                    <button class="primary" id="create-class-btn">Buat Kelas Baru</button>
                    
                    <h3 style="margin-top: 20px;"><i class="fa-solid fa-list-ul"></i> Daftar Kelas & Kode</h3>
                    <div id="class-code-list" class="content-list">
                        <div class="spinner-container"><div class="spinner"></div></div>
                    </div>
                </div>
                
                <div class="feature-card">
                    <h3><i class="fa-solid fa-comments"></i> Chat Kelas Interaktif</h3>
                    <button class="primary" id="go-to-chat-btn-teacher">Buka Chat Kelas</button>
                </div>
                <div class="feature-card">
                    <h3><i class="fa-solid fa-file-pen"></i> Manajemen Tugas</h3>
                    <button class="primary" id="go-to-create-task-btn">Buat Slot Tugas Baru</button>
                    
                    <h3 style="margin-top: 20px;"><i class="fa-solid fa-list-ul"></i> Daftar Tugas Aktif</h3>
                    <div id="teacher-assignment-list" class="content-list">
                        <div class="spinner-container"><div class="spinner"></div></div>
                    </div>
                </div>

                <div class="feature-card">
                    <h3><i class="fa-solid fa-bullhorn"></i> Buat Pengumuman</h3>
                    <button class="primary" id="go-to-announcements-btn">Buka Manajemen Pengumuman</button>
                </div>
                <div class="feature-card">
                    <h3><i class="fa-solid fa-cloud-arrow-up"></i> Upload Materi (dari Google Drive)</h3>
                    <button class="primary" id="go-to-materials-btn">Buka Manajemen Materi</button>
                </div>
                <div class="feature-card">
                    <h3><i class="fa-solid fa-clipboard-user"></i> Rekap Absensi Siswa</h3>
                    <button class="primary" id="go-to-attendance-btn">Buka Rekap Absensi</button>
                </div>
            </div>

            <div id="teacher-task-page" class="sub-page">
                <div class="header">
                    <button class="back-btn" data-target="teacher-main-menu"><i class="fa-solid fa-arrow-left"></i></button>
                    <h1>Manajemen Tugas</h1>
                </div>
                <div class="feature-card">
                    <h3>Buat Slot Tugas Baru</h3>
                    <input type="text" id="task-title" placeholder="Judul Tugas">
                    <textarea id="task-desc" placeholder="Deskripsi/Instruksi Tugas..."></textarea>
                    <label style="font-size: 0.9em; margin-bottom: 5px; display: block;">Tenggat Waktu:</label>
                    <input type="date" id="task-deadline">
                    <select id="task-class-target">
                        <option value="">-- Pilih Kelas Tujuan --</option>
                        </select>
                    <button class="primary" id="create-task-btn">Publikasikan Tugas</button>
                </div>
                
                <div id="teacher-view-submissions-div" class="feature-card" style="display:none;">
                    <h3 id="submission-list-title">...</h3>
                    <div id="submission-list-container" class="content-list"></div>
                </div>
            </div>

            <div id="teacher-announcement-page" class="sub-page">
                <div class="header">
                    <button class="back-btn" data-target="teacher-main-menu"><i class="fa-solid fa-arrow-left"></i></button>
                    <h1>Manajemen Pengumuman</h1>
                </div>
                <div class="feature-card">
                    <h3>Buat Pengumuman Baru</h3>
                    <input type="text" id="announcement-title" placeholder="Judul Pengumuman">
                    <textarea id="announcement-content" rows="3" placeholder="Isi pengumuman..."></textarea>
                    <select id="announcement-class-target">
                        <option value="">-- Pilih Kelas Tujuan --</option>
                        </select>
                    <button class="primary" id="publish-announcement-btn">Publikasikan</button>
                </div>
                <div class="feature-card">
                    <h3>Riwayat Pengumuman</h3>
                    <div id="teacher-announcement-list" class="content-list"></div>
                </div>
            </div>

            <div id="teacher-material-page" class="sub-page">
                <div class="header">
                    <button class="back-btn" data-target="teacher-main-menu"><i class="fa-solid fa-arrow-left"></i></button>
                    <h1>Manajemen Materi</h1>
                </div>
                <div class="feature-card">
                    <h3>Upload Materi (dari Google Drive)</h3>
                    <select id="material-class-target">
                        <option value="">-- Pilih Kelas Tujuan --</option>
                        </select>
                    <button id="upload-material-btn" style="margin-top: 10px;"><i class="fa-brands fa-google-drive"></i> Pilih File dari Google Drive</button>
                    <p id="upload-status" style="text-align: center; margin-top: 10px; font-size: 0.9em;"></p>
                </div>
                <div class="feature-card">
                    <h3>Daftar Materi Terupload</h3>
                    <div id="teacher-material-list" class="content-list"></div>
                </div>
            </div>

            <div id="teacher-attendance-page" class="sub-page">
                <div class="header">
                    <button class="back-btn" data-target="teacher-main-menu"><i class="fa-solid fa-arrow-left"></i></button>
                    <h1>Rekap Absensi</h1>
                </div>
                <div class="feature-card">
                    <h3>Pilih Kelas & Tanggal</h3>
                    <input type="date" id="attendance-recap-date">
                    <select id="attendance-recap-class">
                        <option value="">-- Pilih Kelas --</option>
                        </select>
                    <button class="primary" id="view-attendance-btn">Tampilkan Rekap</button>
                    <div id="attendance-recap-list" class="content-list" style="margin-top: 15px;"></div>
                </div>
            </div>
            
            <div id="teacher-chat-page" class="sub-page">
                <div class="header">
                    <button class="back-btn" data-target="teacher-main-menu"><i class="fa-solid fa-arrow-left"></i></button>
                    <h1>Chat Kelas</h1>
                </div>
                
                <div class="feature-card" style="margin-bottom: 15px;">
                    <h3>Pilih Kelas untuk Chat</h3>
                    <select id="chat-class-select-teacher">
                        <option value="">-- Pilih Kelas --</option>
                    </select>
                </div>

                <div class="chat-page-container">
                    <div class="chat-messages" id="chat-messages-teacher">
                        <p style="text-align: center; padding: 20px; color: #999;">Pilih kelas untuk memulai chat.</p>
                    </div>
                    <div class="chat-input-area">
                        <input type="text" id="chat-input-teacher" placeholder="Ketik pesan..." disabled>
                        <button id="send-chat-btn-teacher" class="primary" disabled><i class="fa-solid fa-paper-plane"></i></button>
                    </div>
                </div>
            </div>
            </div>

        <div id="student-dashboard-page" class="page">
            
            <div id="student-main-menu" class="sub-page active">
                <div class="header">
                    <h1 id="student-welcome">Selamat Datang!</h1>
                    <button class="logout-btn" id="student-logout-btn" title="Keluar"><i class="fa-solid fa-right-from-bracket"></i></button>
                </div>
                
                <div id="student-join-class" style="display:none;" class="feature-card">
                    <h3><i class="fa-solid fa-door-open"></i> Gabung Kelas</h3>
                    <p>Anda belum terdaftar di kelas manapun. Silakan masukkan "Kode Kelas" yang diberikan oleh Mam Yanti.</p>
                    <input type="text" id="class-code-input" placeholder="Masukkan Kode Kelas (Cth: ABCDE1)">
                    <button class="primary" id="join-class-btn">Gabung Kelas</button>
                </div>

                <div id="student-main-content" style="display:none;">
                    <div class="feature-card">
                        <h3><i class="fa-solid fa-user-check"></i> Absensi Hari Ini</h3>
                        <p id="attendance-status" style="text-align: center; margin-bottom: 15px;">Memeriksa status...</p>
                        <input type="number" id="attendance-input" placeholder="Masukkan Nomor Absen Anda" style="margin-bottom: 10px;">
                        <button class="primary" id="submit-attendance-btn" disabled>Kirim Absensi</button>
                    </div>

                    <div class="feature-card">
                        <h3><i class="fa-solid fa-comments"></i> Chat Kelas</h3>
                        <button class="primary" id="go-to-chat-btn-student">Buka Chat Kelas</button>
                    </div>
                    <div class="feature-card">
                        <h3><i class="fa-solid fa-bullhorn"></i> Pengumuman</h3>
                        <div id="announcement-list" class="content-list">
                            <div class="spinner-container"><div class="spinner"></div></div>
                        </div>
                    </div>
                    
                    <div class="feature-card">
                        <h3><i class="fa-solid fa-book-open"></i> Materi Belajar</h3>
                        <div id="material-list" class="content-list">
                            <div class="spinner-container"><div class="spinner"></div></div>
                        </div>
                    </div>
                    
                    <div class="feature-card">
                        <h3><i class="fa-solid fa-file-pen"></i> Daftar Tugas</h3>
                        <div id="assignment-list-student" class="content-list">
                            <div class="spinner-container"><div class="spinner"></div></div>
                        </div>
                    </div>
                </div>
            </div>

            <div id="student-task-page" class="sub-page">
                <div class="header">
                    <button class="back-btn" data-target="student-main-menu"><i class="fa-solid fa-arrow-left"></i></button>
                    <h1 id="task-detail-title">Kirim Tugas</h1>
                </div>
                
                <div class="feature-card">
                    <h3 id="task-detail-desc-title">Deskripsi Tugas:</h3>
                    <p id="task-detail-desc" style="font-size: 0.95em; line-height: 1.6; white-space: pre-wrap; margin-bottom: 15px;"></p>
                    <small id="task-detail-deadline" style="font-weight: 600; color: var(--danger-color);"></small>
                </div>

                <div class="feature-card">
                    <h3><i class="fa-solid fa-link"></i> Kirim Link Google Drive</h3>
                    
                    <div class="guide-box">
                        <h4>Cara Mengumpulkan Tugas:</h4>
                        <ol>
                            <li>Kerjakan tugas Anda di Google Docs/Slides.</li>
                            <li>Klik tombol **"Share"** (Bagikan) di pojok kanan atas.</li>
                            <li>Di bagian "General access", ganti dari "Restricted" menjadi **"Anyone with the link" (Siapa saja yang memiliki link)**.</li>
                            <li>Pastikan role-nya adalah **"Viewer"** atau **"Commenter"**.</li>
                            <li>Klik **"Copy link"** (Salin link).</li>
                            <li>Tempel (paste) link tersebut di kotak di bawah ini.</li>
                        </ol>
                    </div>

                    <input type="url" id="task-link-input" placeholder="Tempel link Google Drive Anda di sini...">
                    <button class="primary" id="submit-task-btn">Kirim Tugas</button>
                    <p id="task-submission-status" style="text-align: center; margin-top: 10px; font-weight: 600;"></p>
                </div>
            </div>
            
            <div id="student-chat-page" class="sub-page">
                <div class="header">
                    <button class="back-btn" data-target="student-main-menu"><i class="fa-solid fa-arrow-left"></i></button>
                    <h1 id="student-chat-title">Chat Kelas</h1>
                </div>
                
                <div class="chat-page-container">
                    <div class="chat-messages" id="chat-messages-student">
                        <div class="spinner-container"><div class="spinner"></div></div>
                    </div>
                    <div class="chat-input-area">
                        <input type="text" id="chat-input-student" placeholder="Ketik pesan...">
                        <button id="send-chat-btn-student" class="primary"><i class="fa-solid fa-paper-plane"></i></button>
                    </div>
                </div>
            </div>
            </div>

    </div> 
    
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-firestore.js"></script>
    <script src="https://apis.google.com/js/api.js"></script>
    <script src="https://accounts.google.com/gsi/client"></script>

    <script type="module">
        // =================================================================
        // == KONFIGURASI KUNCI API ==
        // =================================================================
        const firebaseConfig = {
            apiKey: "AIzaSyDpYabA0lb-0uh3Pe-URmeY7WxpIHj7c5Q",
            authDomain: "e-learning-mamyanti.firebaseapp.com",
            projectId: "e-learning-mamyanti",
            storageBucket: "e-learning-mamyanti.appspot.com",
            messagingSenderId: "198925356373",
            appId: "1:198925356373:web:754ae2355b925aa50333dc"
        };
        
        const GOOGLE_API_KEY = "AIzaSyBJ9yRe5AYOJGiYwAqlm5wK1La3LhhuS5A";
        const GOOGLE_CLIENT_ID = "198925356373-mb0ame0q1sh3elqlq4mofgdakn8df9jh.apps.googleusercontent.com";
        const APP_ID = "198925356373"; 
        const TEACHER_EMAIL = "elearningmamyanti@gmail.com";
        // =================================================================

        // Initialize Firebase
        firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        const db = firebase.firestore();
        
        // Variabel Global
        const pages = document.querySelectorAll('.page');
        const loginBtn = document.getElementById('login-btn');
        const loginSpinner = document.getElementById('login-spinner');
        let currentUser = null;
        let currentUserData = null;

        // Listener Global untuk unsub (mencegah duplikat)
        let listeners = [];
        let currentChatListener = null; // v5.0: Listener khusus untuk chat aktif

        // --- Page Navigation ---
        function showPage(pageId) {
            pages.forEach(page => page.classList.remove('active'));
            document.getElementById(pageId).classList.add('active');
        }
        
        // v5.0: Modifikasi showSubPage untuk unsubscribe chat listener saat pindah
        function showSubPage(pageElement, subPageId) {
            const currentPage = pageElement.querySelector('.sub-page.active');
            
            pageElement.querySelectorAll('.sub-page').forEach(sp => sp.classList.remove('active'));
            pageElement.querySelector(`#${subPageId}`).classList.add('active');
            
            // v5.0: Cek apakah kita pindah DARI halaman chat
            if (currentPage && (currentPage.id === 'teacher-chat-page' || currentPage.id === 'student-chat-page')) {
                if (currentChatListener) {
                    console.log("Unsubscribing from chat listener...");
                    currentChatListener();
                    currentChatListener = null;
                }
            }
        }
        
        // Setup tombol kembali (Back)
        document.querySelectorAll('.back-btn').forEach(btn => {
            btn.addEventListener('click', () => {
                const targetPageId = btn.dataset.target;
                const parentPage = btn.closest('.page');
                showSubPage(parentPage, targetPageId);
            });
        });
        
        // --- Authentication ---
        auth.onAuthStateChanged(async (user) => {
            if (user) {
                currentUser = user; // Simpan user
                loginBtn.style.display = 'none';
                loginSpinner.style.display = 'flex';
                await handleUserLogin(user);
            } else {
                 currentUser = null;
                 currentUserData = null;
                 // Hentikan semua listener realtime saat logout
                 listeners.forEach(unsub => unsub());
                 listeners = [];
                 
                 // v5.0: Hentikan juga chat listener aktif
                 if (currentChatListener) {
                    currentChatListener();
                    currentChatListener = null;
                 }
                    
                 showPage('login-page');
                 loginBtn.style.display = 'inline-flex';
                 loginSpinner.style.display = 'none';
            }
        });
        
        loginBtn.addEventListener('click', () => {
            loginBtn.style.display = 'none';
            loginSpinner.style.display = 'flex';
            const provider = new firebase.auth.GoogleAuthProvider();
            auth.signInWithPopup(provider).catch(error => {
                console.error("Login error:", error);
                alert("Gagal masuk. Silakan coba lagi.");
                showPage('login-page');
                loginBtn.style.display = 'inline-flex';
                loginSpinner.style.display = 'none';
            });
        });

        async function handleUserLogin(user) {
            const userRef = db.collection('users').doc(user.uid);
            const userDoc = await userRef.get();
            if (user.email.toLowerCase() === TEACHER_EMAIL.toLowerCase()) {
                if (!userDoc.exists) {
                    await userRef.set({ name: user.displayName, email: user.email, role: 'teacher' }, { merge: true });
                }
                currentUserData = (await userRef.get()).data();
                initializeTeacherDashboard(user);
            } else {
                 if (!userDoc.exists) {
                    // classId dan className null saat pendaftaran
                    await userRef.set({ name: user.displayName, email: user.email, role: 'student', classId: null, className: null }, { merge: true });
                }
                currentUserData = (await userRef.get()).data();
                initializeStudentDashboard(user, currentUserData);
            }
        }
        
        function setupLogout(buttonId) {
             document.getElementById(buttonId).addEventListener('click', () => {
                 if (confirm('Apakah Anda yakin ingin keluar?')) { auth.signOut(); }
             });
        }
        
        // --- Helper: Generate Kode Kelas ---
        function generateClassCode() {
            let code = '';
            const chars = 'ABCDEFGHIJKLMNPQRSTUVWXYZ123456789'; // Hapus O dan 0
            for (let i = 0; i < 6; i++) {
                code += chars.charAt(Math.floor(Math.random() * chars.length));
            }
            return code;
        }

        // --- Helper: Format Tanggal ---
        function formatReadableDate(dateObj) {
            return dateObj.toLocaleDateString('id-ID', { weekday: 'long', day: 'numeric', month: 'long', year: 'numeric' });
        }
        
        // v5.0: Helper Format Waktu Chat
        function formatChatTimestamp(dateObj) {
            return dateObj.toLocaleTimeString('id-ID', { hour: '2-digit', minute: '2-digit' });
        }
        
        // v5.0: Helper Scroll ke Bawah
        function scrollToChatBottom(element) {
            if(element) {
                // Gunakan setTimeout 0 untuk menunggu DOM render
                setTimeout(() => {
                    element.scrollTop = element.scrollHeight;
                }, 0);
            }
        }
        
        // =================================================================
        // == TEACHER DASHBOARD LOGIC (v4.1 + v5.0)
        // =================================================================
        
        function initializeTeacherDashboard(user) {
            setupLogout('teacher-logout-btn');
            
            // Setup Tombol Navigasi Sub-Halaman
            document.getElementById('go-to-create-task-btn').onclick = () => showSubPage(document.getElementById('teacher-dashboard-page'), 'teacher-task-page');
            document.getElementById('go-to-announcements-btn').onclick = () => showSubPage(document.getElementById('teacher-dashboard-page'), 'teacher-announcement-page');
            document.getElementById('go-to-materials-btn').onclick = () => showSubPage(document.getElementById('teacher-dashboard-page'), 'teacher-material-page');
            document.getElementById('go-to-attendance-btn').onclick = () => showSubPage(document.getElementById('teacher-dashboard-page'), 'teacher-attendance-page');
            document.getElementById('go-to-chat-btn-teacher').onclick = () => showSubPage(document.getElementById('teacher-dashboard-page'), 'teacher-chat-page'); // v5.0

            // Setup Tombol Aksi
            document.getElementById('create-class-btn').onclick = createClass;
            document.getElementById('create-task-btn').onclick = createAssignment;
            document.getElementById('publish-announcement-btn').onclick = publishAnnouncement;
            document.getElementById('upload-material-btn').onclick = initPicker;
            document.getElementById('view-attendance-btn').onclick = viewAttendance;
            
            // v5.0: Setup Aksi Chat
            document.getElementById('chat-class-select-teacher').addEventListener('change', loadTeacherChat);
            document.getElementById('send-chat-btn-teacher').onclick = sendChatMessageTeacher;
            document.getElementById('chat-input-teacher').addEventListener('keypress', e => {
                if (e.key === 'Enter') sendChatMessageTeacher();
            });

            // Muat data awal
            loadTeacherData();
            setupDeleteListeners(); 
            
            showPage('teacher-dashboard-page');
            showSubPage(document.getElementById('teacher-dashboard-page'), 'teacher-main-menu'); // Mulai dari menu utama
            document.getElementById('attendance-recap-date').valueAsDate = new Date();
        }

        function loadTeacherData() {
            // Hentikan listener lama
            listeners.forEach(unsub => unsub());
            listeners = [];
            
            // Muat Daftar Kelas
            const classListEl = document.getElementById('class-code-list');
            
            let classListener = db.collection('classes').where('teacherId', '==', currentUser.uid)
                .onSnapshot(snapshot => {
                    if (snapshot.empty) { classListEl.innerHTML = '<p style_="text-align:center;">Belum ada kelas.</p>'; return; }
                    
                    let listHtml = '';
                    let selectHtml = '<option value="">-- Pilih Kelas --</option>';
                    let selectHtmlAll = '<option value="">-- Pilih Kelas --</option>'; // Versi dengan "SEMUA KELAS"
                    
                    snapshot.forEach(doc => {
                        const data = doc.data();
                        listHtml += `<div class="list-item-teacher">
                                        <span>${data.name} <br> <strong class="code">${data.code}</strong></span>
                                        <button class="delete-btn" data-id="${doc.id}" data-collection="classes">Hapus</button>
                                    </div>`;
                        selectHtml += `<option value="${doc.id}">${data.name}</option>`;
                        selectHtmlAll += `<option value="${doc.id}">${data.name}</option>`;
                    });
                    selectHtmlAll += '<option value="SEMUA KELAS">SEMUA KELAS</option>'; // Khusus pengumuman/materi
                    
                    classListEl.innerHTML = listHtml;
                    document.getElementById('task-class-target').innerHTML = selectHtml;
                    document.getElementById('attendance-recap-class').innerHTML = selectHtml;
                    document.getElementById('chat-class-select-teacher').innerHTML = selectHtml; // v5.0
                    document.getElementById('announcement-class-target').innerHTML = selectHtmlAll;
                    document.getElementById('material-class-target').innerHTML = selectHtmlAll;
                }, error => { console.error("Error load classes:", error); classListEl.innerHTML = '<p class="error">Gagal memuat kelas.</p>'; });
            
            listeners.push(classListener);

            // Muat Daftar Tugas
            const taskListEl = document.getElementById('teacher-assignment-list');
            let taskListener = db.collection('assignments').where('teacherId', '==', currentUser.uid).orderBy('deadline', 'desc')
                .onSnapshot(snapshot => {
                    if (snapshot.empty) { taskListEl.innerHTML = '<p style="text-align:center;">Belum ada tugas.</p>'; return; }
                    let html = '';
                    snapshot.forEach(doc => {
                        const data = doc.data();
                        const deadline = formatReadableDate(data.deadline.toDate());
                        html += `<div class="content-item" style="cursor: pointer;" data-id="${doc.id}" data-title="${data.title}">
                                    <strong>${data.title}</strong>
                                    <small>Tenggat: ${deadline}</small>
                                </div>`;
                    });
                    taskListEl.innerHTML = html;
                    
                    // Tambahkan listener klik untuk melihat submission
                    taskListEl.querySelectorAll('.content-item').forEach(item => {
                        item.addEventListener('click', () => {
                            viewSubmissions(item.dataset.id, item.dataset.title);
                        });
                    });
                    
                }, error => { console.error("Error load assignments:", error); taskListEl.innerHTML = '<p class="error">Gagal memuat tugas.</p>'; });
            
            listeners.push(taskListener);
            
            // Muat Daftar Pengumuman & Materi (untuk halaman internal)
            loadTeacherAnnouncements();
            loadTeacherMaterials();
        }

        async function createClass() {
            const className = document.getElementById('class-name-input').value.trim();
            if (!className) { alert("Nama kelas tidak boleh kosong."); return; }
            
            const newCode = generateClassCode();
            
            try {
                // Pastikan kode unik (meski kemungkinannya kecil)
                const check = await db.collection('classes').where('code', '==', newCode).get();
                if (!check.empty) { return createClass(); } // Coba lagi jika tabrakan
                
                await db.collection('classes').add({
                    name: className,
                    code: newCode,
                    teacherId: currentUser.uid,
                    createdAt: firebase.firestore.FieldValue.serverTimestamp()
                });
                
                alert(`Kelas "${className}" berhasil dibuat dengan kode: ${newCode}`);
                document.getElementById('class-name-input').value = '';
            } catch (error) { console.error("Error creating class: ", error); alert("Gagal membuat kelas."); }
        }

        async function createAssignment() {
            const title = document.getElementById('task-title').value.trim();
            const desc = document.getElementById('task-desc').value.trim();
            const deadline = document.getElementById('task-deadline').value;
            const classId = document.getElementById('task-class-target').value;
            
            if (!title || !desc || !deadline || !classId) {
                alert("Harap isi semua kolom tugas."); return;
            }
            
            try {
                await db.collection('assignments').add({
                    title: title,
                    description: desc,
                    deadline: new Date(deadline),
                    classId: classId,
                    teacherId: currentUser.uid,
                    createdAt: firebase.firestore.FieldValue.serverTimestamp()
                });
                
                alert("Slot tugas berhasil dipublikasikan!");
                document.getElementById('task-title').value = '';
                document.getElementById('task-desc').value = '';
                document.getElementById('task-deadline').value = '';
                document.getElementById('task-class-target').value = '';
                // Kembali ke menu utama guru
                showSubPage(document.getElementById('teacher-dashboard-page'), 'teacher-main-menu');
            } catch (error) { console.error("Error creating assignment: ", error); alert("Gagal mempublikasikan tugas."); }
        }

        function viewSubmissions(assignmentId, assignmentTitle) {
            // Tampilkan div
            const div = document.getElementById('teacher-view-submissions-div');
            const listEl = document.getElementById('submission-list-container');
            
            div.style.display = 'block';
            document.getElementById('submission-list-title').textContent = `Rekap Pengumpulan: ${assignmentTitle}`;
            listEl.innerHTML = '<div class="spinner-container"><div class="spinner"></div></div>';
            
            // Pindah ke halaman tugas
            showSubPage(document.getElementById('teacher-dashboard-page'), 'teacher-task-page');
            
            // Buat listener baru
            let subListener = db.collection('assignments').doc(assignmentId).collection('submissions')
                .orderBy('timestamp', 'desc')
                .onSnapshot(snapshot => {
                    if (snapshot.empty) {
                        listEl.innerHTML = '<p style="text-align:center;">Belum ada siswa yang mengumpulkan.</p>';
                        return;
                    }
                    let html = '';
                    snapshot.forEach(doc => {
                        const data = doc.data();
                        const date = formatReadableDate(data.timestamp.toDate());
                        html += `<div class="content-item">
                                    <strong>${data.studentName}</strong>
                                    <p><a href="${data.link}" target="_blank" rel="noopener noreferrer">Buka Link Google Drive</a></p>
                                    <small>Mengumpulkan pada: ${date}</small>
                                </div>`;
                    });
                    listEl.innerHTML = html;
                }, error => {
                    console.error("Error loading submissions: ", error);
                    listEl.innerHTML = '<p class="error">Gagal memuat rekap.</p>';
                });
                
            listeners.push(subListener);
        }

        async function publishAnnouncement() {
            // (Kode sama, tapi targetClass diganti jadi classId)
            const title = document.getElementById('announcement-title').value.trim();
            const content = document.getElementById('announcement-content').value.trim();
            const classId = document.getElementById('announcement-class-target').value; // Ini classId
            if (!title || !content || !classId) { alert('Harap isi semua kolom.'); return; }
            try {
                await db.collection('announcements').add({
                    title, content, classId, // Simpan classId
                    createdAt: firebase.firestore.FieldValue.serverTimestamp()
                });
                alert('Pengumuman berhasil dipublikasikan!');
                document.getElementById('announcement-title').value = '';
                document.getElementById('announcement-content').value = '';
            } catch (error) { console.error("Error publishing: ", error); alert('Gagal mempublikasikan.'); }
        }

        function loadTeacherAnnouncements() {
            const listElement = document.getElementById('teacher-announcement-list');
            let listener = db.collection('announcements').orderBy('createdAt', 'desc').limit(10)
                .onSnapshot(snapshot => {
                    if (snapshot.empty) { listElement.innerHTML = '<p style="text-align:center;">Belum ada pengumuman.</p>'; return; }
                    let html = '';
                    snapshot.forEach(doc => {
                        html += `<div class="list-item-teacher">
                                    <span><strong>${doc.data().title}</strong> (${doc.data().classId})</span>
                                    <button class="delete-btn" data-id="${doc.id}" data-collection="announcements">Hapus</button>
                                </div>`;
                    });
                    listElement.innerHTML = html;
                }, error => { listElement.innerHTML = '<p class="error">Gagal memuat pengumuman.</p>'; });
            listeners.push(listener);
        }
        
        function loadTeacherMaterials() {
            const listElement = document.getElementById('teacher-material-list');
            let listener = db.collection('materials').orderBy('createdAt', 'desc').limit(10)
                .onSnapshot(snapshot => {
                    if (snapshot.empty) { listElement.innerHTML = '<p style="text-align:center;">Belum ada materi.</p>'; return; }
                    let html = '';
                    snapshot.forEach(doc => {
                        html += `<div class="list-item-teacher">
                                    <span style="margin-right: 10px;">${doc.data().name} (${doc.data().classId})</span>
                                    <button class="delete-btn" data-id="${doc.id}" data-collection="materials">Hapus</button>
                                </div>`;
                    });
                    listElement.innerHTML = html;
                }, error => { listElement.innerHTML = '<p class="error">Gagal memuat materi.</p>'; });
            listeners.push(listener);
        }
        
        function setupDeleteListeners() {
            const appContainer = document.getElementById('app-container');
            appContainer.addEventListener('click', async (e) => {
                if (e.target && e.target.classList.contains('delete-btn')) {
                    const id = e.target.dataset.id;
                    const collection = e.target.dataset.collection;
                    if (!id || !collection) return;
                    if (confirm('Anda yakin ingin menghapus item ini?')) {
                        try {
                            await db.collection(collection).doc(id).delete();
                            alert('Item berhasil dihapus.');
                        } catch (error) { console.error("Error deleting: ", error); alert('Gagal menghapus item.'); }
                    }
                }
            });
        }
        
        async function viewAttendance() {
            // (Kode sama, tapi targetClass diganti jadi classId)
            const date = document.getElementById('attendance-recap-date').value;
            const classId = document.getElementById('attendance-recap-class').value;
            const listElement = document.getElementById('attendance-recap-list');
            if (!date || !classId) { alert("Harap pilih tanggal dan kelas."); return; }
            listElement.innerHTML = '<div class="spinner-container"><div class="spinner"></div></div>';
            
            try {
                // Query berdasarkan classId
                const snapshot = await db.collection('attendance').doc(date).collection('submissions')
                                            .where('classId', '==', classId).orderBy('nomorAbsen', 'asc').get();
                if (snapshot.empty) { listElement.innerHTML = '<p style="text-align:center;">Tidak ada data absensi.</p>'; return; }
                let html = '';
                snapshot.forEach(doc => {
                    const data = doc.data();
                    const time = data.timestamp.toDate().toLocaleTimeString('id-ID', { hour: '2-digit', minute: '2-digit' });
                    html += `<div class="content-item"><strong>${data.nomorAbsen}. ${data.nama}</strong> <small>(Absen: ${time})</small></div>`;
                });
                listElement.innerHTML = html;
            } catch (error) { listElement.innerHTML = '<p class="error">Gagal mengambil data.</p>'; }
        }
        
        // --- GOOGLE DRIVE PICKER (Kode sama seperti v4.1) ---
        let tokenClient;
        function initPicker() {
            const classId = document.getElementById('material-class-target').value;
            if (!classId) { alert("Harap pilih kelas tujuan."); return; }
            gapi.load('client:picker', () => gisLoaded(classId));
        }
        function gisLoaded(classId) {
            tokenClient = google.accounts.oauth2.initTokenClient({
                client_id: GOOGLE_CLIENT_ID,
                scope: 'https://www.googleapis.com/auth/drive.readonly',
                callback: (tokenResponse) => {
                     if (tokenResponse.error) { throw(tokenResponse); }
                     initializePicker(tokenResponse.access_token, classId);
                },
            });
            tokenClient.requestAccessToken({prompt: 'consent'});
        }
        async function initializePicker(accessToken, classId) {
            await gapi.client.init({ apiKey: GOOGLE_API_KEY });
            gapi.client.setToken({ access_token: accessToken });
            document.getElementById('upload-status').innerText = 'Membuka pemilih file...';
            createPicker(accessToken, classId);
        }
        function createPicker(token, classId) {
            const view = new google.picker.View(google.picker.ViewId.DOCS);
            view.setMimeTypes("application/pdf,application/vnd.google-apps.presentation,application/vnd.google-apps.document");
            const picker = new google.picker.PickerBuilder()
                .enableFeature(google.picker.Feature.NAV_HIDDEN)
                .setAppId(APP_ID).setOAuthToken(token).addView(view)
                .addView(new google.picker.DocsUploadView())
                .setDeveloperKey(GOOGLE_API_KEY)
                .setCallback((data) => pickerCallback(data, classId))
                .build();
            picker.setVisible(true);
        }
        async function pickerCallback(data, classId) {
            if (data.action === google.picker.Action.PICKED) {
                const doc = data.docs[0];
                document.getElementById('upload-status').innerText = `Menyimpan "${doc.name}"...`;
                try {
                    await db.collection('materials').add({
                        name: doc.name, url: doc.url || doc.embedUrl, iconUrl: doc.iconUrl,
                        classId: classId, // Simpan classId
                        createdAt: firebase.firestore.FieldValue.serverTimestamp()
                    });
                    alert(`Materi "${doc.name}" berhasil dipublikasikan!`);
                } catch (error) { console.error("Error saving material:", error); alert("Gagal menyimpan materi.");
                } finally { document.getElementById('upload-status').innerText = ''; }
            } else if (data.action === google.picker.Action.CANCEL) { document.getElementById('upload-status').innerText = ''; }
        }
        
        // =================================================================
        // == v5.0: LOGIKA CHAT GURU
        // =================================================================
        
        function loadTeacherChat() {
            const classId = document.getElementById('chat-class-select-teacher').value;
            const messagesArea = document.getElementById('chat-messages-teacher');
            const chatInput = document.getElementById('chat-input-teacher');
            const sendBtn = document.getElementById('send-chat-btn-teacher');

            // Hentikan listener sebelumnya
            if (currentChatListener) {
                currentChatListener();
                currentChatListener = null;
            }

            if (!classId) {
                messagesArea.innerHTML = '<p style="text-align: center; padding: 20px; color: #999;">Pilih kelas untuk memulai chat.</p>';
                chatInput.disabled = true;
                sendBtn.disabled = true;
                return;
            }

            // Kelas dipilih, aktifkan input
            chatInput.disabled = false;
            sendBtn.disabled = false;
            messagesArea.innerHTML = '<div class="spinner-container"><div class="spinner"></div></div>';

            // Ambil 50 pesan terakhir, urutkan ASC
            const chatQuery = db.collection('chats')
                                .where('classId', '==', classId)
                                .orderBy('timestamp')
                                .limitToLast(50);
            
            currentChatListener = chatQuery.onSnapshot(snapshot => {
                renderChatMessages(snapshot, messagesArea, currentUser.uid);
                scrollToChatBottom(messagesArea);
            }, error => {
                console.error("Error loading chat: ", error);
                messagesArea.innerHTML = '<p class="error">Gagal memuat chat.</p>';
            });
        }
        
        async function sendChatMessageTeacher() {
            const text = document.getElementById('chat-input-teacher').value.trim();
            const classId = document.getElementById('chat-class-select-teacher').value;
            
            if (!text || !classId) return; // Jangan kirim jika kosong atau kelas tdk dipilih

            document.getElementById('chat-input-teacher').value = '';
            
            try {
                await db.collection('chats').add({
                    classId: classId,
                    senderId: currentUser.uid,
                    senderName: "Mam Yanti", // Sesuai permintaan
                    text: text,
                    timestamp: firebase.firestore.FieldValue.serverTimestamp()
                });
            } catch (error) {
                console.error("Error sending message: ", error);
                alert("Gagal mengirim pesan.");
                document.getElementById('chat-input-teacher').value = text; // Kembalikan teks
            }
        }
        
        
        // =================================================================
        // == STUDENT DASHBOARD LOGIC (v4.1 + v5.0)
        // =================================================================
        
        function initializeStudentDashboard(user, userData) {
            document.getElementById('student-welcome').textContent = `Hai, ${user.displayName.split(' ')[0]}!`;
            setupLogout('student-logout-btn');

            const joinClassDiv = document.getElementById('student-join-class');
            const mainContentDiv = document.getElementById('student-main-content');
            
            // Perubahan Logika: Cek classId, bukan class
            if (!userData.classId) {
                // Siswa belum punya kelas, tampilkan form "Join Class"
                joinClassDiv.style.display = 'block';
                mainContentDiv.style.display = 'none';
            } else {
                // Siswa sudah punya kelas, tampilkan konten
                joinClassDiv.style.display = 'none';
                mainContentDiv.style.display = 'block';
                loadStudentContent(userData.classId);
                checkStudentAttendance(); 
            }
            
            // Setup listener tombol gabung kelas
            document.getElementById('join-class-btn').onclick = joinClass;
            // Setup listener tombol absen
            document.getElementById('submit-attendance-btn').onclick = submitAttendance;
            
            // v5.0: Setup Aksi Chat Siswa
            document.getElementById('go-to-chat-btn-student').onclick = loadStudentChat;
            document.getElementById('send-chat-btn-student').onclick = sendChatMessageStudent;
            document.getElementById('chat-input-student').addEventListener('keypress', e => {
                if (e.key === 'Enter') sendChatMessageStudent();
            });
            
            showPage('student-dashboard-page');
            showSubPage(document.getElementById('student-dashboard-page'), 'student-main-menu');
        }
        
        // --- FITUR BARU: GABUNG KELAS ---
        async function joinClass() {
            const code = document.getElementById('class-code-input').value.trim().toUpperCase();
            if (!code) { alert("Kode kelas tidak boleh kosong."); return; }
            
            try {
                const classQuery = await db.collection('classes').where('code', '==', code).limit(1).get();
                
                if (classQuery.empty) {
                    alert("Kode kelas tidak ditemukan. Periksa kembali kode Anda.");
                    return;
                }
                
                const classDoc = classQuery.docs[0];
                const classId = classDoc.id;
                const className = classDoc.data().name;
                
                // Update profil siswa
                await db.collection('users').doc(currentUser.uid).update({
                    classId: classId,
                    className: className
                });
                
                alert(`Anda berhasil bergabung dengan kelas ${className}!`);
                
                // Muat ulang dashboard dengan data baru
                currentUserData.classId = classId;
                currentUserData.className = className;
                initializeStudentDashboard(currentUser, currentUserData);
                
            } catch (error) {
                console.error("Error joining class: ", error);
                alert("Gagal bergabung dengan kelas.");
            }
        }
        
        // --- FITUR ABSENSI (STUDENT) - Simple ---
        function getTodayDateString() {
            return new Date().toISOString().slice(0, 10); // Format: YYYY-MM-DD
        }

        async function checkStudentAttendance() {
            // ... (Kode sama, sudah benar) ...
            const dateStr = getTodayDateString();
            const attendanceStatusEl = document.getElementById('attendance-status');
            const attendanceInputEl = document.getElementById('attendance-input');
            const attendanceBtnEl = document.getElementById('submit-attendance-btn');
            try {
                const doc = await db.collection('attendance').doc(dateStr).collection('submissions').doc(currentUser.uid).get();
                if (doc.exists) {
                    attendanceStatusEl.textContent = `Anda sudah absen hari ini (No. ${doc.data().nomorAbsen}).`;
                    attendanceStatusEl.style.color = 'green';
                    attendanceInputEl.disabled = true;
                    attendanceBtnEl.disabled = true;
                    attendanceInputEl.value = doc.data().nomorAbsen;
                } else {
                    attendanceStatusEl.textContent = 'Anda BELUM absensi hari ini.';
                    attendanceStatusEl.style.color = 'var(--danger-color)';
                    attendanceInputEl.disabled = false;
                    attendanceBtnEl.disabled = false;
                }
            } catch (error) {
                 attendanceStatusEl.textContent = "Gagal memuat status absensi.";
                 attendanceStatusEl.style.color = 'red';
            }
        }

        async function submitAttendance() {
            // ... (Kode sama, tapi kirim classId) ...
            const nomorAbsen = document.getElementById('attendance-input').value.trim();
            if (!nomorAbsen || isNaN(nomorAbsen) || nomorAbsen < 1 || nomorAbsen > 40) {
                alert(`Nomor absen tidak valid.`); return;
            }
            const attendanceBtnEl = document.getElementById('submit-attendance-btn');
            attendanceBtnEl.disabled = true;
            attendanceBtnEl.textContent = "Memproses...";
            try {
                const dateStr = getTodayDateString();
                const attendanceRef = db.collection('attendance').doc(dateStr).collection('submissions').doc(currentUser.uid);
                await attendanceRef.set({
                    nomorAbsen: parseInt(nomorAbsen),
                    classId: currentUserData.classId, // Simpan classId
                    nama: currentUser.displayName,
                    userId: currentUser.uid,
                    email: currentUser.email,
                    timestamp: new Date()
                });
                alert('Absensi berhasil dicatat!');
                checkStudentAttendance();
            } catch (error) {
                alert('Gagal mencatat absensi.');
                attendanceBtnEl.disabled = false;
                attendanceBtnEl.textContent = "Kirim Absensi";
            }
        }
        
        // --- Load Konten (Siswa) ---
        function loadStudentContent(classId) {
            // Hentikan listener lama
            listeners.forEach(unsub => unsub());
            listeners = [];
            
            const announcementList = document.getElementById('announcement-list');
            const materialList = document.getElementById('material-list');
            const assignmentList = document.getElementById('assignment-list-student');

            // Load Announcements
            let annListener = db.collection('announcements')
                .where('classId', 'in', [classId, 'SEMUA KELAS'])
                .orderBy('createdAt', 'desc').limit(10)
                .onSnapshot(snapshot => {
                    if (snapshot.empty) { announcementList.innerHTML = '<p style="text-align:center;">Belum ada pengumuman.</p>'; return; }
                    let html = '';
                    snapshot.forEach(doc => {
                        const data = doc.data();
                        const date = formatReadableDate(data.createdAt.toDate());
                        html += `<div class="content-item"><strong>${data.title}</strong><p>${data.content}</p><small>${date}</small></div>`;
                    });
                    announcementList.innerHTML = html;
                }, error => { announcementList.innerHTML = '<p class="error">Gagal memuat pengumuman.</p>'; });

            // Load Materials
            let matListener = db.collection('materials')
                 .where('classId', 'in', [classId, 'SEMUA KELAS'])
                 .orderBy('createdAt', 'desc').limit(10)
                 .onSnapshot(snapshot => {
                    if (snapshot.empty) { materialList.innerHTML = '<p style="text-align:center;">Belum ada materi belajar.</p>'; return; }
                    let html = '';
                    snapshot.forEach(doc => {
                        const data = doc.data();
                         html += `<a href="${data.url}" target="_blank" rel="noopener noreferrer" style="text-decoration:none; color:inherit;">
                                <div class="content-item" style="display:flex; align-items:center; gap:12px;">
                                    <img src="${data.iconUrl || 'https://www.gstatic.com/images/branding/product/1x/google_drive_32dp.png'}" alt="file" style="width:24px; height:24px;">
                                    <span style="font-weight: 500;">${data.name}</span>
                                </div>
                            </a>`;
                    });
                    materialList.innerHTML = html;
                 }, error => { materialList.innerHTML = '<p class="error">Gagal memuat materi.</p>'; });

            // BARU: Load Assignments
            let assListener = db.collection('assignments')
                .where('classId', '==', classId)
                .orderBy('deadline', 'desc')
                .onSnapshot(snapshot => {
                    if (snapshot.empty) { assignmentList.innerHTML = '<p style="text-align:center;">Belum ada tugas.</p>'; return; }
                    let html = '';
                    snapshot.forEach(doc => {
                        const data = doc.data();
                        const deadline = formatReadableDate(data.deadline.toDate());
                        html += `<div class="content-item" style="cursor: pointer;" data-id="${doc.id}">
                                    <strong>${data.title}</strong>
                                    <small>Tenggat: ${deadline}</small>
                                </div>`;
                    });
                    assignmentList.innerHTML = html;
                    
                    // Tambahkan listener klik untuk submit
                    assignmentList.querySelectorAll('.content-item').forEach(item => {
                        item.addEventListener('click', () => {
                            showTaskSubmissionPage(item.dataset.id);
                        });
                    });
                    
                }, error => { assignmentList.innerHTML = '<p class="error">Gagal memuat tugas.</p>'; });
            
            listeners.push(annListener, matListener, assListener);
        }

        async function showTaskSubmissionPage(assignmentId) {
            const page = document.getElementById('student-dashboard-page');
            showSubPage(page, 'student-task-page');
            
            const titleEl = document.getElementById('task-detail-title');
            const descEl = document.getElementById('task-detail-desc');
            const deadlineEl = document.getElementById('task-detail-deadline');
            const linkInput = document.getElementById('task-link-input');
            const submitBtn = document.getElementById('submit-task-btn');
            const statusEl = document.getElementById('task-submission-status');

            // Reset
            titleEl.textContent = "Memuat...";
            descEl.textContent = "";
            deadlineEl.textContent = "";
            linkInput.disabled = true;
            submitBtn.disabled = true;
            statusEl.textContent = "";
            
            try {
                // 1. Ambil data tugas
                const taskDoc = await db.collection('assignments').doc(assignmentId).get();
                if (!taskDoc.exists) { throw new Error("Tugas tidak ditemukan."); }
                
                const taskData = taskDoc.data();
                titleEl.textContent = taskData.title;
                descEl.textContent = taskData.description;
                deadlineEl.textContent = `Tenggat: ${formatReadableDate(taskData.deadline.toDate())}`;
                
                // 2. Cek apakah siswa sudah submit
                const submissionDoc = await db.collection('assignments').doc(assignmentId)
                                            .collection('submissions').doc(currentUser.uid).get();
                
                if (submissionDoc.exists) {
                    // Sudah submit
                    statusEl.textContent = "Anda sudah mengumpulkan tugas ini.";
                    statusEl.style.color = "green";
                    linkInput.value = submissionDoc.data().link;
                    linkInput.disabled = true;
                    submitBtn.disabled = true;
                    submitBtn.textContent = "Sudah Terkumpul";
                } else {
                    // Belum submit
                    linkInput.disabled = false;
                    submitBtn.disabled = false;
                    submitBtn.textContent = "Kirim Tugas";
                    
                    // Setup listener tombol submit (harus di-reset)
                    submitBtn.onclick = () => submitTask(assignmentId);
                }
            } catch (error) {
                console.error("Error showing task page: ", error);
                titleEl.textContent = "Gagal memuat tugas.";
            }
        }
        
        async function submitTask(assignmentId) {
            const link = document.getElementById('task-link-input').value.trim();
            
            // Validasi link
            if (!link.startsWith('https://drive.google.com/')) {
                alert("Link tidak valid. Harap gunakan link Google Drive (dimulai dengan https://drive.google.com/...)");
                return;
            }
            
            const submitBtn = document.getElementById('submit-task-btn');
            submitBtn.disabled = true;
            submitBtn.textContent = "Mengirim...";
            
            try {
                await db.collection('assignments').doc(assignmentId)
                    .collection('submissions').doc(currentUser.uid)
                    .set({
                        link: link,
                        studentId: currentUser.uid,
                        studentName: currentUser.displayName,
                        classId: currentUserData.classId,
                        timestamp: firebase.firestore.FieldValue.serverTimestamp()
                    });
                
                alert("Tugas berhasil dikumpulkan!");
                showSubPage(document.getElementById('student-dashboard-page'), 'student-main-menu');
                
            } catch (error) {
                console.error("Error submitting task: ", error);
                alert("Gagal mengirim tugas. Coba lagi.");
                submitBtn.disabled = false;
                submitBtn.textContent = "Kirim Tugas";
            }
        }
        
        // =================================================================
        // == v5.0: LOGIKA CHAT SISWA
        // =================================================================

        function loadStudentChat() {
            // Fungsi ini dipanggil saat tombol "Buka Chat" diklik
            showSubPage(document.getElementById('student-dashboard-page'), 'student-chat-page');
            
            const classId = currentUserData.classId;
            const className = currentUserData.className;
            
            document.getElementById('student-chat-title').textContent = `Chat Kelas: ${className}`;
            const messagesArea = document.getElementById('chat-messages-student');
            messagesArea.innerHTML = '<div class="spinner-container"><div class="spinner"></div></div>';

            // Hentikan listener sebelumnya jika ada
            if (currentChatListener) {
                currentChatListener();
                currentChatListener = null;
            }

            // Ambil 50 pesan terakhir, urutkan ASC
            const chatQuery = db.collection('chats')
                                .where('classId', '==', classId)
                                .orderBy('timestamp')
                                .limitToLast(50);
            
            currentChatListener = chatQuery.onSnapshot(snapshot => {
                renderChatMessages(snapshot, messagesArea, currentUser.uid);
                scrollToChatBottom(messagesArea);
            }, error => {
                console.error("Error loading chat: ", error);
                messagesArea.innerHTML = '<p class="error">Gagal memuat chat.</p>';
            });
            
            // v5.0: Karena listener siswa ini 'persisten' saat di dalam halaman,
            // kita tidak menambahkannya ke array 'listeners' utama, 
            // karena sudah ditangani oleh navigasi showSubPage.
        }
        
        async function sendChatMessageStudent() {
            const text = document.getElementById('chat-input-student').value.trim();
            const classId = currentUserData.classId;
            
            if (!text || !classId) return; // Jangan kirim jika kosong

            document.getElementById('chat-input-student').value = '';
            
            try {
                await db.collection('chats').add({
                    classId: classId,
                    senderId: currentUser.uid,
                    senderName: currentUser.displayName, // Sesuai permintaan
                    text: text,
                    timestamp: firebase.firestore.FieldValue.serverTimestamp()
                });
            } catch (error) {
                console.error("Error sending message: ", error);
                alert("Gagal mengirim pesan.");
                document.getElementById('chat-input-student').value = text; // Kembalikan teks
            }
        }
        
        // =================================================================
        // == v5.0: FUNGSI RENDER CHAT BERSAMA
        // =================================================================
        
        function renderChatMessages(snapshot, messagesAreaElement, currentUserId) {
            if (snapshot.empty) {
                messagesAreaElement.innerHTML = '<p style="text-align: center; padding: 20px; color: #999;">Belum ada pesan di kelas ini.</p>';
                return;
            }
            
            let html = '';
            snapshot.forEach(doc => {
                const data = doc.data();
                if (!data.timestamp) return; // Lewati jika data belum lengkap
                
                const isSelf = data.senderId === currentUserId;
                const messageClass = isSelf ? 'self' : 'other';
                const senderName = isSelf ? 'Anda' : data.senderName;
                const time = formatChatTimestamp(data.timestamp.toDate());

                html += `
                    <div class="chat-message ${messageClass}">
                        <div class="sender">${senderName}</div>
                        <div class="bubble">${data.text}</div>
                        <div class="timestamp">${time}</div>
                    </div>
                `;
            });
            
            messagesAreaElement.innerHTML = html;
        }

    </script>

</body>
</html>